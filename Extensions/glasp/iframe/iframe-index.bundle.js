(()=>{"use strict";function e(e){const t=/>textNode:nth-of-type\(([0-9]+)\)$/i,i=t.exec(e);if(i){const n=parseInt(i[1]);e=e.replace(t,"");const o=$(e)[0];if(!o)return;return o.childNodes[n]}return $(e)[0]}function t(e){if("html"===e.localName)return"html";const i=e.parentNode;let n;const o=t(i);return e.localName?(n=$(e).index(o+">"+e.localName)+1,o+">"+e.localName+":nth-of-type("+n+")"):(n=Array.prototype.indexOf.call(i.childNodes,e),o+">textNode:nth-of-type("+n+")")}function i(e){let t,i;const n=window.location.protocol,o=window.location.hostname,r=window.location.pathname,a=window.location.search,l=s(window.location.href);if(t=o+r+a,i=n+"//"+t,"/pdf/web/viewer.html"==window.location.pathname&&window.location.search&&window.location.search.includes("?file=")){const e=new URL(window.location.search.replace("?file=",""));return t=e.hostname+e.pathname+e.search,i=e.protocol+"//"+t,{url:t,fullUrl:i}}return"www.youtube.com"===window.location.hostname&&l.v?(t=o+r+`?v=${l.v}`,i=n+"//"+t,{url:t,fullUrl:i}):{url:t,fullUrl:i}}function n(){let e="";if(r()&&document.getElementsByClassName("feed-shared-update-v2__description-wrapper").length>0){const t=document.getElementsByClassName("feed-shared-update-v2__description-wrapper")[0].innerText;if(t.length>0)return e=t.substring(0,65),e}if(a())return e=document.title,e;if(null!==document.querySelector("meta[property='og:title']"))"content"in document.querySelector("meta[property='og:title']")&&(e=document.querySelector("meta[property='og:title']").getAttribute("content"));else if(document.title)e=document.title;else if(document.getElementsByTagName("h1").length>0){const t=document.getElementsByTagName("h1");for(let i=0;i<t.length;i++)if(""!==t[i].innerText){e=t[i].innerText;break}}return e.trim(),e}function o(){return"file:"!==window.location.protocol&&"/pdf/web/viewer.html"==window.location.pathname&&window.location.href.toLowerCase().indexOf(".pdf")>0}function r(){const e=new URL(window.location.href);if("www.linkedin.com"==e.host&&e.pathname.split("/")[1]){const t=e.pathname.split("/")[1];if("posts"==t||"feed"==t)return!0}return!1}function a(){const e=s(window.location.href);return!("www.youtube.com"!==window.location.hostname||!e.v)}function l(){let e="https://storage.googleapis.com/glasp.co/src/img/thumbnail_wide.png",t=!1;const n=/^(https):\/\/[^ "]+$/gm,l=/^(http):\/\/[^ "]+$/gm,d=/((?:http|https|ftp|ftps|chrome|\*)?):\/\/([^\/]+)(\/.*)?/;if(r())return"https://storage.googleapis.com/glasp.co/src/img/linkedin_post.jpeg";if(a())return`https://i.ytimg.com/vi/${s(window.location.href).v}/hqdefault.jpg`;if(o())return"https://storage.googleapis.com/glasp.co/src/img/thumbnail_pdf.png";if(null!==document.querySelector("meta[property='og:image']")&&"content"in document.querySelector("meta[property='og:image']")){const o=document.querySelector("meta[property='og:image']").getAttribute("content"),r=document.querySelector("meta[property='og:image']").getAttribute("content"),a=n.test(o),s=l.test(o),c=i().fullUrl,g=window.location.hostname;a||s&&n.test(c)&&g==d.exec(r)[2]?(e=o,t=!0):s&&(e=o.replace("http","https"),t=!0)}if(!t&&document.body.getElementsByTagName("img")&&0!==document.body.getElementsByTagName("img").length){let i=document.body.getElementsByTagName("img");for(let o=0;o<i.length;o++)if(i[o].width>170&&i[o].height>80){const r=i[o].src;if(n.test(r)){e=r,t=!0;break}}}return e}function s(e){const t=e&&""!==e?e:window.location.search;if(!/\?([a-zA-Z0-9_]+)/i.exec(t))return{};let i,n=/\+/g,o=/([^?&=]+)=?([^&]*)/g,r=function(e){return decodeURIComponent(e.replace(n," "))},a=/\?([a-zA-Z0-9_]+)/i.exec(t).index+1,l=t.substring(a),s={};for(;i=o.exec(l);)s[r(i[1])]=r(i[2]);return s}function d(e,t,i,n){let o=document.getElementsByClassName("highlighter--highlighted"),r=new Map,a=[];for(let e=0;e<o.length;e++){let t=o[e].getAttribute("highlightid");r.has(t)?r.set(t,r.get(t).concat(o[e].textContent)):r.set(t,[o[e].textContent])}for(let[e,t]of r){let i=t.map((e=>e.replace(/\s+/gm," "))).join(" ");a.push(e),a.push(i)}return void 0===n||0===a.length&&0===n.length?null!=e&&((i=e.getElementById("highlights_list_empty")).style.visibility="visible",i.style.height="auto",t.style.visibility="hidden"):null!=e&&((i=e.getElementById("highlights_list_empty")).style.visibility="hidden",i.style.height="0px",t.style.visibility="visible"),a}const c=["chrome://extensions/","chrome://newtab/","*://driven-current-285910.firebaseapp.com/*","http://localhost:4000/home","http://localhost:4000/#/*","*://review.firstround.com/*","*://*.google.com/*","*://*.google.co.jp/*","*://*.typeform.com/*","*://feedly.com/*","*://getpocket.com/*","*://*.whatsapp.com/*","*://*.notion.so/*","*://*.slack.com/*","*://*.office.com/*","*://*.live.com/*","*://*.yahoo.com/*","*://*.firebase.google.com/*","*://glasp.co/#/*","*://glasp.co/home","*://www.glasp.co/home","*://www.facebook.com/*","*://www.instagram.com/*","*://twitter.com/home","*://twitter.com/intent/*","*://twitter.com/messages/*","*://twitter.com/settings","*://*.linkedin.com/feed/","*://*.linkedin.com/mynetwork/","*://*.linkedin.com/jobs/","*://*.linkedin.com/notifications/","*://*.linkedin.com/messaging/*","*://*.linkedin.com/in/*","*://analytics.amplitude.com/*","*://*.atlassian.*/*","*://online.citi.com/*","*://www.chase.com/*","*://www.bankofamerica.com/*","*://*.paypal.com/*","*://*.intuit.com/*","*://*.docusign.com/*","*://connect.secure.wellsfargo.com/*","*://www.pornhub.com/*","*://xhamster.com/*","*://www.redtube.com/*","*://www.youporn.com/*","*://beeg.com/*","*://smutr.com/*","*://pornone.com/*","*://www.tube8.com/*","*://www.xvideos.com/*","*://www.xnxx.com/*","*://www.creditkarma.com/*","*://sso2.opower.com/*"];function g(){$(".highlighter--hovered").removeClass("highlighter--hovered"),m.clickedHighlightId="",m.tooltipEl&&(m.tooltipEl.hide(),m.tooltip_iframe_doc&&m.tooltip_iframe_doc.getElementById("tooltip_copy_highlight_text")&&($(document.getElementById("glasp-tooltip-iframe")).attr("style","max-width: 240px !important; height: 48px !important;position:relative;"),m.tooltip_iframe_doc.getElementById("tooltip_copy_highlight_text").style.display="none",m.tooltip_iframe_doc.getElementById("tooltip_add_tag").style.display="none")),m.tripleClicked=!1,m.hoverToolTimeout=null,m.highlightClicked=!1,m.tooltipDisplayed=!1,null!==m.tooltip_iframe&&void 0!==m.tooltip_iframe&&(m.tooltip_iframe.style.display="none")}function h(e){return e.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,(e=>`<a href="${e}" target="_blank" style="color: rgb(42, 128, 255);line-break: anywhere;cursor: pointer !important;">${e}</a>`))}let p,m=new class{iframeIndexEl=function(){let e=document.createElement("div");return e.setAttribute("class","glasp-ui-wrapper"),e.setAttribute("id","glasp-ui-wrapper"),e.style.height="0px",e.style.width="0px",e}();sidebar_iframe=function(){let e=document.createElement("iframe");return e.name="glasp-sidebar-iframe",e.setAttribute("id","glasp-sidebar-iframe"),e.frameBorder=0,$(e).attr("style",'width: 0px !important; min-width: 0px !important; max-width: 300px; height: 100%; background: #FFFFFF; resize: horizontal; direction: rtl; margin: auto; position: fixed; top: 0px; right: 0px; left: auto; z-index: 9000000000000000000;background-image: url("https://storage.googleapis.com/glasp.co/src/img/loading_200.gif");background-repeat: no-repeat;background-position: center;background-size: 40px;'),e}();tooltip_iframe=function(){let e=document.createElement("iframe");return e.name="glasp-tooltip-iframe",e.setAttribute("id","glasp-tooltip-iframe"),e.frameBorder=0,e.scrolling="no",$(e).attr("style","width: 0px !important; height: 48px; filter: drop-shadow(rgba(0, 0, 0, 0.3) 0px 2px 5px);position:relative;"),e}();excludedURL=function(e){const t=/((?:http|https|ftp|ftps|chrome|\*)?):\/\/([^\/]+)(\/.*)?/;for(let i=0;i<c.length;i++){let n,o="";if(null!==(n=c[i].match(t))&&(o=n[1].replace(/\*$/,"[^/]*")+"://"+n[2].replace(/[?()[\]\\.+^$|]/g,"\\$&").replace(/\*\\./g,"(?:[^/]*\\.)*").replace(/\*$/,"[^/]*"),n[3]&&(o+=n[3].replace(/[?()[\]\\.+^$|]/g,"\\$&").replace(/\/\*(?=$|\/)/g,"(?:/[^]*)?"))),o){let t=RegExp("^"+o+"$","i");if(e.match(t))return!0}}return!1}(window.location.href);domainExcludeList=[];sidebar_signup_login_HTML;sidebarLoginBtnEl;sidebarToSBtnEl;sidebarPPBtnEl;sidebarSettingBtnEl;sidebarSettingPopupEl;currentUserListEl;usersListEl;userListEl;userListData;userListDataLength;userListNum;selectedUsersUID;selectedUsersInfo;selectedUsersDisplayName;selectedUsersPhotoURL;selectedUserUsername;userPhotoEl;userNameEl;pulldownImg;alreadyDisplayedOtherUsersList;tooltipHTML;tooltipEl;hoverToolTimeout;currentHighlightEl;currentHighlightColor;clickedHighlightEl;clickedHighlightId;tripleClicked;addedHighlightId;actionType;deletedHighlightTabindex;sidebarHTML;highlightsListEl;sidebarHighlighterToggleEl;twitterShareBtnEl;fbShareBtnEl;linkedInShareBtnEl;emailShareBtnEl;userTags=[];sidebarIsOpen=!1;visibilityStatus="Public";sidebarWidth="300px";viewingOthersHLs=!1;visibilityChanged=!1;highlighterMode="on";lastSelectedColorId="#FFB6C6";addNoteBtnClicked=!1;tooltipDisplayed=!1;prevSelectedText="";textSelected=!1;highlightClicked=!1;userInfoReceived=!1;otherUsersPagenote;otherUsersTagList=[];displayName;photoURL;uid;username;userPagenote="";userTagList=[];docId;tooltip_iframe_doc;sidebar_element;sidebar_iframe_doc;sidebar_copy_all;highlightEmptyEl;loadedHighlights;constructor(){p=this}getInstance(){return this}};function _(){return"undefined"!=typeof chrome&&void 0!==chrome.app&&void 0!==chrome.app.isInstalled||!(!navigator.vendor||-1===navigator.vendor.indexOf("Apple"))}function u(e){return 1===e.lastChild.nodeType?u(e.lastChild):3===e.lastChild.nodeType?e.lastChild:null}function f(e){const t=e.previousElementSibling;let i=null;if(0===t.innerText.length)i=f(t);else{const e=t.lastChild;null!==e&&1===e.nodeType?i=[e,e.innerText.length]:null!==e&&3===e.nodeType&&(i=[e,e.length])}return i}function y(e,t){const i=t.querySelector(`[highlightid="${e}"]`);i&&(i.scrollIntoView({behavior:"smooth",block:"center"}),i.style.backgroundColor="#EEEEEE",setTimeout((function(){i.style.backgroundColor="#FAFAFA"}),500));const n=i.getAttribute("tabindex");return t.getElementsByClassName("highlight_note_add_btn")[n]}function b(){document.getElementById("glasp-sidebar-iframe").contentWindow.scrollTo(0,m.sidebar_iframe_doc.querySelector(".highlights_list").scrollHeight)}function w(e){let t=null;try{t=(e.contentDocument||e.contentWindow.document).body.innerHTML}catch(e){}return null!==t}function v(e){let t=!1;e.anchorNode.compareDocumentPosition(e.focusNode)===Node.DOCUMENT_POSITION_PRECEDING&&(t=!0);const i=t?e.focusNode:e.anchorNode,n=t?e.focusOffset:e.anchorOffset,o=t?e.anchorNode:e.focusNode,r=t?e.anchorOffset:e.focusOffset;let a,l;if(o.nodeType==Node.ELEMENT_NODE)if(null==o.previousElementSibling&&null==o.previousSibling)i!==o.parentNode?(a=u(o.parentNode.previousElementSibling),a.nodeType==Node.ELEMENT_NODE?l=a.innerText.length:a.nodeType==Node.TEXT_NODE&&(l=a.length)):(a=i,a.nodeType==Node.ELEMENT_NODE?l=a.innerText.length:a.nodeType==Node.TEXT_NODE&&(l=a.length));else if(null==o.previousElementSibling)a=u(o.parentNode.parentElement),a.nodeType==Node.ELEMENT_NODE?l=a.innerText.length:a.nodeType==Node.TEXT_NODE&&(l=a.length);else{const e=f(o);a=e[0],l=e[1]}else o.nodeType==Node.TEXT_NODE&&(a=o,l=r);return{anchorNode:i,anchorOffset:n,focusNode:a,focusOffset:l}}function E(){return!_()}function x(e,t,i){if(document.getElementById("glasp-sidebar-iframe")){m.sidebar_iframe_doc=document.getElementById("glasp-sidebar-iframe").contentWindow.document;const n=/\s+/g.test(t)?t.split(/\s/)[0]:t;m.sidebar_iframe_doc.getElementById("current_user_list")&&(m.currentUserListEl=m.sidebar_iframe_doc.getElementById("current_user_list"),m.currentUserListEl.innerHTML=`\n            <img class="user-photo" id="user-photo" style="height:24px;width:24px;border-radius: 14px;border: 0.1px solid rgba(0,0,0,0.1);" src="${e}">\n            <div class="user-name" id="user-name" style="text-align: left;width: max-content;margin-left: 8px;font-size: 16px;">${n}</div>\n            <svg class="user-pulldown" id="user-pulldown" style="height: 20px;width: 20px;margin-left: 3px;margin-right: 3px;" width="20" height="20" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">\n                <path d="M16.2447 9.9588C16.5376 9.6659 16.5376 9.19103 16.2447 8.89814C15.9518 8.60524 15.4769 8.60524 15.184 8.89814L16.2447 9.9588ZM6.81611 8.89814C6.52322 8.60524 6.04835 8.60524 5.75545 8.89814C5.46256 9.19103 5.46256 9.6659 5.75545 9.9588L6.81611 8.89814ZM11.7425 14.461L16.2447 9.9588L15.184 8.89814L10.6819 13.4003L11.7425 14.461ZM11.3183 13.4003L6.81611 8.89814L5.75545 9.9588L10.2576 14.461L11.3183 13.4003ZM10.6819 13.4003C10.8576 13.2246 11.1425 13.2246 11.3183 13.4003L10.2576 14.461C10.6677 14.871 11.3325 14.871 11.7425 14.461L10.6819 13.4003Z" fill="#8B8B8B"/>\n            </svg>`,m.userPhotoEl=m.sidebar_iframe_doc.getElementById("user-photo"),m.userNameEl=m.sidebar_iframe_doc.getElementById("user-name"),m.pulldownImg=m.sidebar_iframe_doc.getElementById("user-pulldown"),m.viewingOthersHLs||(m.sidebar_iframe_doc.getElementById("user-photo-right-top").src=e,m.sidebar_iframe_doc.getElementById("user-photo-right-top-link").href=`https://glasp.co/#/${i}`))}}function k(e,t){if(m.visibilityChanged&&(m.alreadyDisplayedOtherUsersList=!1,m.visibilityChanged=!1),m.alreadyDisplayedOtherUsersList)return;m.alreadyDisplayedOtherUsersList=!0;let n=t;m.userListNum.innerHTML=n;let o=document.createElement("img");o.setAttribute("class","user-photo"),o.setAttribute("src",m.photoURL);let r=document.createElement("div");r.setAttribute("class","user-name"),r.innerHTML=m.displayName,m.userListEl.appendChild(o),m.userListEl.appendChild(r);const a=i().url;m.userListEl&&m.userListEl.addEventListener("click",(function(){const e={uid:m.uid,displayName:m.displayName,photoURL:m.photoURL};ve(),m.sidebarHighlighterToggleEl.is(":checked")||(m.sidebarHighlighterToggleEl.prop("checked",!0),m.highlighterMode="on",chrome.runtime.sendMessage({action:"browser_icon_change",data:m.highlighterMode})),m.sidebarHighlighterToggleEl.off("click"),chrome.runtime.sendMessage({action:"viewing_others_highlights",data:!1}),chrome.runtime.sendMessage({action:"load_others_highlight",data:[e,a]}),m.usersListEl.style.visibility="hidden"}));for(let i=0;i<t;i++){if(e[i].uid===m.uid)continue;let t=document.createElement("div");t.setAttribute("class","user_list");let n=document.createElement("img");n.setAttribute("class","user-photo"),n.setAttribute("src",e[i].photoURL);let o=document.createElement("div");o.setAttribute("class","user-name"),o.innerHTML=e[i].displayName,t.appendChild(n),t.appendChild(o),t.addEventListener("click",(function(){ve(),m.sidebarHighlighterToggleEl.is(":checked")&&(m.sidebarHighlighterToggleEl.prop("checked",!1),m.highlighterMode="off",chrome.runtime.sendMessage({action:"browser_icon_change",data:m.highlighterMode})),m.sidebarHighlighterToggleEl.on("click",!1),chrome.runtime.sendMessage({action:"viewing_others_highlights",data:!0}),chrome.runtime.sendMessage({action:"load_others_highlight",data:[e[i],a]}),m.usersListEl.style.visibility="hidden"})),null!==m.usersListEl&&m.usersListEl.appendChild(t)}}function L(e,t,i){if(null==m.uid||null==m.uid)return;if(m.selectedUsersUID!==m.uid)return;if("off"==m.highlighterMode)return;if("file:"==window.location.protocol||"localhost"==window.location.hostname)return;if("/pdf/web/viewer.html"==window.location.pathname&&window.location.search&&window.location.search.includes("?file=")){const e=new URL(window.location.search.replace("?file=",""));if("file:"==e.protocol||"localhost"==e.hostname)return}const n=e.getBoundingClientRect(),o=m.highlightClicked?272:208,r=(n.top-54).toString()+"px";if(m.tooltip_iframe.style.top=r,void 0!==t){let e=null;e=n.width<o?n.left+n.width/2-o/2:t-n.left<o/2?n.left:n.right-t<o/2?n.right-o:t-o/2;let i=e.toString()+"px";m.tooltip_iframe.style.left=i}m.tooltip_iframe.style.display="inline",m.tooltipDisplayed=!0;const a=m.tooltip_iframe_doc.getElementById("glasp_tooltip_container"),l=a.querySelector(".highlighter-pink"),s=a.querySelector(".highlighter-yellow"),d=a.querySelector(".highlighter-green"),c=a.querySelector(".highlighter-blue");l.removeEventListener("click",B),l.removeEventListener("click",T),s.removeEventListener("click",B),s.removeEventListener("click",T),d.removeEventListener("click",B),d.removeEventListener("click",T),c.removeEventListener("click",B),c.removeEventListener("click",T);const g=a.querySelector("#FFB6C6"),h=a.querySelector("#F9F47F"),p=a.querySelector("#A2F8A0"),_=a.querySelector("#ADC9FF");switch(g.style.display="none",h.style.display="none",p.style.display="none",_.style.display="none",l.addEventListener("click",B),s.addEventListener("click",B),d.addEventListener("click",B),c.addEventListener("click",B),i){case"rgb(255, 182, 198)":g.style.display="block",l.removeEventListener("click",B),l.removeEventListener("click",T),l.addEventListener("click",T);break;case"rgb(249, 244, 127)":h.style.display="block",s.removeEventListener("click",B),s.removeEventListener("click",T),s.addEventListener("click",T);break;case"rgb(162, 248, 160)":p.style.display="block",d.removeEventListener("click",B),d.removeEventListener("click",T),d.addEventListener("click",T);break;case"rgb(173, 201, 255)":_.style.display="block",c.removeEventListener("click",B),c.removeEventListener("click",T),c.addEventListener("click",T)}m.tooltipEl.show()}function B(e){if(E())return void window.location.reload();const t=e.target.getAttribute("colorid");m.lastSelectedColorId=t,m.highlightClicked?function(e,t){if(E())return void window.location.reload();const n=i(),o=n.url,r=n.fullUrl;let a=document.getElementsByClassName("highlighter--highlighted");for(let i=0;i<a.length;i++)a[i].getAttribute("highlightid")==e&&(a[i].style["background-color"]=t);chrome.runtime.sendMessage({action:"highlight_change_color",data:[o,e,t,r]}),g()}(m.clickedHighlightId,t):we(window.getSelection(),t,m.tripleClicked)}function T(e){if(E())return void window.location.reload();const t="string"==typeof e?e:m.clickedHighlightId,n=document.querySelectorAll(`[highlightid^="${t}"]`);m.sidebar_iframe_doc.querySelector(`[highlightid="${t}"]`)&&(m.deletedHighlightTabindex=m.sidebar_iframe_doc.querySelector(`[highlightid="${t}"]`).getAttribute("tabindex"));const o=i(),r=o.url,a=o.fullUrl;for(let e=0;e<n.length;e++)n[e].outerHTML=n[e].innerHTML;m.tooltipEl&&m.tooltipEl.hide(),m.hoverToolTimeout=null;const l=d(m.sidebar_iframe_doc,m.sidebar_copy_all,m.highlightEmptyEl,m.loadedHighlights);chrome.runtime.sendMessage({action:"highlight_delete",data:[r,t,a,l]}),g()}function I(){if("visible"==m.usersListEl.style.visibility)m.usersListEl.style.visibility="hidden";else if(m.usersListEl.style.visibility="visible",null==m.userListData||null==m.userListData||1==m.visibilityChanged){if(_()){const e=i().url;chrome.runtime.sendMessage({action:"user_list_load",data:e})}}else k(m.userListData,m.userListDataLength)}function C(){m.sidebarSettingPopupEl.style.visibility="visible"==m.sidebarSettingPopupEl.style.visibility?"hidden":"visible",chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_setting_popup"})}function M(){chrome.runtime.sendMessage({action:"user_signout"}),window.location.replace(window.location.href)}function N(){chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_setting_bug_report"}),window.open("https://form.typeform.com/to/QFHPTG60")}function A(e){const t=e.target.getAttribute("highlightid");m.highlightClicked||($(".highlighter--hovered").removeClass("highlighter--hovered"),$(`.highlighter--highlighted[highlightid='${t}']`).addClass("highlighter--hovered"))}function H(e){m.highlightClicked||$(".highlighter--hovered").removeClass("highlighter--hovered")}function S(e){if(m.sidebarIsOpen){const t=e.target.getAttribute("highlightid"),i=m.sidebar_iframe_doc.querySelector(`[highlightid="${t}"]`);i&&(i.scrollIntoView({behavior:"smooth",block:"center"}),i.style.backgroundColor="#EEEEEE",setTimeout((function(){i.style.backgroundColor="#FAFAFA"}),500))}if("off"==m.highlighterMode)return;const t=e.target,i=t.getAttribute("highlightid"),n=t.style.backgroundColor;m.clickedHighlightEl=e.target,m.clickedHighlightId=t.getAttribute("highlightid"),m.highlightClicked&&"click"!==e.type||(m.highlightClicked="click"===e.type,m.currentHighlightEl=t,m.currentHighlightColor=n,null!==m.hoverToolTimeout&&(clearTimeout(m.hoverToolTimeout),m.hoverToolTimeout=null,i==m.currentHighlightEl.getAttribute("highlightid"))||($(document.getElementById("glasp-tooltip-iframe")).attr("style","max-width: 272px !important; height: 48px !important;position:relative;"),m.tooltip_iframe_doc.getElementById("tooltip_copy_highlight_text").style.display="inline",m.tooltip_iframe_doc.getElementById("tooltip_add_tag").style.display="inline",L(t,e.clientX,n),_()&&(chrome.runtime.sendMessage({action:"amplitude_log",evtName:"highlight_sentence_click"}),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"tooltip_popup"}))))}function F(){return-1!==navigator.userAgent.indexOf("Safari")&&-1===navigator.userAgent.indexOf("Chrome")&&-1===navigator.userAgent.indexOf("Chromium")}function U(e){navigator.clipboard?F()?function(e){const t="text/plain",i=new Blob([e],{type:t}),n=[new ClipboardItem({[t]:i})];navigator.clipboard.write(n).then((()=>{}),(e=>{console.log(`copy failed: ${e}`)}))}(e):navigator.clipboard.writeText(e).then((function(){}),(function(e){})):function(e){var t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy")}catch(e){}document.body.removeChild(t)}(e)}function D(){let e="";const t=n(),o=l(),r=["https://storage.googleapis.com/glasp.co/src/img/thumbnail_wide.png","https://storage.googleapis.com/glasp.co/src/img/thumbnail_pdf.png"].includes(o)?"":o,a=i().fullUrl,s=m.userTagList?m.userTagList.map((e=>"#"+e.replace(/\s+/g,"-"))).join(", "):"",d=m.userPagenote?m.userPagenote:"";e+=`# ${t}\n\n`,e+=""==r?"":`![](${r})\n\n`,e+="### Metadata\n\n",e+=`- Title: ${t}\n`,e+=""!==s?`- Tags: ${s}\n`:"",e+=`- URL: ${a}\n`,!d||(e+=`### Page Comment\n\n- ${d}\n\n`),e+="### Highlights & Notes\n\n";for(let t=0;t<m.loadedHighlights.length;t++){const i=m.loadedHighlights[t],n=i.string,o=i.note?i.note:"";e+=`- ${n.replace(/\n/g," ")}\n`,e+=""!==o?`  - Notes: ${o}\n`:""}e+="\n\n",U(e)}function R(e,t){const n=i().fullUrl;let o="";const r=t.split(" "),a=r.length;if(a>=7){const e=r[0].length+r[1].length+r[2].length+r[3].length+3,i=t.length-r[a-3].length-r[a-2].length-r[a-1].length-3,l=t.substring(0,e),s=t.substring(i);o=n+"#:~:text="+encodeURIComponent(l)+","+encodeURIComponent(s)}else o=n+"#:~:text="+encodeURIComponent(t);return o}function q(){let e,t=!1,o={};const r=s(window.location.href);document.querySelector("#glasp_yt_transcript_selection")&&(document.querySelector("#glasp_yt_transcript_selection").innerHTML=""),document.querySelector("#glasp_yt_transcript_text")&&(document.querySelector("#glasp_yt_transcript_text").innerHTML=""),Array.from(document.getElementsByClassName("glasp_yt_transcript_container")).forEach((e=>{e.remove()})),r.v&&Z("#secondary.style-scope.ytd-watch-flexy").then((()=>{Array.from(document.getElementsByClassName("glasp_yt_transcript_container")).forEach((e=>{e.remove()})),document.querySelector("#secondary.style-scope.ytd-watch-flexy").insertAdjacentHTML("afterbegin",'\n        <div class="glasp_yt_transcript_container">\n            <div id="glasp_yt_transcript_header" class="glasp_yt_transcript_header">\n                <a href="https://glasp.co/dashboard" target="_blank" id="glasp_yt_transcript_header_logo">\n                    <svg width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M1.40123 27.3686C-0.44103 25.5284 -0.441033 22.5449 1.4012 20.7047L16.5971 5.52573L24.0098 12.9301L5.47818 31.4409L1.40123 27.3686Z" fill="#FF4E74"/>\n                        <path d="M35.1286 24.0367L16.5972 5.5258L20.6741 1.45341C22.5164 -0.386772 25.5033 -0.386775 27.3455 1.45341L42.5415 16.6323L35.1286 24.0367Z" fill="#FFF85E"/>\n                        <path d="M24.0099 35.143L42.5416 16.6323L46.6183 20.7046C48.4606 22.5448 48.4606 25.5284 46.6183 27.3686L31.4224 42.5476L24.0099 35.143Z" fill="#76FF54"/>\n                        <path d="M27.3454 46.6198C25.5032 48.4601 22.5163 48.4601 20.674 46.6198L5.47815 31.4409L12.8908 24.0366L31.4223 42.5476L27.3454 46.6198Z" fill="#5C94FF"/>\n                    </svg>\n                </a>\n                <p class="glasp_yt_transcript_header_text">Highlight on Video</p>\n                <div class="glasp_yt_transcript_header_actions">\n                    <svg id="glasp_yt_transcript_header_copy" class="glasp_yt_transcript_header_action_btn" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M7 6.6V5C7 4.44772 7.44772 4 8 4H18C18.5523 4 19 4.44772 19 5V16C19 16.5523 18.5523 17 18 17H16.2308" stroke="#828282" stroke-width="1.5"/>\n                        <rect x="4.75" y="6.75" width="11.5" height="13.5" rx="1.25" stroke="#828282" stroke-width="1.5"/>\n                    </svg>\n                    <svg id="glasp_yt_transcript_header_toggle" class="glasp_yt_transcript_header_action_btn" width="24" height="24" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M16.2447 9.9588C16.5376 9.6659 16.5376 9.19103 16.2447 8.89814C15.9518 8.60524 15.4769 8.60524 15.184 8.89814L16.2447 9.9588ZM6.81611 8.89814C6.52322 8.60524 6.04835 8.60524 5.75545 8.89814C5.46256 9.19103 5.46256 9.6659 5.75545 9.9588L6.81611 8.89814ZM11.7425 14.461L16.2447 9.9588L15.184 8.89814L10.6819 13.4003L11.7425 14.461ZM11.3183 13.4003L6.81611 8.89814L5.75545 9.9588L10.2576 14.461L11.3183 13.4003ZM10.6819 13.4003C10.8576 13.2246 11.1425 13.2246 11.3183 13.4003L10.2576 14.461C10.6677 14.871 11.3325 14.871 11.7425 14.461L10.6819 13.4003Z" fill="#8B8B8B"/>\n                    </svg>\n                </div>\n            </div>\n            <div id="glasp_yt_transcript_body" class="glasp_yt_transcript_body">\n                <div id="glasp_yt_transcript_selection" class="glasp_yt_transcript_selection">\n\n                </div>\n                <div id="glasp_yt_transcript_text" class="glasp_yt_transcript_text"></div>\n            </div>\n        </div>'),document.querySelector("#glasp_yt_transcript_header_logo").addEventListener("click",(e=>{e.stopPropagation(),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"extension_yt_transcript_header_logo_click"})})),document.querySelector("#glasp_yt_transcript_header_copy").addEventListener("click",(e=>{e.stopPropagation(),function(){let e="";const t=n(),o=i().fullUrl,r=new URL(o).origin,a=m.userTagList?m.userTagList.map((e=>"#"+e.replace(/\s+/g,"-"))).join(", "):"",l=m.userPagenote?m.userPagenote:"";if(e+=`# ${t}\n\n`,e+=`![](${o})\n`,e+="\n### Metadata\n\n",e+=`- Title: ${t}\n`,e+=`- URL: ${o}\n`,e+=""!==a?`- Tags: ${a}\n`:"",l&&(e+=`\n### Page Comment\n\n- ${l}\n`),void 0!==m.loadedHighlights&&m.loadedHighlights.length&&m.loadedHighlights.length>0){e+="\n### Highlights & Notes\n\n";for(let t=0;t<m.loadedHighlights.length;t++){const i=m.loadedHighlights[t],n=i.string,o=i.note?i.note:"";e+=`- ${n.replace(/\n/g," ")}\n`,e+=""!==o?`  - Notes: ${o}\n`:""}}e+="\n### Transcript\n\n",Array.from(document.getElementById("glasp_yt_transcript_text").children).forEach((t=>{if(!t)return;if(t.children.length<2)return;const i=t.children[0].innerText,n=t.children[0].getAttribute("data-glasp-href"),o=t.children[1].innerText;e+=`- [${i}](${r+n}) -- ${o}\n`})),e+="\n\n",U(e),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"extension_yt_transcript_copy_content"})}()})),document.querySelector("#glasp_yt_transcript_header").addEventListener("click",(i=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"extension_yt_transcript_btn_click"}),document.querySelector("#glasp_yt_transcript_body").classList.toggle("glasp_yt_transcript_body_show"),document.querySelector("#glasp_yt_transcript_header_toggle").classList.toggle("glasp_yt_transcript_header_toggle_rotate"),document.querySelector("#glasp_yt_transcript_header_copy").classList.toggle("glasp_yt_transcript_header_copy_show"),t=!!document.querySelector("#glasp_yt_transcript_body").classList.contains("glasp_yt_transcript_body_show"),document.querySelector("#glasp_yt_transcript_selection").innerHTML="",document.querySelector("#glasp_yt_transcript_text").innerHTML="",function(){const e=[];return Array.from(document.querySelectorAll("yt-icon-button#button.dropdown-trigger.style-scope.ytd-menu-renderer")).forEach(((t,i,n)=>{t.innerHTML.includes('<svg viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" focusable="false" class="style-scope yt-icon" style="pointer-events: none; display: block; width: 100%; height: 100%;"><g class="style-scope yt-icon"><path d="M7.5,12c0,0.83-0.67,1.5-1.5,1.5S4.5,12.83,4.5,12s0.67-1.5,1.5-1.5S7.5,11.17,7.5,12z M12,10.5c-0.83,0-1.5,0.67-1.5,1.5 s0.67,1.5,1.5,1.5s1.5-0.67,1.5-1.5S12.83,10.5,12,10.5z M18,10.5c-0.83,0-1.5,0.67-1.5,1.5s0.67,1.5,1.5,1.5s1.5-0.67,1.5-1.5 S18.83,10.5,18,10.5z" class="style-scope yt-icon"></path></g></svg>')&&e.push(i)})),document.querySelectorAll("yt-icon-button#button.dropdown-trigger.style-scope.ytd-menu-renderer")[e[e.length-1]]}().click(),document.querySelector("#glasp_yt_transcript_body").style.maxHeight=window.innerHeight-160+"px",document.querySelector("#glasp_yt_transcript_text").innerHTML='<img style="display: block;width: 48px;margin: 40px auto;" src="https://storage.googleapis.com/glasp.co/src/img/loading_200.gif">',clearTimeout(e),e=setTimeout((()=>{document.querySelector("#glasp_yt_transcript_text").innerHTML='<div style="margin: 40px auto;text-align: center;">Couldn\'t get transcripts... 😢</div>'}),3500),t||clearTimeout(e),Z("#contentWrapper > ytd-menu-popup-renderer > tp-yt-paper-listbox > ytd-menu-service-item-renderer").then((()=>{const i=document.querySelector("#contentWrapper > ytd-menu-popup-renderer > tp-yt-paper-listbox").children,n=function(e){return 1==e.length||document.querySelector(`#items > ytd-menu-service-item-renderer:nth-child(${e.length})`).textContent.includes("Report")?(document.querySelector(".dropdown-trigger .style-scope .ytd-menu-renderer").click(),document.querySelector("#button-shape > button").click(),!1):!document.querySelector(`#items > ytd-menu-service-item-renderer:nth-child(${e.length})`).innerHTML.includes('<path d="M13.18,4l0.24,1.2L13.58,6h0.82H19v7h-5.18l-0.24-1.2L13.42,11H12.6H6V4H13.18 M14,3H5v18h1v-9h6.6l0.4,2h7V5h-5.6L14,3 L14,3z" class="style-scope yt-icon"></path>')||(document.querySelector(".dropdown-trigger .style-scope .ytd-menu-renderer").click(),document.querySelector("#button-shape > button").click(),!1)}(i);n&&(document.querySelector(`#items > ytd-menu-service-item-renderer:nth-child(${i.length})`).click(),Z("#segments-container.style-scope.ytd-transcript-segment-list-renderer").then((async()=>{if(!t){const t=document.querySelectorAll("#visibility-button > ytd-button-renderer > a"),i=document.querySelectorAll("#visibility-button > ytd-button-renderer > yt-button-shape > button");return t.length>0&&t[t.length-1].click(),i.length>0&&i[i.length-1].click(),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"extension_yt_transcript_container_close"}),void clearTimeout(e)}setTimeout((async()=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"extension_yt_transcript_container_open"}),document.querySelector("#glasp_yt_transcript_text").innerHTML="",document.querySelector("#glasp_yt_transcript_text").innerHTML=P(j()),Ee(),O(),clearTimeout(e);const t=z();""!=t?(document.querySelector("#glasp_yt_transcript_selection").innerHTML="",document.querySelector("#glasp_yt_transcript_selection").innerHTML=`<button class="glasp_yt_transcript_language glasp_yt_transcript_language_selected" data-glasp-yt-lang="${t}">${t}</button>`,o=0!==Object.keys(o).length?o:await async function(){const e={},t=document.querySelectorAll("tp-yt-paper-button#label.dropdown-trigger.style-scope.yt-dropdown-menu"),i=t[t.length-1];return i.click(),await Z(`tp-yt-paper-button#label.dropdown-trigger.style-scope.yt-dropdown-menu:nth-child(${t.length-1})`).then((()=>{const n=document.querySelectorAll("#dropdown.style-scope.tp-yt-paper-menu-button")[t.length-1].querySelectorAll("#menu > a.yt-simple-endpoint.style-scope.yt-dropdown-menu");return Array.from(n).forEach((t=>{const i=t.innerText.replace(/\n+/g,"").trim();e[i]=t})),i.click(),e}))}(),document.querySelector("#glasp_yt_transcript_selection").insertAdjacentHTML("beforeend",Array.from(Object.keys(o)).map((e=>e==t?"":`<button class="glasp_yt_transcript_language" data-glasp-yt-lang="${e}">${e}</button>`)).join("")),function(e){Array.from(document.getElementsByClassName("glasp_yt_transcript_language")).forEach((t=>{t.addEventListener("click",(async()=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"extension_yt_select_lang_click"});const i=t.getAttribute("data-glasp-yt-lang");Array.from(document.getElementsByClassName("glasp_yt_transcript_language")).forEach((e=>{e.classList.remove("glasp_yt_transcript_language_selected")})),t.classList.add("glasp_yt_transcript_language_selected"),e[i].click(),document.querySelector("#glasp_yt_transcript_body").style.height=window.innerHeight-160+"px",document.querySelector("#glasp_yt_transcript_text").innerHTML='<img style="display: block;width: 48px;margin: 40px auto;" src="https://storage.googleapis.com/glasp.co/src/img/loading_200.gif">',setTimeout((()=>{document.querySelector("#glasp_yt_transcript_text").innerHTML="",document.querySelector("#glasp_yt_transcript_text").innerHTML=P(j()),Ee(),O()}),1e3)}))}))}(o)):o={}}),600)})))}))}))}))}function O(){Array.from(document.getElementsByClassName("glasp_yt_transcript_text_timestamp")).forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation();const i=e.getAttribute("data-start-time"),n=document.querySelector("#movie_player > div.html5-video-container > video");n.currentTime=i,n.play(),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"extension_yt_timestamp_click"})}))}))}function z(){let e="";const t=document.querySelectorAll("tp-yt-paper-button#label.dropdown-trigger.style-scope.yt-dropdown-menu");return t.length>0&&(e=t[t.length-1].innerText.replace(/\n+/g,"").trim()),e}function j(){const e=[];return Array.from(document.querySelector("#segments-container.style-scope.ytd-transcript-segment-list-renderer").children).forEach(((t,i,n)=>{const o=t.querySelectorAll("yt-formatted-string")[0].textContent,r=t.querySelectorAll("div.segment-timestamp.style-scope.ytd-transcript-segment-renderer")[0].innerText,a=V(r);e.push({text:o,start:r,starttime:a})})),e}function P(e){const t=s(window.location.href),i=[];let n=0,o=[],r=0,a=0,l={},d={};return Array.from(e).forEach(((e,t,s)=>{d.start&&d.text&&(l.start=d.start,o.push(d.text),d={}),0==n&&(l.start=d.start?d.start:e.start),n++;const g=V(l.start),h=V(e.start);if(a=h-g,r+=e.text.length,o.push(e.text),t==s.length-1)return l.text=o.join(" ").replace(/\n/g," "),i.push(l),void c();if(a>60)return l.text=o.join(" ").replace(/\n/g," "),i.push(l),void c();if(r>300){if(r<500){if(e.text.includes(".")){const t=e.text.split(".");if(""==t[t.length-1].replace(/\s+/g,""))return l.text=o.join(" ").replace(/\n/g," "),i.push(l),void c();const n=t[t.length-2],r=e.text.indexOf(n)+n.length+1,a=e.text.substring(0,r);return d.text=e.text.substring(r),d.start=e.start,o.splice(o.length-1,1,a),l.text=o.join(" ").replace(/\n/g," "),i.push(l),void c()}return}return l.text=o.join(" ").replace(/\n/g," "),i.push(l),void c()}})),Array.from(i).map((e=>{const i=V(e.start);return`<div class="glasp_yt_transcript_text_segment">\n                    <div><a class="glasp_yt_transcript_text_timestamp" href="/watch?v=${t.v}&t=${i}s" target="_blank" data-glasp-href="/watch?v=${t.v}&t=${i}s" data-start-time="${i}">${e.start}</a></div>\n                    <div data-start-time="${i}">${e.text}</div>\n                </div>`})).join("");function c(){n=0,o=[],r=0,a=0,l={}}}function V(e){let t=0;const i=e.split(":");return 2==i.length?t=60*parseInt(i[0])+parseInt(i[1]):3==i.length&&(t=60*parseInt(i[0])*60+60*parseInt(i[1])+parseInt(i[2])),parseInt(t)}function Z(e){return new Promise((t=>{if(document.querySelector(e))return t(document.querySelector(e));const i=new MutationObserver((n=>{document.querySelector(e)&&(t(document.querySelector(e)),i.disconnect())}));i.observe(document.body,{childList:!0,subtree:!0})}))}let W={},G="",X=0,Y=null,Q=null,J=null,K=null,ee=0,te=null,ie=null,ne=0,oe="",re=0,ae=!1,le=0,se=!0;const de="~|:~|@%*;",ce=";:~|@%*~;",ge="highlighter--highlighted",he=`<glasp class="(${_e(ge)})" style="background-color: [a-z]+;"( highlightid="[0-9]+")?>`,pe="</glasp>",me=_e(pe);function _e(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}function ue(){W={},G="",X=0,Y="",Q="",J=null,K=null,ee=0,te=null,ie=null,ne=0,oe="",re=0,ae=!1,le=0,se=!0}function fe(e,t,i,n,o,r,a,l,s,c,h){if(0===e.length)return;if(ue(),g(),oe=l||"#FFB6C6",re=s,G=e,X=G.length,Q=$(t),K=$(i),ie=$(o),void 0===t)return;be(Q,K,n,ie,r,G,X);const p=Q.parent();let u=Q.html();if(void 0===u||null==u)return;let f=!1;const y=Q.contents(),b=function(e,t){return{start:`<glasp class="${ge}" style="font-weight: inherit !important;font-style: inherit !important;line-height: inherit !important;background-color: ${e} !important;cursor: pointer !important;" highlightid="${t}">`,end:pe}}(oe,re);for(let e=0;e<y.length;e++)if(y[e].nodeType==Node.TEXT_NODE){f=!0;break}if(f){let e,t,i;if(se){e=new RegExp(_e(de),"g"),t=new RegExp(_e(ce),"g"),u=u.replace(e,b.end).replace(t,b.start),i=new RegExp(he+me,"g");const n=u.replace(i,"");ye(Q),Q.html(n)}else e=new RegExp(_e(de),"g"),t=new RegExp(_e(ce),"g"),u=u.replace(e,b.start).replace(t,b.end),ye(Q),Q[0].innerHTML=u}else for(let e=0;e<y.length;e++){let t,i,n,o=$(y[e]),r=o.html();if(""!=r.replace(/[\n\r\s]+/g,"")&&null!=r&&null!=r&&(!r||r.includes(de)))if(se){t=new RegExp(_e(de),"g"),i=new RegExp(_e(ce),"g"),r=r.replace(t,b.end).replace(i,b.start),n=new RegExp(he+me,"g");const e=r.replace(n,"");ye(o),o.html(e)}else t=new RegExp(_e(de),"g"),i=new RegExp(_e(ce),"g"),r=r.replace(t,b.start).replace(i,b.end),ye(o),o.html(r)}if(a.removeAllRanges&&a.removeAllRanges(),p.find(`.${ge}`).each(((e,t)=>{if($(t).css("color")){let e=$(t).css("color"),i=/^rgba/.test(e)?e.match(/^rgba\((\d+),\s*(\d+),\s*(\d+),\s*([^abc]+)\)$/):e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);if(Math.round((299*parseInt(i[1])+587*parseInt(i[2])+114*parseInt(i[3]))/1e3)>150){const e=i[1],n=i[2],o=i[3],r=Math.max(e,n,o)-Math.min(e,n,o);$(t)[0].style.cssText=r<50?`background-color: ${l} !important; color: rgb(53, 53, 53) !important;`:`background-color: ${l} !important; color: rgb(51, 102, 187) !important;`}}t.addEventListener("mouseenter",A),t.addEventListener("click",S),t.addEventListener("mouseleave",H)})),!c&&_()){const e=d(m.sidebar_iframe_doc,m.sidebar_copy_all,m.highlightEmptyEl,m.loadedHighlights);chrome.runtime.sendMessage({action:"highlight_store",data:[h,e]})}}function ye(e){Array.from(e.contents()).forEach(((e,t,i)=>{e.nodeType===Node.TEXT_NODE?e.nodeValue="":ye($(e))}))}function be(e,t,i,n,o,r,a){Array.from(e.contents()).forEach(((e,l,s)=>{if(e.nodeType===Node.TEXT_NODE){let l=0;if(ae||(t.is(e)&&(ae=!0,l=i),n.is(e)&&(ae?l=Math.min(i,o):(ae=!0,l=o))),ae&&le<a){let t,i="";if(e.nodeValue.length){t=e.nodeValue.length;const n=e.parentElement;"GLASP"===n.nodeName&&n.classList.contains(ge)||(se=!1);for(let n=0;n<t;n++){if(n===l&&(i+=de),le===a){i+=ce,i+=e.nodeValue.substr(n);break}if(i+=e.nodeValue[n],n>=l&&le<a){for(;le<a&&r[le].match(/\s/);)le++;r[le]===e.nodeValue[n]&&le++}n===t-1&&(i+=ce)}}e.nodeValue=i}}else be($(e),t,i,n,o,r,a)}))}function we(e,r,d){let c,g,h,p,_,u,f=o()?e.toString().replace(/\n/g," "):e.toString();for(let e=f.length-1;e>0;e--)if(" "!=f[e]&&"\n"!=f[e]){f=f.substring(0,e+1);break}const y=Math.random().toString(36).substring(2,10)+Math.random().toString(36).substring(2,10),b=i(),w=b.url,E=b.fullUrl,x=document.createRange();let k=!1;if(!f)return;if(d){m.tripleClicked=!1;let e=document.getSelection().getRangeAt(0).startContainer;if(x.selectNode(e),document.getSelection().getRangeAt(0).startContainer.nodeType==Node.ELEMENT_NODE){const t=document.getSelection().getRangeAt(0).startContainer.childNodes;for(let i=0;i<t.length;i++)if(t[i].nodeType==Node.TEXT_NODE){e=t[i];break}x.selectNode(e)}else document.getSelection().getRangeAt(0).startContainer.nodeType==Node.TEXT_NODE&&("STRONG"==e.parentElement.nodeName?(c=e,g=0,h=t(c),p=e.parentNode.parentNode.lastChild,_=p.length,u=t(p),x.setStart(e.parentNode.parentNode,g),x.setEnd(p,_),k=!0):x.selectNode(e));if(x.startContainer.innerText.length>f.length){let i="";const n=document.getSelection().toString().replace(/[\n\r\s]+/g,"").length;for(let e=x.startOffset;e<x.startContainer.childNodes.length;e++)if(x.startContainer.childNodes[e].nodeType==Node.TEXT_NODE?i+=x.startContainer.childNodes[e].wholeText:x.startContainer.childNodes[e].nodeType==Node.ELEMENT_NODE&&(i+=x.startContainer.childNodes[e].innerText),i.replace(/[\n\r\s]+/g,"").length==n){p=x.startContainer.childNodes[e],_=p.length,u=t(p);break}x.setStart(e,0),x.setEnd(p,_),c=e,g=0,h=t(c)}else if(!k){if($(x.startContainer)[0].childNodes){const e=$(x.startContainer)[0].childNodes;for(let t=0;t<e.length;t++)if(e[t].nodeType==Node.TEXT_NODE){c=e[t];break}}g=0,h=t(c),p=$(x.endContainer)[0].lastChild,_=p.length,u=t(p)}}else{const i=v(e);c=i.anchorNode,g=i.anchorOffset,h=t(c),p=i.focusNode,_=i.focusOffset,u=t(p),x.setStart(c,g),x.setEnd(p,_)}const L=n(),B=l();let T=x.commonAncestorContainer,I=t(T);for(;!T.innerHTML;)T=T.parentNode,I=t(T);let C=-1,M="";a()&&(C=function(){let e,t;const i=window.getSelection(),n=i.anchorNode,o=i.anchorOffset,r=i.focusNode,a=i.focusOffset;if(n==r)e=o<a?n:r,t=o<a?o:a;else{let l=i.anchorNode.compareDocumentPosition(i.focusNode)===Node.DOCUMENT_POSITION_PRECEDING;e=l?r:n,t=l?a:o}const l=e.parentElement.getAttribute("data-start-time");if(!l)return-1;let s=0,d=0;const c=j();for(let e=0;e<c.length;e++){const i=c[e],n=i.text.replace(/\n/g," "),o=i.starttime;if(s>t){d=c[e-1].starttime;break}o>=l&&(s+=n.length+1)}return d}(),M=z());const N={selectionString:f,container:T,anchorNode:c,anchorOffset:g,focusNode:p,focusOffset:_,selection:e};if(fe(N.selectionString,N.container,N.anchorNode,N.anchorOffset,N.focusNode,N.focusOffset,N.selection,r,y,!1,{selectionString:f,url:w,anchorOffset:g,focusOffset:_,containerQuery:I,anchorNodeQuery:h,focusNodeQuery:u,colorId:r,pageTitle:L,pageThumbnailPhoto:B,fullUrl:E,highlightid:y,yt_transcript_start:C,yt_transcript_lang:M}),a()){const e=function(){let e="";const t=z();""!==t&&(e=t);const i=j();return{video_id:s(window.location.href).v,language:e,raw_transcript:i}}();if(0==e.raw_transcript.length)return;chrome.runtime.sendMessage({action:"yt_transcript_store",data:e})}}function ve(){const e=$(".highlighter--highlighted");m.tooltipEl&&m.tooltipEl.hide(),m.hoverToolTimeout=null;for(let t=0;t<e.length;t++)e[t].outerHTML=e[t].innerHTML;m.highlightsListEl.innerHTML="",g()}function Ee(e){const t=i();if(t&&null!=t.url&&null!=t.url){const e="on";chrome.runtime.sendMessage({action:"initial_load",data:[t.url,t.fullUrl,e]})}}function xe(t,i){const n=e(t.anchorNode),o=t.anchorOffset,r=e(t.focusNode),a=t.focusOffset,l=t.string,s=e(t.container);let d;d="#98FF7E"==t.colorId?"#A2F8A0":t.colorId,fe(l,s,n,o,r,a,{anchorNode:n,anchorOffset:o,focusNode:r,focusOffset:a},d,t.highlightid,i)}const ke=`\n<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="utf-8">\n    <link rel="stylesheet" type="text/css" href="${chrome.runtime.getURL("/iframe/shareHighlight.css")}">\n</head>\n<body>\n    <div class="share_hl_modal_bg" id="share_hl_modal_bg" style="display: flex;position:fixed;padding:0;margin:0;top:0;left:0;width: 100%;height: 100%;z-index: 50;overflow: hidden;background-color: rgba(0, 0, 0, 0.6);">\n        <div class="share_hl_modal" id="share_hl_modal" style="width: fit-content;overflow: scroll;background-color: #FFFFFF;border-radius: 4px;margin: auto;padding: 24px 32px;">\n            <div class="share_hl_close_btn_wrapper" style="display: flex;justify-content: right;align-items: center;height: 24px;padding-bottom: 16px;">\n                <div class="share_hl_close_btn" id="share_hl_close_btn" style="padding: 6px;margin: auto;margin-right: 0;display: flex;align-items: center;"><img src="${chrome.runtime.getURL("/images/close.png")}" alt="" style="width: 18px !important;height: 18px !important;box-shadow: none !important;"></div>\n            </div>\n            <div id="share_hl_img_wrapper" class="share_hl_img_wrapper" style="width: 480px;height: 380px;min-height: 200px;display: flex;justify-content: center;align-items: center;"></div>\n            <div class="share_hl_color_options">\n                <div class="share_hl_bgcolor_wrapper">\n                    <div class="share_hl_bgcolor" style="background: #FFFFFF;" title="white"></div>\n                    <div class="share_hl_bgcolor" style="background: #fdffd4;" title="yellow"></div>\n                    <div class="share_hl_bgcolor" style="background: #fff4fe;" title="pink"></div>\n                    <div class="share_hl_bgcolor" style="background: linear-gradient(90deg, rgb(255 98 48) 0%, rgb(255 202 42) 100%);" title="orange"></div>\n                    <div class="share_hl_bgcolor" style="background: linear-gradient(90.88deg, #367bff 0%, #9C52D6 100%);" title="purple"></div>\n                    <div class="share_hl_bgcolor" style="background: linear-gradient(60deg, rgb(0 146 255) 0%, rgba(9,9,121,1) 35%, rgba(2,0,36,1) 100%);" title="navy"></div>\n                    <div class="share_hl_bgcolor" style="background: #000000;" title="black"></div>\n                </div>\n            </div>\n            <div class="share_hl_footer" style="display: flex;justify-content: space-between;align-items: center;padding: 32px 0 12px;">\n                <div class="share_hl_footer_left" style="display: flex;gap: 16px;cursor: pointer;user-select: none;">\n                    <p class="share_hl_img_orient" id-img-orientation="square" style="margin: 0px;">Square</p>\n                    <p class="share_hl_img_orient" id-img-orientation="landscape" style="margin: 0px;">Landscape</p>\n                </div>\n                <div class="share_hl_footer_right" style="display: flex;justify-content: space-between;align-items: center;">\n                    <img id="share_hl_save" src="${chrome.runtime.getURL("/images/img_download.png")}" style="width: 26px !important;height: 26px !important;margin: 0 10px;box-shadow: none !important;filter: grayscale(1);" />\n                    <img id="share_hl_facebook" src="${chrome.runtime.getURL("/images/facebook.png")}" style="width: 26px !important;height: 26px !important;margin: 0 10px;box-shadow: none !important;filter: grayscale(1);" />\n                    <img id="share_hl_twitter" src="${chrome.runtime.getURL("/images/twitter.png")}" style="width: 26px !important;height: 26px !important;margin: 0 10px;box-shadow: none !important;filter: grayscale(1);" />\n                </div>\n            </div>\n        </div>\n    </div>\n</body>\n</html>`;let Le="navy",Be="square";const Te=["white","yellow","pink","green"],Ie=async(e,t,n,o)=>{const r=i().fullUrl;document.getElementById("glasp-share-hl-iframe")&&document.getElementById("glasp-share-hl-iframe").remove(),document.body.insertAdjacentElement("beforeend",(()=>{let e=document.createElement("iframe");return e.name="glasp-share-hl-iframe",e.setAttribute("id","glasp-share-hl-iframe"),$(e).attr("style","width: 100% !important; height: 100%; margin: auto; position: fixed; top: 0px; right: 0px; z-index: 9000000000000000001;"),e})());const a=document.getElementById("glasp-share-hl-iframe").contentWindow.document;a.open(),a.write(ke),a.close();let l=Me(await Ce(e,t,r));a.getElementById("share_hl_close_btn").addEventListener("click",(()=>{document.getElementById("glasp-share-hl-iframe")&&document.getElementById("glasp-share-hl-iframe").remove()})),a.getElementById("share_hl_modal_bg").addEventListener("click",(e=>{e.target===e.currentTarget&&document.getElementById("glasp-share-hl-iframe")&&document.getElementById("glasp-share-hl-iframe").remove()})),Array.from(a.getElementsByClassName("share_hl_bgcolor")).forEach((i=>{Le==i.getAttribute("title")&&i.classList.add("share_hl_selected_bgcolor"),i.addEventListener("click",(async()=>{i.classList.contains("share_hl_selected_bgcolor")||(Array.from(a.getElementsByClassName("share_hl_bgcolor")).forEach((e=>{e.classList.remove("share_hl_selected_bgcolor")})),i.classList.add("share_hl_selected_bgcolor"),Le=i.getAttribute("title"),l=Me(await Ce(e,t,r)))}),!1)})),Array.from(a.getElementsByClassName("share_hl_img_orient")).forEach((i=>{Be==i.getAttribute("id-img-orientation")&&i.classList.add("orientation_selected"),i.addEventListener("click",(async()=>{i.classList.contains("orientation_selected")||(Array.from(a.getElementsByClassName("share_hl_img_orient")).forEach((e=>{e.classList.remove("orientation_selected")})),i.classList.add("orientation_selected"),Be=i.getAttribute("id-img-orientation"),l=Me(await Ce(e,t,r)))}),!1)}));const s=window.getSelection();a.getElementById("share_hl_save").addEventListener("click",(async()=>{!async function(e){const t=document.getElementById("glasp-share-hl-iframe").contentWindow.document,i=(await e).toDataURL("image/png",1),n=t.createElement("a");n.setAttribute("href",i),n.setAttribute("download","highlight_glasp.png"),t.body.appendChild(n),n.click(),n.remove()}(l),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"extension_share_hl_save_img_click"}),o||we(s,"#FFB6C6")})),a.getElementById("share_hl_twitter").addEventListener("click",(async()=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"extension_share_hl_twitter_click"});const i=`"${e.text}"`,n=`https://twitter.com/intent/tweet?${new URLSearchParams([["text",`${i}\n\n${t} via @_Glasp\n${r}`]]).toString()}`;window.open(n,"_blank","toolbar=yes,scrollbars=yes,resizable=yes,top=100,left=200,width=550,height=600"),o||we(s,"#FFB6C6")})),a.getElementById("share_hl_facebook").addEventListener("click",(async()=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"extension_share_hl_facebook_click"});const t=`"${e.text}"`,i=`https://www.facebook.com/sharer/sharer.php?${new URLSearchParams([["u",r]]).toString()}&quote=${t}`;window.open(i,"_blank","toolbar=yes,scrollbars=yes,resizable=yes,top=100,left=200,width=550,height=700"),o||we(s,"#FFB6C6")}))};async function Ce(e,t,i){const n="square"==Be,o=n?"400px":"700px",r=n?"400px":"364px",a=n?"450":"800",l=n?"30px 25px 20px":"50px 50px 20px",s=new URL(i),d=["medium.com","note.com"].includes(s.host)&&"/"!==s.pathname&&s.pathname.split("/").length?s.host+"/"+s.pathname.split("/")[1]:s.host;let c=!1;const g=Ne(t[0]).length,h=Ne(t[Math.floor(t.length/3)]).length,p=Ne(t[Math.floor(2*t.length/3)]).length;(g>=2||h>=2||p>=2)&&(c=!0);const m=e.text.length,_=Te.includes(Le)?"#353535":"#FFFFFF",u=Te.includes(Le)?"#575757":"#FFFFFF",f=Te.includes(Le)?"#8B8B8B":"#FFFFFF",y=Te.includes(Le)?"#6297ff":"#FFFFFF";Te.includes(Le)&&e.color;let b=n?m>300?23:m>250?26:m>200?28:m>150?31:m>100?33:37:m>300?25:m>200?30:m>120?34:38;c&&(b-=6);const w=`font-family: serif; font-weight: normal; color: ${u}; margin: 0px; font-size: ${n?"17px":"21px"}; line-height: 1.3em; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; letter-spacing: -0.02em; font-style: italic;`,v=`font-family: serif; font-style: normal; font-weight: normal; color: ${f}; margin: 0px; font-size: ${n?"16px":"19px"}; margin-top:3px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical;`,E=`\n    <div style="width: ${o}; height: ${r}; padding: ${l}; display: flex; align-items: center; position: relative;">\n        <div style="display: grid; width: 100%; height: 100%; align-content: center; justify-content: center;">\n            <div style="height: 280px; display:grid; align-content: center; justify-content: center;">\n                <p style="${n?`font-family: serif;; font-style: italic; font-weight: normal; color: ${_}; margin: 0px; display: -webkit-box; -webkit-line-clamp: 9; -webkit-box-orient: vertical; overflow: hidden; max-height: 280px; font-size: ${b}px; line-height: 1.2em; text-align: center;`:`font-family: sarif; font-style: normal; font-weight: normal; color: ${_}; margin: 0px; padding-left: 22px; font-style: italic; display: -webkit-box; -webkit-line-clamp: 7; -webkit-box-orient: vertical; overflow: hidden; max-height: 272px; font-size: ${b}px; line-height: 1.4em;`}">${e.text.replaceAll("\n","<br />").replace(/&(?!#?[a-z0-9]+;)/g,"&amp;")}</p>\n            </div>\n            <div style="height: 90px; width: 90%; display:grid; align-content: center; text-align: right; margin-left: auto;">\n                <p style="${w}">${t.replace(/&(?!#?[a-z0-9]+;)/g,"&amp;")}</p>\n                <p style="${v}">${d.replace(/&(?!#?[a-z0-9]+;)/g,"&amp;")}</p>\n            </div>\n            <div style="height: 20px; text-align: right;">\n                <p style="${v} color: ${y};">#glaspquotes</p>\n            </div>\n        </div>\n    </div>`;let x="";switch(Le){case"white":x='\n            <stop offset="0%" style="stop-color:#fcfcfc;stop-opacity:1"></stop>';break;case"black":x='\n            <stop offset="0%" style="stop-color:#000000;stop-opacity:1"></stop>';break;case"yellow":x='\n            <stop offset="0%" style="stop-color:#feffe5;stop-opacity:1"></stop>';break;case"pink":x='\n            <stop offset="0%" style="stop-color:#fff4fe;stop-opacity:1"></stop>';break;case"green":x='\n            <stop offset="0%" style="stop-color:#ddffe5;stop-opacity:1"></stop>';break;case"navy":x='\n            <stop offset="0%" style="stop-color:rgb(0,146,255);stop-opacity:1"></stop>\n            <stop offset="20%" style="stop-color:rgb(9,9,121,255);stop-opacity:1"></stop>\n            <stop offset="100%" style="stop-color:rgb(2,0,36);stop-opacity:1"></stop>';break;case"purple":x='\n            <stop offset="0%" style="stop-color:rgb(54,123,255);stop-opacity:1" />\n            <stop offset="100%" style="stop-color:rgb(156,82,214);stop-opacity:1" />';break;case"orange":x='\n            <stop offset="0%" style="stop-color:#ffc414;stop-opacity:1"></stop>\n            <stop offset="30%" style="stop-color:#ff7127;stop-opacity:1"></stop>'}const k=new Blob([`\n    <svg xmlns="http://www.w3.org/2000/svg" width="${a}" height="450">\n        <defs>\n            <linearGradient id="grad1" x1="0%" y1="110%" x2="100%" y2="0%">\n                ${x}\n            </linearGradient>\n        </defs>\n        <rect x="0" y="0" width="${a}" height="450" fill="url(#grad1)" />\n        <foreignObject width="100%" height="100%" fill="url(#grad1)">\n            <div xmlns="http://www.w3.org/1999/xhtml">${E}</div>\n        </foreignObject>\n    </svg>`],{type:"image/svg+xml;charset=utf-8"});var L;return await(L=k,new Promise(((e,t)=>{const i=new FileReader;i.onloadend=()=>e(i.result),i.readAsDataURL(L)})))}function Me(e){const t=document.getElementById("glasp-share-hl-iframe").contentWindow.document,i=t.createElement("canvas");i.width="square"==Be?"450":"800",i.height=450,i.style.boxShadow="0px 4px 8px rgb(0,0,0,0.2) !important";const n=i.getContext("2d");if(t.getElementById("share_hl_img"))return r(t.getElementById("share_hl_img"),i,n);const o=new Image;return o.setAttribute("id","share_hl_img"),o.setAttribute("crossOrigin","anonymous"),o.src=e,o.style.maxWidth="480px",o.style.maxHeight="380px",t.getElementById("share_hl_img_wrapper").innerHTML="",t.getElementById("share_hl_img_wrapper").appendChild(o),r(o,i,n);function r(t,i,n){return t.onload=()=>{i.width=3*i.width,i.height=3*i.height,n.drawImage(t,0,0,i.width,i.height),t.onload=()=>{n.drawImage(t,0,0)},t.src=i.toDataURL("image/png",1)},t.src=e,i}}function Ne(e){return decodeURIComponent(encodeURIComponent(escape(e))).replace(/%([0-9A-F]{2})/gi,(function(e,t){var i=parseInt(t,16);return String.fromCharCode(i)}))}function $e(e){const t=i().fullUrl,o=n(),r=m.sidebar_iframe_doc.getElementById("page_note_content"),a=""!==m.userPagenote||null!==m.userPagenote?m.userPagenote:""!==r.innerHTML||null!==r.innerHTML?r.innerHTML:"";switch(e.currentTarget.getAttribute("id")){case"email_share":!function(){chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_share_email"});let e=`Highlights on "${o}"`,i="",n="",r=0;if(0!==m.loadedHighlights.length)for(let e=0;e<m.loadedHighlights.length;e++){const t=m.loadedHighlights[e].string;let i="";"note"in m.loadedHighlights[e]&&""!==m.loadedHighlights[e].note&&(r+=1,i=m.loadedHighlights[e].note),n+=""!==i?`(${e+1}) ${t}<br>  * Note: ${i}<br><br>`:`(${e+1}) ${t}<br><br>`}if(i+=`<br>Title:<br>${o}<br>${t}<br>`,0!==m.userTagList.length){let e="";for(let t=0;t<m.userTagList.length;t++)e+=0==t?`${m.userTagList[t]}`:`, ${m.userTagList[t]}`;i+=`<br>Tags:<br>${e}<br>`}i+=""!==a&&""!==n?`<br>Page Note:<br>${a.replaceAll("\n","%0D%0A")}<br><br>${m.loadedHighlights.length} Highlights and ${r} Notes:<br>${n}<br>`:""!==a&&""==n?`<br>Page Note:<br>${a.replaceAll("\n","%0D%0A")}<br>`:""!==n?`<br>${m.loadedHighlights.length} Highlights and ${r} Notes:<br>${n}<br>`:"<br>",i+="Highlighted via Glasp<br>https://glasp.co";let l=`mailto:?subject=${e}&body=${i.replaceAll("<br>","%0D%0A")}`;window.open(l,"_self")}();break;case"linkedin_share":!function(){chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_share_linkedin"});const e=`https://www.linkedin.com/sharing/share-offsite/?${new URLSearchParams([["url",t]]).toString()}`;window.open(e,"_blank","toolbar=yes,scrollbars=yes,resizable=yes,top=100,left=200,width=550,height=700")}();break;case"fb_share":!function(){chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_share_facebook"});const e=`https://www.facebook.com/sharer/sharer.php?${new URLSearchParams([["u",t]]).toString()}`;window.open(e,"_blank","toolbar=yes,scrollbars=yes,resizable=yes,top=100,left=200,width=550,height=700")}();break;case"twitter_share":!function(){chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_share_twitter"});const e=0!==m.loadedHighlights.length?`"${m.loadedHighlights[0].string}"`:"",i=`https://twitter.com/intent/tweet?${new URLSearchParams([["text",`${e}\n\n${o} via @_Glasp\n${t}`]]).toString()}`;window.open(i,"_blank","toolbar=yes,scrollbars=yes,resizable=yes,top=100,left=200,width=550,height=600")}()}}function Ae(e,t){chrome.runtime.sendMessage({action:"update_exclude_domain",data:{domain:t,action:e}})}function He(e){if(m.sidebar_iframe_doc&&Array.from(m.sidebar_iframe_doc.getElementsByClassName("content_tag_icon")).forEach((e=>{e.remove()})),m.sidebar_iframe_doc.getElementById("content_tag_list").innerHTML="",m.sidebar_iframe_doc.getElementById("content_tag_list").insertAdjacentHTML("beforeend",`${Array.from(e).map((e=>`<div class="content_tag" title="${e}" style="font-size: 13px;line-height: 16px;text-align: center;padding: 3px 8px;border-radius: 13px;color: #3D3D3D;background-color: #E2E2E2;margin: 0px 3px;user-select: none;display: flex;justify-content: left;align-items: center;white-space: nowrap;">\n                    <div>${e}</div>\n                    ${m.selectedUsersUID==m.uid||null==m.selectedUsersUID?'<div class="content_tag_delete_btn" style="display: none;">×</div>':""}\n                </div>`)).join("")}`),m.selectedUsersUID==m.uid||null==m.selectedUsersUID){t(),m.sidebar_iframe_doc.getElementById("content_tag_wrapper").insertAdjacentHTML("beforeend",'<button id="content_tag_icon" style="outline: none;background: transparent;display: flex;padding: 0;border: none;"><svg  class="content_tag_icon" width="33" height="22" viewBox="0 0 38 22" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M26.6146 19.9179L19.1258 12.429C18.945 12.2483 18.8403 12.0051 18.8332 11.7496L18.6126 3.77648C18.5967 3.20267 19.0661 2.73331 19.6399 2.74919L27.613 2.96986C27.8685 2.97694 28.1117 3.08161 28.2924 3.26238L35.7813 10.7512C36.1718 11.1418 36.1718 11.7749 35.7813 12.1654L28.0288 19.9179C27.6383 20.3084 27.0051 20.3084 26.6146 19.9179Z" stroke="#8B8B8B" stroke-width="2"/>\n            <ellipse cx="23.8596" cy="7.70834" rx="1.5" ry="1.5" transform="rotate(-45 23.8596 7.70834)" fill="#8B8B8B"/>\n            <path d="M3 11H13M8 6V16" stroke="#8B8B8B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n        </svg></button>');const e=m.sidebar_iframe_doc.getElementById("content_tag_icon"),i=m.sidebar_iframe_doc.getElementById("content_tag_list");e.addEventListener("click",(function(t){i.style.border="1px solid rgb(0, 0, 0, 0.1)",i.style.marginLeft="-1px",i.style.marginRight="-1px",i.style.width="100%",e.style.display="none",chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_tag_focus"}),0==m.userTags.length&&(chrome.runtime.sendMessage({action:"get_user_tags"}),setTimeout((()=>{const e=m.sidebar_iframe_doc.getElementById("new_content_tag_input"),t=m.sidebar_iframe_doc.getElementsByClassName("tag_suggestion");m.userTags.length>0&&0==t.length&&e&&""==e.value&&r(a())}),1500)),o()}),!1),$(document).find("body").bind("mousedown",(function(t){$(t.target).closest(".content_tag_input, .tag_suggestion_wrapper, .content_tag").length||(e.style.display="flex",i.style.width="fit-content",i.style.border="none",i.style.marginLeft="0px",i.style.marginRight="3px"),$(t.target).closest(".content_tag").length||(Array.from(m.sidebar_iframe_doc.getElementsByClassName("content_tag")).forEach((e=>{e.style.backgroundColor="#E2E2E2"})),Array.from(m.sidebar_iframe_doc.getElementsByClassName("content_tag_delete_btn")).forEach((e=>{e.style.display="none"}))),$(t.target).closest(".content_tag_input, .content_tag, .tag_suggestion_wrapper").length||m.sidebar_iframe_doc&&(Array.from(m.sidebar_iframe_doc.getElementsByClassName("content_tag_input")).forEach((e=>{e.remove()})),Array.from(m.sidebar_iframe_doc.getElementsByClassName("tag_suggestion_div")).forEach((e=>{e.remove()})))})),m.sidebar_element.find("body").bind("mousedown",(function(t){$(t.target).closest(".content_tag_input, .tag_suggestion_wrapper, .content_tag").length||(e.style.display="flex",i.style.width="fit-content",i.style.border="none",i.style.marginLeft="0px",i.style.marginRight="3px"),$(t.target).closest(".content_tag").length||(Array.from(m.sidebar_iframe_doc.getElementsByClassName("content_tag")).forEach((e=>{e.style.backgroundColor="#E2E2E2"})),Array.from(m.sidebar_iframe_doc.getElementsByClassName("content_tag_delete_btn")).forEach((e=>{e.style.display="none"}))),$(t.target).closest(".content_tag_input, .content_tag, .tag_suggestion_wrapper").length||m.sidebar_iframe_doc&&(Array.from(m.sidebar_iframe_doc.getElementsByClassName("content_tag_input")).forEach((e=>{e.remove()})),Array.from(m.sidebar_iframe_doc.getElementsByClassName("tag_suggestion_div")).forEach((e=>{e.remove()})))}))}function t(){m.sidebar_iframe_doc&&Array.from(m.sidebar_iframe_doc.getElementsByClassName("content_tag")).forEach((e=>{e.outerHTML=e.outerHTML})),Array.from(m.sidebar_iframe_doc.getElementsByClassName("content_tag")).forEach(((o,r,a)=>{o.addEventListener("click",(function(a){const s=m.sidebar_iframe_doc.getElementsByClassName("content_tag_delete_btn")[r];if(s.style.display="block"==s.style.display?"none":"block",o.style.backgroundColor="#D2D2D2"==o.style.backgroundColor?"#E2E2E2":"#D2D2D2",a.stopPropagation(),a.target==s){for(let t=0;t<e.length;t++)e[t]==o.getAttribute("title")&&e.splice(t,1);o.remove();const r=i(),a=r.url,s=r.fullUrl,d=n(),c=l(),g={url:a,fullUrl:s,userTagList:e,tagString:o.getAttribute("title"),title:d,thumbnail:c};chrome.runtime.sendMessage({action:"tag_delete",data:g}),t()}}),!1)}))}function o(){m.sidebar_iframe_doc.getElementById("content_tag_list").insertAdjacentHTML("beforeend",'<input class="content_tag_input" id="new_content_tag_input" data-lpignore="true" autocomplete="off" placeholder="Add a tag..." maxlength="25">'),$(m.sidebar_iframe_doc.getElementById("new_content_tag_input")).focus(),r(a()),m.sidebar_iframe_doc.getElementById("new_content_tag_input").addEventListener("input",(function(t){this.style.width=80+15*(this.value.length+1)+"px",m.sidebar_iframe_doc&&Array.from(m.sidebar_iframe_doc.getElementsByClassName("tag_suggestion_div")).forEach((e=>{e.remove()})),r(""==t.target.value?a():function(t){const i=[];return Array.from(m.userTags).forEach((n=>{const o=n.toLowerCase(),r=t.toLowerCase();e.includes(n)||o.includes(r)&&!i.includes(n)&&(r[0]==o[0]?i.unshift(n):i.push(n))})),i}(t.target.value))}),!1);let t,i=-1;m.sidebar_iframe_doc.getElementById("new_content_tag_input").addEventListener("keydown",(function(e){if("Enter"==e.key){if(t)return void s(t.innerText);s(e.target.value)}if("ArrowDown"==e.key&&m.sidebar_iframe_doc.getElementsByClassName("tag_suggestion").length>0){e.preventDefault();const n=m.sidebar_iframe_doc.getElementsByClassName("tag_suggestion").length,o=-1==i||i+1>=n?0:i+1;t=m.sidebar_iframe_doc.getElementsByClassName("tag_suggestion")[o],Array.from(m.sidebar_iframe_doc.getElementsByClassName("tag_suggestion")).forEach((e=>{e.style.backgroundColor="transparent"})),m.sidebar_iframe_doc.getElementsByClassName("tag_suggestion")[o].style.backgroundColor="#EAEAEA",i=o}if("ArrowUp"==e.key&&m.sidebar_iframe_doc.getElementsByClassName("tag_suggestion").length>0){e.preventDefault();const n=m.sidebar_iframe_doc.getElementsByClassName("tag_suggestion").length,o=-1==i||0==i?n-1:i-1;t=m.sidebar_iframe_doc.getElementsByClassName("tag_suggestion")[o],Array.from(m.sidebar_iframe_doc.getElementsByClassName("tag_suggestion")).forEach((e=>{e.style.backgroundColor="transparent"})),m.sidebar_iframe_doc.getElementsByClassName("tag_suggestion")[o].style.backgroundColor="#EAEAEA",i=o}}),!1)}function r(e){m.sidebar_iframe_doc&&Array.from(m.sidebar_iframe_doc.getElementsByClassName("tag_suggestion_div")).forEach((e=>{e.remove()})),m.sidebar_iframe_doc.getElementById("content_tag_wrapper").insertAdjacentHTML("afterend",`<div class="tag_suggestion_div" id="tag_suggestion_div" style="position:relative;">\n            <div style="position:absolute;" class="tag_suggestion_wrapper" id="tag_suggestion_wrapper">\n                ${Array.from(e).map((e=>e?`<div class="tag_suggestion">${e}</div>`:"")).join("")}\n            </div>\n        </div>`),m.sidebar_iframe_doc.getElementById("tag_suggestion_wrapper").style.minWidth=m.sidebar_iframe_doc.getElementById("content_tag_icon").clientWidth+"px",m.sidebar_iframe_doc.getElementById("tag_suggestion_wrapper").addEventListener("mouseup",(function(e){m.sidebar_iframe_doc.getElementById("tag_suggestion_div").remove(),s(e.target.innerText)}),!1)}function a(){const t=[],i=function(e){const t=new Set;for(let i=0;i<e.length;i++)t[e[i]]=1+(t[e[i]]||0);const i=[];for(let e in t)i.push([e,t[e]]);return i.sort((function(e,t){return t[1]-e[1]})),i}(m.userTags);return Array.from(i).forEach(((i,n,o)=>{const r=i[0];n>30||e.includes(r)||t.includes(r)||t.push(r)})),t}function s(r){if("Untagged Items"==r||!r.replace(/\s/g,"").length)return;if(e.includes(r))return;m.sidebar_iframe_doc.getElementById("new_content_tag_input").remove(),m.sidebar_iframe_doc.getElementById("content_tag_list").insertAdjacentHTML("beforeend",`<div class="content_tag" title="${r}" style="font-size: 13px;line-height: 16px;text-align: center;padding: 3px 8px;border-radius: 13px;color: #3D3D3D;background-color: #E2E2E2;margin: 0px 3px;user-select: none;display: flex;justify-content: left;align-items: center;white-space: nowrap;">\n            <div>${r}</div>\n            <div class="content_tag_delete_btn" style="display: none;">×</div>\n        </div>`),e.push(r),t(),o();const a=i(),s=a.url,d=a.fullUrl,c=n(),g=l(),h={url:s,fullUrl:d,userTagList:e,newTagInput:r,title:c,thumbnail:g};chrome.runtime.sendMessage({action:"tag_add",data:h})}}function Se(e){let t=!(!e||""===e),o=m.sidebar_iframe_doc.getElementById("page_note_section");o.innerHTML="";const r=m.viewingOthersHLs?m.selectedUsersPhotoURL:m.photoURL,a=m.viewingOthersHLs?m.selectedUserUsername:m.username,s=`\n    <div class="sidebar_section_title_wrapper" id="pagenote_title" style="display: flex;justify-content: left;align-items: center;padding: 2vw 5vw;height: 24px;width: 90vw;">\n        <div class="sidebar_section_title" style="font-size: 16px;font-weight: bold;">Page Comment</div>\n        ${m.viewingOthersHLs?"":'<div class="page_note_action_btn_wrapper" id="page_note_action_btn_wrapper" style="display: block;"><button class="page_note_action_btn" id="page_note_save_btn" style="display: none;">Save</button></div>'}\n    </div>\n    <div class="dashboard_pn" id="dashboard_pn_container" style="display: flex;justify-content: left;align-items: flex-start;padding: 0px 5vw 10px;">\n        ${m.viewingOthersHLs?`<img class="dashboard_pn_photo" style="height:30px;width:30px;border-radius: 50%;margin-right: 8px;cursor: pointer;" src="${r}">`:`<a href="https://glasp.co/#/${a}" target="_blank"><img class="dashboard_pn_photo" style="height:30px;width:30px;border-radius: 50%;margin-right: 8px;cursor: pointer;" src="${r}"></a>`}\n        <div class="dashboard_pn_wrapper" id="dashboard_pn_wrapper" style="padding: 10px 14px;border-radius: 16px;background-color: #eceff0;width: 68vw;height: fit-content;min-height: 20px;border-radius: 20px;padding: 8px 14px;">\n            <div class="dashboard_pn_textarea" id="content_pagenote" style="outline: none;border: none;background-color: #eceff0;resize: none;padding: 0;height: fit-content;min-height: 20px;font-size: 13px;width: 100%;line-height: 20px;cursor: text;" placeholder="Leave your thoughts, findings, etc" contenteditable="false">${e?h(e.replace(/[<]/g,"&lt")).replace(/\n/g,"<br />"):""}</div>\n        </div>\n    </div>`;if(m.sidebar_iframe_doc.getElementById("page_note_action_btn_wrapper")&&m.sidebar_iframe_doc.getElementById("page_note_action_btn_wrapper").remove(),!t&&m.viewingOthersHLs||o.insertAdjacentHTML("beforeend",s),m.selectedUsersUID==m.uid||null==m.selectedUsersUID){const e=m.sidebar_iframe_doc.getElementById("content_pagenote");let t,o="",r=m.sidebar_iframe_doc.getElementById("page_note_save_btn");function a(e,t){t&&(r.innerText="Saving...");const o=i(),a={url:o.url,fullUrl:o.fullUrl,pagenote:e,title:n(),thumbnail:l()};chrome.runtime.sendMessage({action:"pagenote_store",data:a},(e=>{t&&"success"===e.result&&(r.innerText="Saved!",setTimeout((()=>{r.innerText="Save",r.style.display="none"}),1200))}))}e.addEventListener("paste",(i=>{!function(e,t){e.preventDefault();const i=e.clipboardData?(e.originalEvent||e).clipboardData.getData("text/plain"):window.clipboardData?window.clipboardData.getData("Text"):"",n=t.getSelection().getRangeAt(0);n.deleteContents();const o=t.createTextNode(i);n.insertNode(o),n.selectNodeContents(o),n.collapse(!1);const r=window.getSelection();r.removeAllRanges(),r.addRange(n)}(i,m.sidebar_iframe_doc),clearTimeout(t),t=setTimeout((()=>{const t=""==e.innerText.replace(/\s|\n/g,"")?"":e.innerText;o=t,a(t,!1)}),1e3)})),e.addEventListener("click",(function(t){t.target===t.currentTarget&&(e.setAttribute("contenteditable",!0),e.focus(),o=e.innerText,chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_page_note_focus"}))}),!1),e.addEventListener("blur",(function(t){""==e.innerText.replace(/\s|\n/g,"")&&(e.innerText=""),e.innerHTML=h(e.innerText.replace(/[<]/g,"&lt")).replace(/\n/g,"<br />"),e.setAttribute("contenteditable",!1)})),e.addEventListener("input",(function(i){r.style.display=e.innerText!==o?"block":"none",clearTimeout(t),t=setTimeout((()=>{const t=""==e.innerText.replace(/\s|\n/g,"")?"":e.innerText;o=t,a(t,!1)}),1e3)}),!1),r.addEventListener("click",(t=>{const i=""==e.innerText.replace(/\s|\n/g,"")?"":e.innerText;o=i,a(i,!0)}),!1)}}function Fe(e){Array.from(m.sidebar_iframe_doc.getElementsByClassName("readwise_export_message_wrapper")).forEach((e=>{e.remove()})),m.sidebar_iframe_doc.getElementById("highlight_export_readwise").insertAdjacentHTML("afterend",`\n    <div class="readwise_export_message_wrapper">\n        ${e?'<p style="color: red;margin: 0;margin-top: 4px;font-size: 13px;white-space: pre-wrap;">The access key is revoked or invalid...</p>':""}\n        <p style="margin: 0;margin-top: 8px;font-size: 13px;white-space: pre-wrap;">Please set your Readwise access token in your user <a href="https://glasp.co/settings" target="_blank" style="color: rgb(32, 159, 249);">setting page</a> on Glasp.</p>\n    </div>`),m.sidebar_iframe_doc.getElementById("highlight_export_readwise").disabled=!1}function Ue(e,t,i,n,o,r){let a=document.getElementById("glasp-sidebar-iframe").contentWindow.document;a.open(),a.write(e),a.close(),a.getElementById("signup_login_css").href=chrome.runtime.getURL("/iframe/signup_login.css"),function(e,t,i,n,o){if(n=e.getElementById("google-login"),i=e.getElementById("terms-of-service"),t=e.getElementById("privacy-policy"),n&&(n.addEventListener("click",(function(){o(),chrome.runtime.sendMessage({action:"google_signin"})})),i.addEventListener("click",(function(){window.open("https://www.glasp.co/terms-of-service","_blank")})),t.addEventListener("click",(function(){window.open("https://www.glasp.co/privacy-policy","_blank")}))),-1!==navigator.userAgent.indexOf("Safari")&&-1===navigator.userAgent.indexOf("Chrome")&&-1===navigator.userAgent.indexOf("Chromium")){let t=e.getElementById("social_login_wrapper"),i=t.parentNode;t.remove();const n=window.location.href;let o=document.createElement("div");o.style.position="relative",o.innerHTML=`\n        <a href="https://glasp.co/login?extension=yes&callback_url=${n}" target="_parent">log-in on glasp web site</a>\n        `,i.appendChild(o)}}(t,i,n,o,r)}function De(){m.sidebar_iframe.style.width="0px",m.sidebar_iframe.style.boxShadow="none",m.sidebarIsOpen=!1}function Re(){if(document.getElementsByClassName("glasp-ui-wrapper")){let e=document.getElementsByClassName("glasp-ui-wrapper");for(;e[0];)e[0].remove()}qe(),void 0!==m.uid&&x(m.photoURL,m.displayName,m.username)}function qe(){if(document.getElementsByClassName("glasp-ui-wrapper")){let e=document.getElementsByClassName("glasp-ui-wrapper");for(;e[0];)e[0].remove()}if(document.body.insertAdjacentElement("beforeend",m.iframeIndexEl),m.iframeIndexEl.appendChild(m.tooltip_iframe),m.iframeIndexEl.appendChild(m.sidebar_iframe),m.sidebar_iframe_doc=document.getElementById("glasp-sidebar-iframe").contentWindow.document,m.tooltip_iframe_doc=document.getElementById("glasp-tooltip-iframe").contentWindow.document,m.uid){if(!m.sidebarHTML)return void(function(){let e=!1;return m.excludedURL||($.get(chrome.runtime.getURL("./iframe/signup_login.html"),(function(e){m.sidebar_signup_login_HTML=e})),$.get(chrome.runtime.getURL("./iframe/sidebar.html"),(function(t){m.sidebarHTML=t,e=!!t})),$.get(chrome.runtime.getURL("./iframe/tooltip.html"),(function(e){m.tooltipHTML=e,m.tooltipEl=$(e)}))),e}()||setTimeout((()=>{Re()}),500));_()&&chrome.runtime.sendMessage({action:"user_signed_in"}),function(){m.tooltip_iframe_doc&&(m.tooltip_iframe_doc.innerHTML=""),m.tooltip_iframe_doc.open(),m.tooltip_iframe_doc.write(m.tooltipHTML),m.tooltip_iframe_doc.close(),m.tooltip_iframe_doc.getElementById("tooltip_css").href=chrome.runtime.getURL("/iframe/tooltip.css"),m.tooltip_iframe_doc.getElementById("tooltip_close_btn")&&m.tooltip_iframe_doc.getElementById("tooltip_close_btn").addEventListener("click",(()=>{g(),_()&&chrome.runtime.sendMessage({action:"amplitude_log",evtName:"tooltip_close_btn_clicked"})}));const e=m.tooltip_iframe_doc.getElementById("glasp_tooltip_container");if(null!=e){const n=e.querySelector(".highlighter-pink"),a=e.querySelector(".highlighter-yellow"),l=e.querySelector(".highlighter-green"),s=e.querySelector(".highlighter-blue");n.removeEventListener("click",B),n.addEventListener("click",B),a.removeEventListener("click",B),a.addEventListener("click",B),l.removeEventListener("click",B),l.addEventListener("click",B),s.removeEventListener("click",B),s.addEventListener("click",B);const d=m.tooltip_iframe_doc.getElementById("twitter_share");d.removeEventListener("click",t),d.addEventListener("click",t);const c=m.tooltip_iframe_doc.getElementById("tooltip_add_note");c.removeEventListener("click",o),c.addEventListener("click",o);const g=m.tooltip_iframe_doc.getElementById("tooltip_add_tag");g.removeEventListener("click",i),g.addEventListener("click",i);const h=m.tooltip_iframe_doc.getElementById("tooltip_copy_highlight_text");h.removeEventListener("click",r),h.addEventListener("click",r)}function t(){let e="";const t=window.getSelection();if(m.clickedHighlightId){const t=d();if(t.length>0)for(let i=0;i<t.length;i+=2)t[i]==m.clickedHighlightId&&(e=`"${t[i+1]}"`)}else e=`"${t.toString()}"`;const i=n();window.location.href,Ie({text:e,color:"#FFB6C6"},i,0,m.clickedHighlightId),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"tooltip_twitter_click"})}function i(){E()?window.location.reload():(_()&&chrome.runtime.sendMessage({action:"amplitude_log",evtName:"tooltip_add_tag_btn_clicked"}),m.sidebarIsOpen?m.sidebar_iframe_doc&&m.sidebar_iframe_doc.querySelector("#content_tag_icon")&&m.sidebar_iframe_doc.querySelector("#content_tag_icon").click():(Oe(),m.sidebar_iframe_doc&&m.sidebar_iframe_doc.getElementById("content_tag_icon")&&m.sidebar_iframe_doc.querySelector("#content_tag_icon").click()),g())}function o(){if(E())window.location.reload();else{if(_()&&chrome.runtime.sendMessage({action:"amplitude_log",evtName:"highlight_note_tooltip"}),m.highlightClicked)if(m.sidebarIsOpen){const e=y(m.clickedHighlightId,m.sidebar_iframe_doc);e.style.display="inline",e.click()}else{Oe();const e=y(m.clickedHighlightId,m.sidebar_iframe_doc);e.style.display="inline",e.click()}else m.addNoteBtnClicked=!0,we(window.getSelection(),m.lastSelectedColorId,m.tripleClicked);g()}}function r(){U(m.sidebar_iframe_doc.querySelectorAll(`[highlightid^="${m.clickedHighlightId}"]`)[0].firstElementChild.innerText),g(),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"highlight_copy_hl_text_tooltip"})}}(),function(){m.sidebar_iframe_doc.open(),m.sidebar_iframe_doc.write(m.sidebarHTML),m.sidebar_iframe_doc.close(),m.sidebar_iframe_doc.getElementById("sidebar_css").href=chrome.runtime.getURL("./iframe/sidebar.css");const e=m.sidebar_iframe_doc.getElementById("sidebar_share_btn"),t=m.sidebar_iframe_doc.getElementById("sidebar_copy_btn"),o=m.sidebar_iframe_doc.getElementById("share_btn_popup"),r=m.sidebar_iframe_doc.getElementById("share_btn_popup_close"),a=m.sidebar_iframe_doc.getElementById("share_link_copy_btn");m.sidebar_iframe_doc.getElementById("header_home_btn").addEventListener("click",(function(){chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_open_home"})}),!1),m.sidebar_iframe_doc.getElementById("user-photo-right-top-link").addEventListener("click",(function(){chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_open_mypage"})}),!1),m.currentUserListEl=m.sidebar_iframe_doc.getElementById("current_user_list"),m.usersListEl=m.sidebar_iframe_doc.getElementById("users_list"),m.userListEl=m.sidebar_iframe_doc.getElementById("user_list"),m.userListNum=m.sidebar_iframe_doc.getElementById("users_list_num"),m.sidebar_copy_all=m.sidebar_iframe_doc.getElementById("sidebar_copy_all"),m.sidebar_copy_all.addEventListener("click",(()=>{setTimeout((()=>{m.sidebar_copy_all.innerText="Copied!",setTimeout((()=>{m.sidebar_copy_all.innerText="Copy All"}),500)}),200)}),!1),m.sidebar_iframe_doc.getElementById("sidebar_close_btn")&&m.sidebar_iframe_doc.getElementById("sidebar_close_btn").addEventListener("click",(()=>{Oe(),_()&&chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_close_btn_clicked"})})),m.highlightsListEl=m.sidebar_iframe_doc.getElementById("highlights_list"),m.highlightEmptyEl=m.sidebar_iframe_doc.getElementById("highlights_list_empty"),m.sidebarSettingBtnEl=m.sidebar_iframe_doc.getElementById("sidebar_setting"),m.sidebarSettingPopupEl=m.sidebar_iframe_doc.getElementById("sidebar_setting_popup"),m.sidebarHighlighterToggleEl=$(m.sidebar_iframe_doc.getElementById("myonoffswitch")),m.sidebar_element=$($("#glasp-sidebar-iframe").contents()[0],window),m.twitterShareBtnEl=m.sidebar_iframe_doc.getElementById("twitter_share"),m.twitterShareBtnEl.addEventListener("click",(function(e){$e(e)}),!1),m.fbShareBtnEl=m.sidebar_iframe_doc.getElementById("fb_share"),m.fbShareBtnEl.addEventListener("click",(function(e){$e(e)}),!1),m.linkedInShareBtnEl=m.sidebar_iframe_doc.getElementById("linkedin_share"),m.linkedInShareBtnEl.addEventListener("click",(function(e){$e(e)}),!1),m.emailShareBtnEl=m.sidebar_iframe_doc.getElementById("email_share"),m.emailShareBtnEl.addEventListener("click",(function(e){$e(e)}),!1),m.sidebar_element.find("body").bind("mousedown",(function(e){$(e.target).closest(".sidebar_setting, .sidebar_setting_item, .sidebar_setting_footer").length||(m.sidebarSettingPopupEl.style.visibility="hidden"),$(e.target).closest(".share_btn_popup, .sidebar_share_btn").length||(o.style.visibility="hidden"),$(e.target).closest(".users_list, .current_user_list").length||(m.usersListEl.style.visibility="hidden")})),null!==m.sidebarHighlighterToggleEl&&void 0!==m.sidebarHighlighterToggleEl&&("off"===m.highlighterMode&&m.sidebarHighlighterToggleEl.prop("checked",!1),m.sidebarHighlighterToggleEl.on("click",(function(){null!=m.selectedUsersUID&&m.selectedUsersUID!=m.uid||($(this).is(":checked")?(m.highlighterMode="on",_()&&(Ae("remove",new URL(window.location.href).host),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_highlighter_onoff_toggle"}),chrome.runtime.sendMessage({action:"browser_icon_change",data:m.highlighterMode}))):(m.highlighterMode="off",g(),_()&&(Ae("add",new URL(window.location.href).host),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_highlighter_onoff_toggle"}),chrome.runtime.sendMessage({action:"browser_icon_change",data:m.highlighterMode}))))})));let l=m.sidebar_iframe_doc.getElementsByClassName("shortcut-hover");for(let e=0;e<l.length;e++)l[e].previousElementSibling.addEventListener("mouseenter",(function(){l[e].style.visibility="visible"}),!1),l[e].previousElementSibling.addEventListener("mouseleave",(function(){l[e].style.visibility="hidden"}),!1);He(m.userTagList),Se(m.userPagenote),null!=e&&(e.addEventListener("click",(()=>{o.style.visibility="visible"==o.style.visibility?"hidden":"visible",Array.from(m.sidebar_iframe_doc.getElementsByClassName("readwise_export_message_wrapper")).forEach((e=>{e.remove()})),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_share_popup"})})),r.addEventListener("click",(()=>{o.style.visibility="hidden",chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_share_close"})})),a.addEventListener("click",(()=>{a.innerHTML="Copied!";const e=i().fullUrl;setTimeout((function(){a.innerHTML="Copy Link"}),500),m.docId?(U(""==m.docId?`https://glasp.co/#/${m.username}`:`https://share.glasp.co/${m.username}/?p=${m.docId}`),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_share_copy_link"})):chrome.runtime.sendMessage({action:"get_highlight_doc_id",data:{fullURL:e}},(e=>{const t=e.result;U(""==t?`https://glasp.co/#/${m.username}`:`https://share.glasp.co/${m.username}/?p=${t}`),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_share_copy_link"})}))})),m.sidebar_iframe_doc.getElementById("highlight_export_readwise").addEventListener("click",(()=>{m.sidebar_iframe_doc.getElementById("highlight_export_readwise").disabled=!0,chrome.runtime.sendMessage({action:"get_readwise_api_key"},(e=>{const t=e.result;t&&""!=t||Fe(),t&&""!==t&&function(e){const t=[],o=n(),r=i().fullUrl,a=m.loadedHighlights;if(!a||0==a.length)return Array.from(m.sidebar_iframe_doc.getElementsByClassName("readwise_export_message_wrapper")).forEach((e=>{e.remove()})),m.sidebar_iframe_doc.getElementById("highlight_export_readwise").insertAdjacentHTML("afterend",'\n        <div class="readwise_export_message_wrapper"><p style="color: red;margin: 0;margin-top: 4px;font-size: 13px;white-space: pre-wrap;">You need to have at least one highlight to export.</p></div>'),void(m.sidebar_iframe_doc.getElementById("highlight_export_readwise").disabled=!1);Array.from(a).forEach((e=>{if(""==e.string.replace(/\s+/g,""))return;const i={};i.title=o,i.source_url=r,i.source_type="glasp_web",i.category="articles",""!==e.string.replace(/\s+/g,"")&&(i.text=e.string),e.note&&""!==e.note.replace(/\s+/g,"")&&(i.note=e.note),t.push(i)})),$.ajax({url:"https://readwise.io/api/v2/highlights/",type:"POST",contentType:"application/json",beforeSend:function(t){t.setRequestHeader("Authorization",`Token ${e}`)},data:JSON.stringify({highlights:t}),success:function(e){const t=e[0].highlights_url;m.sidebar_iframe_doc.getElementById("highlight_export_readwise_p").innerHTML=`Exported! View on <a href="${t}" target="_blank">Readwise</a>`},error:function(e){Fe(!0)}})}(t)}))}))),t&&t.addEventListener("click",D,!1),null!==m.currentUserListEl&&void 0!==m.currentUserListEl&&m.currentUserListEl.addEventListener("click",I),null!==m.sidebarSettingBtnEl&&void 0!==m.sidebarSettingBtnEl&&(m.sidebar_iframe_doc.getElementById("user_photo_setting").src=m.photoURL,m.sidebarSettingBtnEl.addEventListener("click",C,!1),m.sidebar_iframe_doc.getElementById("sidebar_signout").addEventListener("click",M,!1),m.sidebar_iframe_doc.getElementById("sidebar_bug_report").addEventListener("click",N,!1),m.sidebar_iframe_doc.getElementById("sidebar_tutorial").addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_setting_tutorial_video"}),window.open("https://www.youtube.com/watch?v=Pj1r_RMPadI","_blank")}),!1),m.sidebar_iframe_doc.getElementById("sidebar_faq").addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_setting_faq"}),window.open("https://glasp.notion.site/Glasp-FAQs-ddb9cb747ddd4811ad155dc96a081b7a","_blank")}),!1),m.sidebar_iframe_doc.getElementById("sidebar_slack_join").addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_setting_slack_join"}),window.open("https://join.slack.com/t/glasp-community/shared_invite/zt-1fe5yiaqb-EVYli9ReIICsPSMYb~styg","_blank")}),!1),m.sidebar_iframe_doc.getElementById("sidebar_explore_content").addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_setting_explore_content"}),window.open("https://glasp.co/explore/","_blank")}),!1),m.sidebar_iframe_doc.getElementById("sidebar_talk_to_founders").addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_setting_talk_to_founders"});const e=Math.floor(2*Math.random());window.open(["https://calendly.com/kazuki_/15min","https://calendly.com/kei_glasp/15min"][e],"_blank")}),!1),m.sidebar_iframe_doc.getElementById("sidebar_user_icon_setting").addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_setting_see_my_highlights"}),window.open(`https://glasp.co/#/${m.username}`,"_blank")}),!1)),m.sidebar_iframe_doc.getElementById("enable_domain_name").innerHTML=new URL(window.location.href).host}(),ze(d(m.sidebar_iframe_doc,m.sidebar_copy_all,m.highlightEmptyEl,m.loadedHighlights))}else _()&&(chrome.runtime.sendMessage({action:"run_initApp"}),chrome.runtime.sendMessage({action:"user_not_signed_in"})),Ue(m.sidebar_signup_login_HTML,m.sidebar_iframe_doc,m.sidebarPPBtnEl,m.sidebarToSBtnEl,m.sidebarLoginBtnEl,De)}function Oe(e){if(0==m.sidebarIsOpen){$(m.sidebar_iframe).attr("style",`visibility: visible !important; width: ${m.sidebarWidth}; box-shadow: rgba(200, 200, 200, 0.5) 0px 0px 7px 2px; min-width: 0px !important; max-width: 300px; height: 100%; background: #FFFFFF; resize: horizontal; direction: rtl; margin: auto; position: fixed; top: 0px; right: 0px; left: auto; z-index: 9000000000000000000;background-image: url("https://storage.googleapis.com/glasp.co/src/img/loading_200.gif");background-repeat: no-repeat;background-position: center;background-size: 40px;`),m.sidebarIsOpen=!0;const e=w(m.sidebar_iframe);null!=m.uid&&null!=m.uid||(_()&&chrome.runtime.sendMessage({action:"run_initApp"}),e&&qe()),e||Re(),_()&&(chrome.runtime.sendMessage({action:"sidebar_status_change",data:[m.sidebarIsOpen,m.sidebarWidth]}),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_toggle_open_success"}))}else{m.sidebarWidth=m.sidebar_iframe.style.width,$(m.sidebar_iframe).attr("style",'visibility: hidden !important; min-width: 0px !important; max-width: 300px; height: 100%; background: #FFFFFF; resize: horizontal; direction: rtl; margin: auto; position: fixed; top: 0px; right: 0px; left: auto; z-index: 9000000000000000000;background-image: url("https://storage.googleapis.com/glasp.co/src/img/loading_200.gif");background-repeat: no-repeat;background-position: center;background-size: 40px;'),m.sidebarIsOpen=!1;const e=w(m.sidebar_iframe);null!==m.uid&&void 0!==m.uid||(_()&&chrome.runtime.sendMessage({action:"run_initApp"}),Ue(m.sidebar_signup_login_HTML,m.sidebar_iframe_doc,m.sidebarPPBtnEl,m.sidebarToSBtnEl,m.sidebarLoginBtnEl,De)),e||Re(),_()&&(chrome.runtime.sendMessage({action:"sidebar_status_change",data:[m.sidebarIsOpen,m.sidebarWidth]}),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_toggle_close_success"}))}}function ze(e,t){if(m.sidebar_iframe_doc.getElementById("highlights_list")&&(m.highlightsListEl=m.sidebar_iframe_doc.getElementById("highlights_list"),m.highlightsListEl.innerHTML=""),null!=m.loadedHighlights&&null!=m.loadedHighlights&&(0!=m.loadedHighlights.length||void 0===m.highlightsListEl)){if(0!==m.loadedHighlights.length)if("orderId"in m.loadedHighlights[0])m.loadedHighlights.sort(((e,t)=>e.orderId<t.orderId?-1:1));else if(e.length/2==m.loadedHighlights.length){for(let t=0;t<e.length;t+=2)for(let i=0;i<m.loadedHighlights.length;i++)if(m.loadedHighlights[i].highlightid==e[t]){let e=t/2;m.loadedHighlights[i].orderId=e;break}m.loadedHighlights.sort(((e,t)=>e.orderId<t.orderId?-1:1))}if(void 0!==m.highlightsListEl&&null!==m.highlightsListEl){let e;for(let t=0;t<m.loadedHighlights.length;t++){const o=m.loadedHighlights[t].highlightid,r=m.loadedHighlights[t].colorId;let a=!1,l="";"note"in m.loadedHighlights[t]&&m.loadedHighlights[t].note.length>0&&(l=m.loadedHighlights[t].note,a=!0);let s=document.createElement("div");s.setAttribute("class","highlight-wrapper"),s.setAttribute("highlightid",o),s.setAttribute("data-colorid",r),s.setAttribute("tabindex",t),s.setAttribute("style","width: 80vw;margin: auto;margin-bottom: 10px;padding: 10px 14px;background-color: #FFFFFF;text-align: left;border: solid 1px rgba(0,0,0,0.15)!important;box-shadow: rgb(0 0 0 / 15%) 0px 1px 3px;border-radius: 4px !important;position: relative;"),void 0!==m.selectedUsersUID&&m.selectedUsersUID!==m.uid?s.innerHTML=`\n                <div class="text_wrapper" style="border-left-color: ${r};margin: auto;border-left-style: solid;border-left-width: 6px;">\n                    <p style="margin: 0px;font-size: 14px;padding-left: 10px;">${m.loadedHighlights[t].string.replaceAll("\n","<br>")}</p>\n                </div>\n                <div class="note_separator" id="note_separator" style="display: none;border-bottom: 0.5px solid #D6D6D6;margin-top: 10px;user-select: none;"></div>\n                <div class="highlight_note_div" id="highlight_note_div" style="display: none;width: 100%;max-width: 230px;height: auto;margin: 10px 2vw 1vw 2vw;text-align: center;overflow: hidden;">\n                    <div class="highlight_note_title" style="font-size: 15px;line-height: 17px;font-weight: bold;width: 100%;text-align: left;">Note: </div>\n                    <div class="note_content" style="width: 100%;font-size: 14px;line-height: 18px;margin-top: 6px;">\n                        <div class="highlight_note_textarea" id="highlight_note_textarea" placeholder="Add a note..." tabindex="${t}" type="text" style="height: 24px; border: none;">${l}</div>\n                    </div>\n                </div>`:s.innerHTML=`\n                <div class="text_wrapper" style="border-left-color: ${r};margin: auto;border-left-style: solid;border-left-width: 6px;">\n                    <p style="margin: 0px;font-size: 14px;padding-left: 10px;">${m.loadedHighlights[t].string.replaceAll("\n","<br>")}</p>\n                </div>\n                <div class="highlight_note_add_btn" id="highlight_note_add_btn" style="display: none;width: 27px;height: 27px;float: right;position: relative !important;right: -14px;bottom: 17.5px;outline: none;user-select: none;" tabindex="${t}" >\n                    <svg width="27" height="27" viewBox="0 0 29 29" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M1 29H2H15.75H26C27.6569 29 29 27.6569 29 26V15.5V1L1 29Z" fill="#E4E4E4"/>\n                        <path d="M15 25.5L15.5 22L23.5 14L26.5 17L18.5 25L15 25.5Z" fill="#E4E4E4"/>\n                        <path d="M15.5 22L15 25.5L18.5 25M15.5 22L23.5 14L26.5 17L18.5 25M15.5 22L18.5 25" stroke="#838383" stroke-linecap="round" stroke-linejoin="round"/>\n                        <line x1="0.964645" y1="28.9646" x2="28.9646" y2="0.964645" stroke="#A2A2A2" stroke-width="0.1"/>\n                    </svg>\n                </div>\n                <span class="highlight_note_add_btn_hover" id="highlight_note_add_btn_hover" style="visibility: hidden;font-size: 10px;width: 52px;display: block;float: right;background-color: #353535;color: #ffffff;text-align: center;border-radius: 3px;padding: 5px 0;position: absolute;bottom: -25px;right: -13px;z-index: 1;user-select: none;">Add Note</span>\n                <div class="note_separator" id="note_separator" style="display: none;border-bottom: 0.5px solid #D6D6D6;margin-top: 10px;user-select: none;"></div>\n                <div class="highlight_note_div" id="highlight_note_div" style="display: none;width: 100%;max-width: 230px;height: auto;margin: 10px 2vw 1vw 2vw;text-align: center;overflow: hidden;">\n                    <div class="highlight_note_title" style="font-size: 15px;line-height: 17px;font-weight: bold;width: 100%;text-align: left;">Note: </div>\n                    <div class="note_content" style="width: 100%;font-size: 14px;line-height: 18px;margin-top: 6px;">\n                        <textarea class="highlight_note_textarea highlight_note_textarea_hover" id="highlight_note_textarea" placeholder="Add a note..." tabindex="${t}" type="text" style="height:24px;width:224px;border: none;outline: none;font-size: 14px;line-height: 20px;resize: none;text-align: left;background-color: transparent;font-family:'Roboto',sans-serif;padding: 2px;">${l}</textarea>\n                    </div>\n                </div>\n                <div class="highlight_note_footer" id="highlight_note_footer" style="display: none;justify-content: space-between;align-items: center;width: 92%;height: 0px;margin: auto;">\n                    <div class="highlight_note_footer_guide" style="color: gray;font-size: 9px;height: 9px;float: left;position: relative;bottom: -2px;">Shift + Enter for Newline</div>\n                </div>\n                <div class="highlight_note_saving" id="highlight_note_saving" style="display: none;height: 9px;font-size: 9px;float: right;position: relative !important;right: 7px;bottom: 2px;color: gray;user-select: none;">saving...</div>`,m.highlightsListEl.appendChild(s);let d=m.sidebar_iframe_doc.getElementsByClassName("text_wrapper")[t],c=m.sidebar_iframe_doc.getElementsByClassName("note_separator")[t],h=m.sidebar_iframe_doc.getElementsByClassName("highlight_note_div")[t],p=m.sidebar_iframe_doc.getElementsByClassName("highlight_note_textarea")[t];if(p.style.height=p.scrollHeight-4+"px",a&&(c.style.display="block",h.style.display="block"),d.addEventListener("click",(e=>{if(void 0!==o){const e=document.querySelector(`[highlightid="${o}"]`);e&&(g(),e.scrollIntoView({behavior:"smooth",block:"center"}),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_highlight_scroll"}))}})),document.getElementById("glasp-sidebar-iframe")&&(m.sidebar_iframe=document.getElementById("glasp-sidebar-iframe"),m.sidebar_iframe.contentWindow.document.addEventListener("resize",(function(){p.style.height="20px",p.style.height=p.scrollHeight-4+"px"}))),null==m.selectedUsersUID||m.selectedUsersUID==m.uid){let r,l=m.sidebar_iframe_doc.getElementsByClassName("highlight_note_add_btn")[t],u=m.sidebar_iframe_doc.getElementsByClassName("highlight_note_add_btn_hover")[t],f=(m.sidebar_iframe_doc.getElementsByClassName("highlight_note_saving")[t],m.sidebar_iframe_doc.getElementsByClassName("highlight_note_footer")[t]);p.style.height="20px",p.addEventListener("focus",(function(e){if(f.style.display="flex",p.style.height="20px",p.style.height=p.scrollHeight-4+"px",m.sidebarIsOpen){const t=e.target.getAttribute("tabindex");m.sidebar_iframe_doc.getElementsByClassName("highlight-wrapper").length-1==t&&b()}}),!1),d.addEventListener("dblclick",(e=>{a=!0,l.style.display="none",c.style.display="block",h.style.display="block",p.focus();const t=e.target.getAttribute("tabindex");m.sidebar_iframe_doc.getElementsByClassName("highlight-wrapper").length-1==t&&b()})),s.addEventListener("mouseenter",(e=>{a||(l.style.display="inline"),m.sidebar_iframe_doc.getElementById("highlight_menu_bg_wrapper")&&m.sidebar_iframe_doc.getElementById("highlight_menu_bg_wrapper").remove(),d.insertAdjacentHTML("afterend",'\n                    <div class="highlight_menu_bg_wrapper" id="highlight_menu_bg_wrapper" style="width: 0px;height: 0px;position: absolute;right: 9%;top: 0%;">\n                        <div class="highlight_text_menu" id="highlight_text_menu" style="width: 18px;height: 18px;position: relative;left: 4px;">\n                            <svg width="13" height="13" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">\n                                <mask id="path-1-inside-1_2296_2116" fill="white">\n                                <ellipse cx="2.33127" cy="6.99992" rx="1.4" ry="1.4" transform="rotate(-90 2.33127 6.99992)"/>\n                                </mask>\n                                <ellipse cx="2.33127" cy="6.99992" rx="1.4" ry="1.4" transform="rotate(-90 2.33127 6.99992)" fill="#828282"/>\n                                <path d="M2.33127 7.09992C2.27604 7.09992 2.23127 7.05515 2.23127 6.99992H5.23127C5.23127 5.3983 3.9329 4.09992 2.33127 4.09992V7.09992ZM2.23127 6.99992C2.23127 6.9447 2.27604 6.89993 2.33127 6.89993V9.89993C3.9329 9.89993 5.23127 8.60155 5.23127 6.99992H2.23127ZM2.33127 6.89993C2.3865 6.89993 2.43127 6.9447 2.43127 6.99992H-0.568726C-0.568726 8.60155 0.729647 9.89993 2.33127 9.89993V6.89993ZM2.43127 6.99992C2.43127 7.05515 2.3865 7.09992 2.33127 7.09992V4.09992C0.729647 4.09992 -0.568726 5.3983 -0.568726 6.99992H2.43127Z" fill="#828282" mask="url(#path-1-inside-1_2296_2116)"/>\n                                <mask id="path-3-inside-2_2296_2116" fill="white">\n                                <ellipse cx="6.99827" cy="6.99992" rx="1.4" ry="1.4" transform="rotate(-90 6.99827 6.99992)"/>\n                                </mask>\n                                <ellipse cx="6.99827" cy="6.99992" rx="1.4" ry="1.4" transform="rotate(-90 6.99827 6.99992)" fill="#828282"/>\n                                <path d="M6.99827 7.09992C6.94304 7.09992 6.89827 7.05515 6.89827 6.99992H9.89827C9.89827 5.3983 8.59989 4.09992 6.99827 4.09992V7.09992ZM6.89827 6.99992C6.89827 6.9447 6.94304 6.89993 6.99827 6.89993V9.89993C8.59989 9.89993 9.89827 8.60155 9.89827 6.99992H6.89827ZM6.99827 6.89993C7.0535 6.89993 7.09827 6.9447 7.09827 6.99992H4.09827C4.09827 8.60155 5.39664 9.89993 6.99827 9.89993V6.89993ZM7.09827 6.99992C7.09827 7.05515 7.0535 7.09992 6.99827 7.09992V4.09992C5.39664 4.09992 4.09827 5.3983 4.09827 6.99992H7.09827Z" fill="#828282" mask="url(#path-3-inside-2_2296_2116)"/>\n                                <mask id="path-5-inside-3_2296_2116" fill="white">\n                                <ellipse cx="11.665" cy="6.99992" rx="1.4" ry="1.4" transform="rotate(-90 11.665 6.99992)"/>\n                                </mask>\n                                <ellipse cx="11.665" cy="6.99992" rx="1.4" ry="1.4" transform="rotate(-90 11.665 6.99992)" fill="#828282"/>\n                                <path d="M11.665 7.09992C11.6098 7.09992 11.565 7.05515 11.565 6.99992H14.565C14.565 5.3983 13.2666 4.09992 11.665 4.09992V7.09992ZM11.565 6.99992C11.565 6.9447 11.6098 6.89993 11.665 6.89993V9.89993C13.2666 9.89993 14.565 8.60155 14.565 6.99992H11.565ZM11.665 6.89993C11.7202 6.89993 11.765 6.9447 11.765 6.99992H8.76501C8.76501 8.60155 10.0634 9.89993 11.665 9.89993V6.89993ZM11.765 6.99992C11.765 7.05515 11.7202 7.09992 11.665 7.09992V4.09992C10.0634 4.09992 8.76501 5.3983 8.76501 6.99992H11.765Z" fill="#828282" mask="url(#path-5-inside-3_2296_2116)"/>\n                            </svg>\n                        </div>\n                    </div>');const t=m.sidebar_iframe_doc.getElementsByClassName("highlight_text_menu")[0];t.addEventListener("click",(e=>{if(m.sidebar_iframe_doc.getElementById("highlight_menu_wrapper"))return void m.sidebar_iframe_doc.getElementById("highlight_menu_wrapper").remove();const i=document.createElement("div");i.style.position="relative",i.setAttribute("class","highlight_menu_div"),i.setAttribute("id","highlight_menu_div"),i.innerHTML='\n                        <div class="highlight_menu_wrapper" id="highlight_menu_wrapper">\n                            <div class="highlight_menu_options" id="highlight_add_note">✍️ Add a Note</div>\n                            <div class="highlight_menu_options" id="highlight_share_highlight">🖼️ Create Highlight Image</div>\n                            <div class="highlight_menu_options" id="highlight_copy_highlight">📋 Copy Highlight Text</div>\n                            <div class="highlight_menu_options" id="highlight_copy_link">🔗 Copy Link to Highlight</div>\n                            <div class="highlight_menu_options" id="highlight_delete" style="color:#F93F3F;">🗑️ Delete Highlight</div>\n                        </div>',t.insertAdjacentElement("afterend",i);const r=m.sidebar_iframe_doc.getElementById("highlight_menu_wrapper");m.sidebar_iframe_doc.getElementById("highlight_add_note").addEventListener("click",(e=>{if(a=!0,l.style.display="none",c.style.display="block",h.style.display="block",f.style.display="flex",p.focus(),m.sidebarIsOpen){const t=e.target.getAttribute("tabindex");m.sidebar_iframe_doc.getElementsByClassName("highlight-wrapper").length-1==t&&b(),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_highlight_add_note"})}r.remove()})),m.sidebar_iframe_doc.getElementById("highlight_share_highlight").addEventListener("click",(function(){const e={text:"",color:""},t=m.sidebar_iframe_doc.querySelectorAll(`[highlightid^="${o}"]`)[0],i=t.firstElementChild.innerText;e.text=i,e.color=t.getAttribute("data-colorid");const r=n();window.location.origin,window.location.pathname,window.getSelection()?.removeAllRanges(),g(),Ie(e,r),Oe()}),!1),m.sidebar_iframe_doc.getElementById("highlight_copy_highlight").addEventListener("click",(function(){U(m.sidebar_iframe_doc.querySelectorAll(`[highlightid^="${o}"]`)[0].firstElementChild.innerText),r.remove(),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_highlight_copy"})}),!1),m.sidebar_iframe_doc.getElementById("highlight_copy_link").addEventListener("click",(function(){window.location.origin,window.location.pathname,U(R(0,m.sidebar_iframe_doc.querySelectorAll(`[highlightid^="${o}"]`)[0].firstElementChild.innerText)),r.remove(),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_highlight_copy_link_to_hl"})}),!1),m.sidebar_iframe_doc.getElementById("highlight_delete").addEventListener("click",(function(){T(o),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_highlight_delete"})}),!1),r.addEventListener("mouseleave",(()=>{r.remove()}),!1)}))})),s.addEventListener("mouseleave",(e=>{if(l.style.display="none",m.sidebar_iframe_doc.getElementsByClassName("highlight_menu_bg_wrapper")){let e=m.sidebar_iframe_doc.getElementsByClassName("highlight_menu_bg_wrapper");for(;e[0];)e[0].remove()}})),p.addEventListener("input",(function(e){if(p.style.height="20px",p.style.height=p.scrollHeight-4+"px",m.sidebarIsOpen){const t=e.target.getAttribute("tabindex");m.sidebar_iframe_doc.getElementsByClassName("highlight-wrapper").length-1==t&&b()}})),p.addEventListener("keydown",(t=>{if(clearTimeout(e),e=setTimeout((()=>{const e=i(),n=e.url,r=e.fullUrl,a=t.target.value;_()&&chrome.runtime.sendMessage({action:"highlight_note_added",data:[o,a,n,r]},(e=>{e&&e.result}))}),500),13==t.keyCode){if(t.shiftKey)return;p.blur()}})),l.addEventListener("click",(e=>{if(a=!0,l.style.display="none",c.style.display="block",h.style.display="block",f.style.display="flex",p.focus(),m.sidebarIsOpen){const t=e.target.getAttribute("tabindex");m.sidebar_iframe_doc.getElementsByClassName("highlight-wrapper").length-1==t&&b()}})),l.addEventListener("mouseenter",(e=>{u.style.visibility="visible"})),l.addEventListener("mouseleave",(e=>{u.style.visibility="hidden"})),p.addEventListener("focus",(e=>{r=e.target.value,p.style.outline="thin solid #BCBCBC"})),p.addEventListener("blur",(e=>{p.style.outline="none",f.style.display="none"}))}}if(m.addNoteBtnClicked)if(m.sidebarIsOpen){const e=y(m.addedHighlightId,m.sidebar_iframe_doc);e.style.display="inline",e.click()}else{Oe();const e=y(m.addedHighlightId,m.sidebar_iframe_doc);e.style.display="inline",e.click()}let o=m.sidebar_iframe_doc.getElementsByClassName("highlight_note_textarea");for(let e=0;e<o.length;e++)o[e].style.height=o[e].scrollHeight+"px";if(m.addNoteBtnClicked){m.addNoteBtnClicked=!1;const e=m.sidebar_iframe_doc.querySelector(`[highlightid="${m.addedHighlightId}"]`).getAttribute("tabindex");m.sidebar_iframe_doc.getElementsByClassName("highlight_note_textarea")[e].style.height="20px"}if(m.sidebar_copy_all.removeEventListener("click",r),m.sidebar_copy_all.addEventListener("click",r),t){let e;"store"==m.actionType?(e=m.sidebar_iframe_doc.querySelector(`[highlightid="${m.addedHighlightId}"]`),e.scrollIntoView({behavior:"smooth",block:"center"}),e.style.backgroundColor="#EEEEEE",setTimeout((function(){e.style.backgroundColor="#FAFAFA"}),500)):"delete"==m.actionType?e=m.sidebar_iframe_doc.getElementsByClassName("highlight-wrapper")[m.deletedHighlightTabindex]:"color_change"==m.actionType&&(e=m.sidebar_iframe_doc.querySelector(`[highlightid="${m.addedHighlightId}"]`),e.style.backgroundColor="#EEEEEE",setTimeout((function(){e.style.backgroundColor="#FAFAFA"}),500))}function r(){D(),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"sidebar_copy_all_click"})}}}}let je="";function Pe(e){if(document.getElementsByClassName("glasp_profile_on_twitter_wrapper").length>0){if(je==window.location.pathname.split("/")[1])return;Array.from(document.getElementsByClassName("glasp_profile_on_twitter_wrapper")).forEach((e=>{e.remove()}))}setTimeout((()=>{if(document.querySelectorAll('[aria-label="Profile timelines"]').length>0){const e=document.getElementsByClassName("glasp_profile_on_twitter_wrapper").length>0,t=window.location.pathname.split("/")[1];if(je==t&&e)return;je=t,chrome.runtime.sendMessage({action:"twitter_profile_exist",data:t},(e=>{if("account_found"===e.result){const t=e.data,i=document.querySelectorAll('[aria-label="Profile timelines"]')[0].previousElementSibling,n=document.querySelectorAll('[alt="Opens profile photo"]')[0].getAttribute("src"),o="reserved"==t.userVerification?`https://glasp.co/explore/?author=${t.userUsername}`:`https://glasp.co/#/${t.userUsername}`,r=""==t.userBio?`View ${t.userDisplayName}'s Glasp page`:t.userBio,a="verified"!==t.userVerification?"":'<svg width="18" height="18" style="margin-left: 4px;" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">\n                                <circle cx="13" cy="13" r="11" fill="#2A80FF"/>\n                                <circle cx="13" cy="5" r="5" fill="#2A80FF"/>\n                                <circle cx="13" cy="21" r="5" fill="#2A80FF"/>\n                                <circle cx="21" cy="13" r="5" fill="#2A80FF"/>\n                                <circle cx="7" cy="7" r="5" fill="#2A80FF"/>\n                                <circle cx="19" cy="7" r="5" fill="#2A80FF"/>\n                                <circle cx="19" cy="19" r="5" fill="#2A80FF"/>\n                                <circle cx="7" cy="19" r="5" fill="#2A80FF"/>\n                                <circle cx="5" cy="13" r="5" fill="#2A80FF"/>\n                                <path d="M8 13L11.6364 17L18 10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                            </svg>',l=t.userTopics&&0!==t.userTopics.length?`<div style='font-size: 13px;color: #536471;font-weight: normal;margin-top: 24px;text-align: left;overflow: hidden;white-space: break-spaces;text-overflow: ellipsis;display: -webkit-box;-webkit-line-clamp: 1;-webkit-box-orient: vertical;font-family: TwitterChirp, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;'>Learns ${Array.from(t.userTopics.slice(0,5)).map((e=>`#${e}`)).join(" ")}</div>`:"";i.insertAdjacentHTML("beforeend",`\n                    <div style="padding: 0 16px;" class="glasp_profile_on_twitter_wrapper">\n                        <div style="margin: 8px 16px;">\n                            <div style="margin: 0 8px 8px;">\n                                <div style='font-size: 15px;color: rgb(15, 20, 25);font-family: TwitterChirp, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;line-height: 20px;font-weight: bold;'>Glasp Profile</div>\n                            </div>\n                            <a href="${o}" target="_blank" style="display: block;box-shadow: rgb(0 0 0 / 10%) 0px 2px 13px 0px;cursor: pointer;background-color: rgba(255,255,255,1.00);border-radius: 16px;overflow: hidden;text-decoration: none;">\n                                <div style="padding:4px;">\n                                    <div style="display:flex;justtify-content:left;">\n                                        <img src="${n}" style="width:94px;height:94px;border-radius: 12px;">\n                                        <div style="padding:8px 12px;">\n                                            <div style="display:flex;justtify-content:left;align-items: center;">\n                                                <div style='height:20px;font-family: TwitterChirp, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;font-size: 15px;font-weight:bold;color:#0F1419;'>${t.userDisplayName}</div>\n                                                ${a}\n                                            </div>\n                                            <div style='font-family: TwitterChirp, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;color: rgba(0,0,0,1.00);font-size: 15px;color:#536471;'>${r}</div>\n                                            ${l}\n                                        </div>\n                                    </div>\n                                </div>\n                                <div style="border-bottom: 1px solid rgb(239, 243, 244);"></div>\n                                <div style='font-family: TwitterChirp, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;color: rgb(120, 86, 255);font-size: 15px;font-weight: bold;height:51px;margin:auto;text-align:center;display: flex;justify-content: center;align-items: center;'>View profile on Glasp</div>\n                            </a>\n                        </div>\n                    </div>`)}}))}}),e)}function Ve(e){let t="";t+=`# ${e.title}\n\n`,t+=""==e.thumbnail?"":`![](${e.thumbnail})\n\n`,t+="### Metadata\n\n",t+=`- Title: ${e.title}\n`,t+=`- Author: ${e.author}\n`,t+=`- Book URL: ${e.fullUrl}\n`,t+=`- Open in Kindle: [kindle://book/?action=open&asin=${e.id}](kindle://book/?action=open&asin=${e.id})\n`,t+=`- Last Updated on: ${e.lastUpdatedDate}\n\n`,t+="### Highlights & Notes\n\n";for(let i=0;i<e.highlights.length;i++){const n=e.highlights[i];t+=`- ${n.string.replace(/\n/g," ")}\n`,t+=""!==n.note?`  - Note: ${n.note}\n`:""}return t+="\n\n",t}function Ze(){const e=[];document.getElementsByClassName("glasp_kindle_integ_popup").length>0&&Array.from(document.getElementsByClassName("glasp_kindle_integ_popup")).forEach((e=>{e.remove()})),document.body.insertAdjacentHTML("beforeend",'\n    <div class="glasp_kindle_integ_popup" style="position: fixed;top: 8%;right: 1%;box-shadow: rgb(0 0 0 / 30%) 0px 2px 6px;background-color: #FFFFFF;border-radius: 30px;text-align: center;margin: 0 10px 20px;display: inline-block;font-family: \'Roboto\',sans-serif !important;z-index: 10;padding: 10px 16px;user-select: none;">\n        <div id="glasp_kindle_import_top_wrapper" style="display: flex;justify-content: left;align-items: center;position: relative;gap:8px;">\n            <div>\n                <svg width="28" height="28" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">\n                <path d="M3.73666 72.9828C-1.17604 68.0756 -1.17605 60.1196 3.73658 55.2124L44.259 14.7353L64.026 34.4803L14.6085 83.8424L3.73666 72.9828Z" fill="#FF4E74"/>\n                <path d="M93.6763 64.0979L44.2592 14.7355L55.131 3.8758C60.0437 -1.03135 68.0087 -1.03136 72.9213 3.8758L113.444 44.353L93.6763 64.0979Z" fill="#FFF85E"/>\n                <path d="M64.0262 93.7147L113.444 44.3527L124.315 55.2124C129.228 60.1196 129.228 68.0756 124.315 72.9828L83.7929 113.46L64.0262 93.7147Z" fill="#76FF54"/>\n                <path d="M72.9212 124.32C68.0086 129.227 60.0436 129.227 55.1309 124.32L14.6085 83.8424L34.3755 64.0977L83.7928 113.46L72.9212 124.32Z" fill="#5C94FF"/>\n                </svg>\n            </div>\n            <div><a id="glasp_kindle_copy_highlights">Copy Highlights</a> or <a id="glasp_kindle_select_books">Select Books</a></div>\n        </div>\n        <div id="glasp_kindle_import_back" style="display:none;cursor: pointer;"><a>< Back to Menu</a></div>\n        <div id="glasp_kindle_import_container"></div>\n    </div>'),document.getElementById("glasp_kindle_copy_highlights")&&document.getElementById("glasp_kindle_copy_highlights").addEventListener("click",(()=>{U(Ve(We())),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"glasp_kindle_copy_highlights"})})),document.getElementById("glasp_kindle_import_back")&&document.getElementById("glasp_kindle_import_back").addEventListener("click",(()=>{document.getElementById("glasp_kindle_import_back").style.display="none",document.getElementById("glasp_kindle_import_top_wrapper").style.display="flex",document.getElementById("glasp_kindle_import_container").innerHTML="",chrome.runtime.sendMessage({action:"amplitude_log",evtName:"glasp_kindle_import_back"})})),document.getElementById("glasp_kindle_select_books")&&document.getElementById("glasp_kindle_select_books").addEventListener("click",(()=>{document.getElementById("glasp_kindle_import_back").style.display="block",document.getElementById("glasp_kindle_import_top_wrapper").style.display="none",document.getElementById("glasp_kindle_import_container").innerHTML="",chrome.runtime.sendMessage({action:"amplitude_log",evtName:"glasp_kindle_select_books"});const t=function(){const e=[];return Array.from(document.querySelector("#kp-notebook-library").querySelectorAll(".a-row .kp-notebook-library-each-book")).forEach((t=>{const i=t.getAttribute("id"),n=t.querySelector("h2").innerText,o=t.querySelector("img").src;e.push({id:i,title:n,thumbnailSmall:o})})),e}();document.getElementById("glasp_kindle_import_container").insertAdjacentHTML("beforeend",`\n            <div style="padding: 8px 0;">\n                <div style="display: flex;justify-content: left;align-items: center;position: relative;gap:8px;padding: 8px 0;">\n                    <div>${t.length} Books</div>\n                    <button id="glasp_kindle_books_select_all" style="padding: 8px 10px;line-height: 1em;font-size: 13px;border: 1px solid rgba(0,0,0,0.2);border-radius: 20px;cursor: pointer;outline: none;background-color: #EEEEEE;">Select All</button>\n                    <button id="glasp_kindle_books_clear_all" style="padding: 8px 10px;line-height: 1em;font-size: 13px;border: 1px solid rgba(0,0,0,0.2);border-radius: 20px;cursor: pointer;outline: none;background-color: #EEEEEE;">Clear All</button>\n                </div>\n                <hr style="margin:0;">\n                <div id="glasp_kindle_all_books_wrapper" style="max-height: 420px;width: 360px;overflow: scroll;padding: 8px 0;">${Array.from(t).map(((e,t,i)=>`\n                        <div data-asin-id="${e.id}" style="display: flex;justify-content: left;align-items: center;position: relative;gap:8px;overflow: hidden;cursor: pointer;padding: 8px 0;">\n                            <input type="checkbox" data-asin-id="${e.id}" id="checkbox_for_book_${e.id}" class="glasp_checkbox_for_books" style="width: 20px !important;min-width: 20px;height: 20px !important;cursor: pointer;margin-right: 6px;">\n                            <img src="${e.thumbnailSmall}" style="width: 32px;">\n                            <label for="checkbox_for_book_${e.id}" style="text-align: left;overflow: hidden;white-space: break-spaces;text-overflow: ellipsis;display: -webkit-box;-webkit-line-clamp: 2;-webkit-box-orient: vertical;cursor: pointer;line-height: 1.3em;font-size: 14px;font-weight: normal;width: 100%;">${e.title}</label>\n                        </div>`)).join("")}</div>\n                <hr style="margin:0;">\n                <div style="padding: 8px 0 0;text-align: left;font-size: 13px;color: #626262;">\n                    <div><span id="glasp_kindle_process_status">Getting</span> <span id="glasp_kindle_processed_num">0</span> / <span id="glasp_kindle_selected_num">0</span></div>\n                </div>\n                <div style="padding: 8px 0 0;display: flex;justify-content: center;align-items: center;position: relative;gap: 24px;">\n                    <div style="margin-right: auto;">Download as: <a id="glasp_kindle_download_text">Text</a>, <a id="glasp_kindle_download_csv">CSV</a>, <a id="glasp_kindle_download_md">MD</a> </div>\n                    <button id="glasp_kindle_books_import" style="padding: 8px 16px;border-radius: 20px;cursor: pointer;background-color: #6297ff;color: #FFFFFF;outline: none;border: none;white-space: nowrap;">Import to Glasp</button>\n                </div>\n            </div>\n            `),document.getElementById("glasp_kindle_books_select_all").addEventListener("click",(()=>{Array.from(document.getElementsByClassName("glasp_checkbox_for_books")).forEach((e=>{e.checked=!0})),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"glasp_kindle_books_select_all"})})),document.getElementById("glasp_kindle_books_clear_all").addEventListener("click",(()=>{Array.from(document.getElementsByClassName("glasp_checkbox_for_books")).forEach((e=>{e.checked=!1})),chrome.runtime.sendMessage({action:"amplitude_log",evtName:"glasp_kindle_books_clear_all"})}));const i=[],n=[];async function o(t,o){i.length=0,n.length=0,document.getElementById(t).disabled=!0,document.getElementById("glasp_kindle_process_status").innerHTML="Getting",document.getElementById("glasp_kindle_processed_num").outerHTML=document.getElementById("glasp_kindle_processed_num").outerHTML,document.getElementById("glasp_kindle_processed_num").innerText=0;const a=Array.from(document.getElementsByClassName("glasp_checkbox_for_books")).filter((e=>e.checked)).length;document.getElementById("glasp_kindle_selected_num").innerText=a,document.getElementById("glasp_kindle_processed_num").addEventListener("DOMSubtreeModified",(()=>{if(parseInt(document.getElementById("glasp_kindle_processed_num").innerText)==a)switch(o){case"import":document.getElementById("glasp_kindle_process_status").innerHTML="Saving...",function(e){chrome.runtime.sendMessage({action:"save_kindle_highlights",data:e},(async e=>{const t=e.result;document.getElementById("glasp_kindle_process_status").innerHTML=`<span style="color:${"Imported!"==t?"green":"red"};">${t}</span>`}))}(n);break;case"text":var e=(t=new JSZip).folder("Glasp Highlights");Array.from(n).forEach((t=>{e.file(`${t.data.title.replace(/\//g," ")}.txt`,function(e){let t="";const i=e.data,n=i.title,o=i.author,r=i.fullUrl,a=i.thumbnail,l=i.lastUpdatedDate,s=i.highlights;t+=`${n}\n`,t+=`By: ${o}\n`,t+=`Book URL: ${r}\n`,t+=`Book Cover: ${a}\n`,t+=`Last Updated on: ${l}\n`,t+="\nHighlights & Notes: \n";for(let e=0;e<s.length;e++){const i=s[e],n=i.string,o=i.note?i.note:"";t+=` - ${n.replace(/\n/g," ")}\n`,t+=""!==o?`  * Notes: ${o}\n`:""}return t}(t))})),t.generateAsync({type:"blob"}).then((function(e){saveAs(e,"Glasp Highlights.zip")}));break;case"csv":!function(e){const t=[["Title","Author","Book URL","Book Cover","Last Updated on","Highlight Text","Note","Color","Location"]];Array.from(e).forEach((e=>{const i=e.data,n=r(i.title),o=r(i.author),a=i.fullUrl,l=i.thumbnail,s=r(i.lastUpdatedDate),d=i.highlights;0==d.length?t.push([n,o,a,l,s,"","","",""]):Array.from(d).forEach((e=>{const i=r(e.string),d=""!==e.note?r(e.note):"",c=e.location,g=r(e.color);t.push([n,o,a,l,s,i,d,g,c])}))}));const i="data:text/csv;charset=utf-8,"+t.map((e=>e.join(","))).join("\n"),n=encodeURI(i),o=document.createElement("a");function r(e){return""==e?"":`"${e.replace(/"/g,'""').replace(/\n/g," ").replace(/#/g,"")}"`}o.setAttribute("href",n),o.setAttribute("download","Glasp Highlights.csv"),document.body.appendChild(o),o.click(),o.remove()}(n);break;case"md":var t;e=(t=new JSZip).folder("Glasp Highlights"),Array.from(n).forEach((t=>{e.file(`${t.data.title.replace(/\//g," ")}.md`,Ve(t.data))})),t.generateAsync({type:"blob"}).then((function(e){saveAs(e,"Glasp Highlights.zip")}))}})),Array.from(document.getElementsByClassName("glasp_checkbox_for_books")).forEach((e=>{e.checked&&i.push(e.getAttribute("data-asin-id"))})),Array.from(i).forEach((t=>{if(Array.from(e).some((e=>e.id==t)))return Array.from(e).forEach((e=>{e.id==t&&n.push(e)})),void(document.getElementById("glasp_kindle_processed_num").innerText=parseInt(document.getElementById("glasp_kindle_processed_num").innerText)+1);r(window.location.host,t,0)})),document.getElementById(t).disabled=!1}function r(t,i,o){$.ajax({url:`https://${t}/notebook?asin=${i}&contentLimitState=&`,type:"GET",dataType:"text",success:function(t){const i=We($($.parseHTML(t))[0]),o={id:i.id,data:i};n.push(o),Array.from(e).some((e=>e.id==i.id))||e.push(o),document.getElementById("glasp_kindle_processed_num").innerText=parseInt(document.getElementById("glasp_kindle_processed_num").innerText)+1},error:function(){if(++o<=2)return r(t,i,o);document.getElementById("glasp_kindle_processed_num").innerText=parseInt(document.getElementById("glasp_kindle_processed_num").innerText)+1}})}document.getElementById("glasp_kindle_download_text").addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"glasp_kindle_download_text"}),o("glasp_kindle_download_text","text")})),document.getElementById("glasp_kindle_download_csv").addEventListener("click",(async()=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"glasp_kindle_download_csv"}),o("glasp_kindle_download_csv","csv")})),document.getElementById("glasp_kindle_download_md").addEventListener("click",(async()=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"glasp_kindle_download_md"}),o("glasp_kindle_download_md","md")})),document.getElementById("glasp_kindle_books_import").addEventListener("click",(async()=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"glasp_kindle_books_import"}),o("glasp_kindle_books_import","import")}))}))}function We(e){const t=e||document,i=t.querySelector("#annotation-scroller > div > div.a-row.a-spacing-base > div.a-column.a-span5 > h3").innerText,n=t.querySelector("#annotation-scroller > div > div.a-row.a-spacing-base > div.a-column.a-span1.kp-notebook-bookcover-container > a").href,o=new URL(n).hostname+new URL(n).pathname,r=n.split("dp/")[1],a=t.getElementsByClassName("a-link-normal kp-notebook-printable a-text-normal")[0].querySelector("img").src,l=a.includes("._SY160")?a.replace("._SY160",""):a,s=t.querySelector("#annotation-scroller > div > div.a-row.a-spacing-base > div.a-column.a-span5 > p.a-spacing-none.a-spacing-top-micro.a-size-base.a-color-secondary.kp-notebook-selectable.kp-notebook-metadata").innerText,d=document.querySelector(`#kp-notebook-annotated-date-${r}`).getAttribute("value"),c=isNaN(new Date(d))?Date.now():new Date(d).getTime(),g=[],h={pink:"#FFB6C6",yellow:"#F9F47F",orange:"#FFCD8B",blue:"#ADC9FF"};return Array.from(t.querySelector("#kp-notebook-annotations").querySelectorAll(".a-row .a-spacing-base")).forEach((e=>{if(!e.querySelector("#highlight"))return;const t=e.querySelector("#highlight").innerText??"",i=e.querySelector("#note").innerText??"",n=e.querySelector("#highlight").parentElement.getAttribute("class").split("kp-notebook-highlight-")[1]??"",o=parseInt(e.querySelector("#kp-annotation-location").getAttribute("value"))??0,r=Math.random().toString(36).substring(2,10)+Math.random().toString(36).substring(2,10);g.push({string:t,highlightid:r,note:i,color:n,timestamp:c,colorId:h[n],location:parseInt(o)})})),{id:r,title:i,fullUrl:n,url:o,thumbnailSmall:a,thumbnail:l,author:s,lastUpdatedDate:d,lastUpdated:c,highlights:g}}const Ge=e=>void 0===e||"auto"===e||"instant"===e||"smooth"===e;function Xe(e,t){this.scrollLeft=e,this.scrollTop=t}const Ye=(e,t,i="cannot convert to dictionary.")=>`Failed to execute '${e}' on '${t}': ${i}`,Qe=(e,t,i)=>Ye(e,t,`The provided value '${i}' is not a valid enum value of type ScrollBehavior.`),Je=(e,t,i)=>{const n=`__SEAMLESS.BACKUP$${t}`;return e[n]||!e[t]||e[t]?.__isPolyfill||(e[n]=e[t]),e[n]||i},Ke=e=>{const t=typeof e;return null!==e&&("object"===t||"function"===t)},et=e=>e.ownerDocument.scrollingElement||e.ownerDocument.documentElement,tt=e=>.5*(1-Math.cos(Math.PI*e)),it=()=>window.performance?.now?.()??window.Date.now(),nt=e=>{const t=(it()-e.timeStamp)/(e.duration||500);if(t>1)return e.method(e.targetX,e.targetY),void e.callback();const i=(e.timingFunc||tt)(t),n=e.startX+(e.targetX-e.startX)*i,o=e.startY+(e.targetY-e.startY)*i;e.method(n,o),e.rafId=window.requestAnimationFrame((()=>{nt(e)}))},ot=e=>isFinite(e)?Number(e):0,rt=(e=>(t,i,n)=>{const[o,r]=(a=t).window===a?[et(t.document.documentElement),"Window"]:[t,"Element"];var a;const l=i??{};if(!Ke(l))throw new TypeError(Ye(e,r));if(!Ge(l.behavior))throw new TypeError(Qe(e,r,l.behavior));"scrollBy"===e&&(l.left=ot(l.left)+o.scrollLeft,l.top=ot(l.top)+o.scrollTop),((e,t,i)=>{if(!((n=e).isConnected??(!n.ownerDocument||!(1&n.ownerDocument.compareDocumentPosition(n)))))return;var n;const o=e.scrollLeft,r=e.scrollTop,a=ot(t.left??o),l=ot(t.top??r);if(a===o&&l===r)return;const s=Je(HTMLElement.prototype,"scroll",Xe),d=Je(Object.getPrototypeOf(e),"scroll",s).bind(e);if("smooth"!==t.behavior)return void d(a,l);const c=()=>{window.removeEventListener("wheel",h),window.removeEventListener("touchmove",h)},g={...i,timeStamp:it(),startX:o,startY:r,targetX:a,targetY:l,rafId:0,method:d,callback:c},h=()=>{window.cancelAnimationFrame(g.rafId),c()};window.addEventListener("wheel",h,{passive:!0,once:!0}),window.addEventListener("touchmove",h,{passive:!0,once:!0}),nt(g)})(o,l,n)})("scroll"),at=e=>{switch(e){case"horizontal-tb":case"lr":case"lr-tb":case"rl":case"rl-tb":return 0;case"vertical-rl":case"tb":case"tb-rl":return 1;case"vertical-lr":case"tb-lr":return 2;case"sideways-rl":return 3;case"sideways-lr":return 4}return 0},lt=(e,t,i,n)=>{let o=0;switch(t||(o^=2),e){case 0:o=o>>1|(1&o)<<1,[i,n]=[n,i];break;case 1:case 3:o^=1;break;case 4:o^=2}return[o,i,n]},st=e=>1==(1&lt(at(e.writingMode),"rtl"!==e.direction,void 0,void 0)[0]),dt=(e,t,i,n,o,r,a)=>0!==e?e:o<t&&r>i||o>t&&r<i?null:o<=t&&a<=n||r>=i&&a>=n?2:r>i&&a<n||o<t&&a>n?3:null,ct=e=>"visible"!==e&&"clip"!==e,gt=(e,t)=>(e.clientHeight<e.scrollHeight||e.clientWidth<e.scrollWidth)&&(ct(t.overflowY)||ct(t.overflowX)||e===et(e)),ht=e=>{const t=e.parentNode,i=e.parentElement;if(null===i&&null!==t){if(11===t.nodeType)return t.host;if(9===t.nodeType)return(e=>{try{return e.ownerDocument.defaultView?.frameElement||null}catch{return null}})(e)}return i},pt=(e,t,i)=>e<t?t:e>i?i:e,mt=(e,t,i)=>{switch(e){case 1:return(t+i)/2;case 3:return i;case 2:case 0:return t}},_t=(e,t)=>{const i=e.ownerDocument.defaultView?.visualViewport,[n,o,r,a]=e===et(e)?[0,0,i?.width??e.clientWidth,i?.height??e.clientHeight]:[t.left,t.top,e.clientWidth,e.clientHeight],l=n+e.clientLeft,s=o+e.clientTop;return[s,l+r,s+a,l]},ut=(e,t,i)=>{const n=t||{};if(!Ge(n.behavior))throw new TypeError(Qe("scrollIntoView","Element",n.behavior));((e,t)=>{const i=[];let n=e.ownerDocument,o=n.defaultView;if(!o)return i;const r=window.getComputedStyle(e),a="rtl"!==r.direction,l=at(r.writingMode||r.getPropertyValue("-webkit-writing-mode")||r.getPropertyValue("-ms-writing-mode")),[s,d]=((e,t,i)=>{const[n,o,r]=lt(t,i,e.block||"start",e.inline||"nearest");return[o,r].map(((e,t)=>{switch(e){case"center":return 1;case"nearest":return 0;default:return"start"===e==!(n>>t&1)?2:3}}))})(t,l,a);let[c,g,h,p]=((e,t,i)=>{const{top:n,right:o,bottom:r,left:a}=t,l=(s=e.ownerDocument,["scroll-margin","scroll-snap-margin"].filter((e=>e in s.documentElement.style))[0]);var s;if(!l)return[n,o,r,a];const d=e=>{const t=i.getPropertyValue(`${l}-${e}`);return parseInt(t,10)||0};return[n-d("top"),o+d("right"),r+d("bottom"),a-d("left")]})(e,e.getBoundingClientRect(),r);for(let r=ht(e);null!==r;r=ht(r)){if(n!==r.ownerDocument){if(n=r.ownerDocument,o=n.defaultView,!o)break;const{left:e,top:t}=r.getBoundingClientRect();c+=t,g+=e,h+=t,p+=e}const e=o.getComputedStyle(r);if("fixed"===e.position)break;if(!gt(r,e))continue;const a=r.getBoundingClientRect(),[l,m,_,u]=_t(r,a),f=dt(s,u,m,r.clientWidth,p,g,g-p),y=dt(d,l,_,r.clientHeight,c,h,h-c),b=null===f?0:mt(f,p,g)-mt(f,u,m),w=null===y?0:mt(y,c,h)-mt(y,l,_),v=st(e)?pt(b,-r.scrollWidth+r.clientWidth-r.scrollLeft,-r.scrollLeft):pt(b,-r.scrollLeft,r.scrollWidth-r.clientWidth-r.scrollLeft),E=pt(w,-r.scrollTop,r.scrollHeight-r.clientHeight-r.scrollTop);i.push([r,{left:r.scrollLeft+v,top:r.scrollTop+E,behavior:t.behavior}]),c=Math.max(c-E,l),g=Math.min(g-v,m),h=Math.min(h-E,_),p=Math.max(p-v,u)}return i})(e,n).forEach((([e,t])=>{rt(e,t,i)}))};function ft(e){ut(this,{block:e??1?"start":"end",inline:"nearest"})}(e=>{if("scrollBehavior"in window.document.documentElement.style)return;const t=Je(window.HTMLElement.prototype,"scrollIntoView",ft);var i,n,o;i="scrollIntoView",o=n=function(){const i=arguments,n=i[0];1===i.length&&Ke(n)?ut(this,n,e):t.apply(this,i)},Object.defineProperty(o,"__isPolyfill",{value:!0}),[HTMLElement.prototype,SVGElement.prototype,Element.prototype].forEach((e=>{Je(e,i),e[i]=n}))})(),"glasp.co"!==window.location.host&&"localhost"!==window.location.hostname||window.addEventListener("message",(function(e){if(e.source===window)if(e.data.message&&"check_glasp_extension_exist"===e.data.message){const e={message:"chrom_extension_exists"};window.postMessage(e,"*")}else if(e.data.message&&"glasp_chrome_ext_signin"===e.data.message){const t=e.data.token;_()&&chrome.runtime.sendMessage({action:"chrome_ext_signin_token",data:t})}}),!1),chrome.runtime.onMessage.addListener((function(e,t,i){if(e.action&&"highlight_load"===e.action){const t=e.data;if(null==t)return;const i=$(".highlighter--highlighted");for(let e=0;e<i.length;e++)i[e].outerHTML=i[e].innerHTML;t.length>0?m.docId=t[0].docId:m.docId="",function(e,t){for(let t=0;t<e.length;t++)xe(e[t],true)}(t)}else(e.action&&"run_initialLoad"===e.action||e.action&&"load_again"===e.action)&&Ee(m.uid)})),chrome.runtime.onMessage.addListener((function(e,t,i){if(!m.excludedURL&&!function(){const e=new URL(window.location.href).host;return Array.from(m.domainExcludeList).forEach(((t,i,n)=>{if(t[1].domain==e)return!0})),!1}())if(e.action&&"exclude_domain"===e.action&&(m.domainExcludeList=e.data),e.action&&"sidebar_toggle"===e.action)Oe();else if(e.action&&"sidebar_width"===e.action)m.sidebarWidth=e.data;else if(e.action&&"user_data"===e.action)m.displayName=e.data[0],m.photoURL=e.data[1],m.uid=e.data[2],m.username=e.data[3],m.viewingOthersHLs=!1,void 0!==m.uid?(qe(),x(m.photoURL,m.displayName,m.username),m.selectedUsersUID=m.uid,m.userInfoReceived=!0):null!==m.uid&&void 0!==m.uid||(_()&&chrome.runtime.sendMessage({action:"run_initApp"}),qe());else if(e.action&&"other_user_data"===e.action){m.viewingOthersHLs=!0,m.selectedUsersInfo=e.data[0];const t=e.data[1];m.selectedUsersUID=m.selectedUsersInfo.uid,m.selectedUsersDisplayName=m.selectedUsersInfo.displayName,m.selectedUsersPhotoURL=m.selectedUsersInfo.photoURL,m.selectedUserUsername=m.selectedUsersInfo.username,m.selectedUsersUID===m.uid&&(m.viewingOthersHLs=!1),He(m.otherUsersTagList),Se(m.otherUsersPagenote),x(m.selectedUsersPhotoURL,m.selectedUsersDisplayName),ze(d(m.sidebar_iframe_doc,m.sidebar_copy_all,m.highlightEmptyEl,m.loadedHighlights)),t&&(m.sidebarHighlighterToggleEl.on("click",!1),m.highlighterMode="off",chrome.runtime.sendMessage({action:"browser_icon_change",data:m.highlighterMode}))}else if(e.action&&"receive_uid"===e.action)m.displayName=e.data[0],m.photoURL=e.data[1],m.uid=e.data[2],qe();else if(e.action&&"ready_to_scan_highlights"===e.action)m.loadedHighlights=[],m.loadedHighlights=e.data;else if(e.action&&"sorted_highlights_list"===e.action){const t=!0;m.loadedHighlights=[],m.loadedHighlights=e.data[0],m.addedHighlightId=e.data[1],m.actionType=e.data[2],ze(d(m.sidebar_iframe_doc,m.sidebar_copy_all,m.highlightEmptyEl,m.loadedHighlights),t),g()}else e.action&&"user_list_data"===e.action?(m.userListData=e.data,m.userListDataLength=Object.keys(m.userListData).length,k(m.userListData,m.userListDataLength)):e.action&&"hide_showing_highlights"===e.action?ve():e.action&&"highlighter_on"===e.action?document.getElementById("glasp-sidebar-iframe")&&(m.sidebar_iframe=document.getElementById("glasp-sidebar-iframe"),w(m.sidebar_iframe)&&m.sidebar_iframe.contentWindow.document.getElementById("myonoffswitch")&&(m.sidebarHighlighterToggleEl=$(m.sidebar_iframe.contentWindow.document.getElementById("myonoffswitch")),m.sidebarHighlighterToggleEl.is(":checked")||m.sidebarHighlighterToggleEl.prop("checked",!0),m.highlighterMode="on")):e.action&&"highlighter_off"===e.action?(m.highlighterMode="off",chrome.runtime.sendMessage({action:"browser_icon_change",data:m.highlighterMode}),document.getElementById("glasp-sidebar-iframe")&&(m.sidebar_iframe=document.getElementById("glasp-sidebar-iframe"),w(m.sidebar_iframe)&&m.sidebar_iframe.contentWindow.document.getElementById("myonoffswitch")&&(m.sidebarHighlighterToggleEl=$(m.sidebar_iframe.contentWindow.document.getElementById("myonoffswitch")),m.sidebarHighlighterToggleEl.prop("checked",!1),g()))):e.action&&"tag_data_on_load"===e.action?m.userTagList=e.data:e.action&&"pagenote_on_load"===e.action?m.userPagenote=e.data:e.action&&"tag_data_on_load_others"===e.action?m.otherUsersTagList=e.data:e.action&&"pagenote_on_load_others"===e.action?m.otherUsersPagenote=e.data:e.action&&"receive_user_tags"===e.action?m.userTags=e.data:e.action&&"visibility_status"===e.action?m.visibilityStatus=e.data:e.action&&"esacape_welcome_page"===e.action?window.location.assign("https://glasp.co"):e.action&&"browser_icon_clicked"===e.action?i({action:"browser_icon_clicked_received"}):e.action&&"yt_transcript_btn_create"===e.action&&q()})),m.excludedURL||($.get(chrome.runtime.getURL("./iframe/signup_login.html"),(function(e){m.sidebar_signup_login_HTML=e})),$.get(chrome.runtime.getURL("./iframe/sidebar.html"),(function(e){m.sidebarHTML=e})),$.get(chrome.runtime.getURL("./iframe/tooltip.html"),(function(e){m.tooltipHTML=e,m.tooltipEl=$(e)})),window.onload=()=>{if("twitter.com"===window.location.host){Pe(2500);let e=window.location.href;new MutationObserver((function(t){t.forEach((function(t){e!==document.location.href&&(e=document.location.href,"twitter.com"===window.location.host&&Pe(0))}))})).observe(document.body,{childList:!0})}"www.youtube.com"===window.location.hostname&&""!==window.location.search&&window.location.search.includes("v=")&&q(),Array.from(["read.amazon.","lesen.amazon.","leer.amazon.","lire.amazon.","leggi.amazon.","ler.amazon."]).some((e=>1==window.location.host.includes(e)))&&"/notebook"===window.location.pathname&&Ze(),!F()&&"file:"!==window.location.protocol&&"localhost"!==window.location.hostname&&window.location.href.toLowerCase().indexOf(".pdf")>0&&document.getElementsByTagName("embed").length>0&&["application/pdf","application/octet-stream"].includes(document.getElementsByTagName("embed")[0].type)&&function(){document.getElementsByClassName("glasp_pdf_open_button").length>0&&Array.from(document.getElementsByClassName("glasp_pdf_open_button")).forEach((e=>{e.remove()}));const e=chrome.runtime.getURL("/pdf/web/viewer.html")+`?file=${window.location.href}`;document.body.insertAdjacentHTML("beforeend",`\n    <a href="${e}" class="glasp_pdf_open_button" id="glasp_pdf_open_button" style="position: fixed;top: 10%;right: 2%;box-shadow: rgb(0 0 0 / 30%) 0px 2px 6px;background-color: #FFFFFF;border-radius: 50%;z-index: 10;padding: 10px;cursor: pointer;user-select: none;width: 28px;height: 28px;display: flex;justify-content: center;align-items: center;z-index: 2147483647 !important;">\n        <svg width="28" height="28" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M3.73666 72.9828C-1.17604 68.0756 -1.17605 60.1196 3.73658 55.2124L44.259 14.7353L64.026 34.4803L14.6085 83.8424L3.73666 72.9828Z" fill="#FF4E74"/>\n            <path d="M93.6763 64.0979L44.2592 14.7355L55.131 3.8758C60.0437 -1.03135 68.0087 -1.03136 72.9213 3.8758L113.444 44.353L93.6763 64.0979Z" fill="#FFF85E"/>\n            <path d="M64.0262 93.7147L113.444 44.3527L124.315 55.2124C129.228 60.1196 129.228 68.0756 124.315 72.9828L83.7929 113.46L64.0262 93.7147Z" fill="#76FF54"/>\n            <path d="M72.9212 124.32C68.0086 129.227 60.0436 129.227 55.1309 124.32L14.6085 83.8424L34.3755 64.0977L83.7928 113.46L72.9212 124.32Z" fill="#5C94FF"/>\n        </svg>\n    </a>\n    <div class="glasp_pdf_btn_hover" id="glasp_pdf_btn_hover" style="visibility: hidden;font-size: 12px;width: max-content;font-family: Roboto, sans-serif;background-color: black;color: rgb(255, 255, 255);text-align: center;border-radius: 4px;padding: 8px 10px;position: absolute;top: 18%;right: 2%;box-shadow: rgb(0 0 0 / 25%) 0px 2px 4px;z-index: 2147483647 !important;">Turn on Glasp</div>\n    `),document.getElementById("glasp_pdf_open_button")&&(document.getElementById("glasp_pdf_open_button").addEventListener("click",(()=>{chrome.runtime.sendMessage({action:"amplitude_log",evtName:"glasp_pdf_open_button_click"})})),document.getElementById("glasp_pdf_open_button").addEventListener("mouseenter",(()=>{document.getElementById("glasp_pdf_btn_hover").style.visibility="visible"})),document.getElementById("glasp_pdf_open_button").addEventListener("mouseleave",(()=>{document.getElementById("glasp_pdf_btn_hover").style.visibility="hidden"})))}()},document.addEventListener("visibilitychange",(function(){if(document.hidden){if(m.sidebarIsOpen&&null!==document.getElementById("glasp-sidebar-iframe")&&(m.sidebar_iframe=document.getElementById("glasp-sidebar-iframe"),m.sidebarWidth=m.sidebar_iframe.style.width),$(m.sidebar_iframe).attr("style",'width: 0px !important; min-width: 0px !important; max-width: 300px; height: 100%; background: #FFFFFF; resize: horizontal; direction: rtl; margin: auto; position: fixed; top: 0px; right: 0px; left: auto; z-index: 9000000000000000000;background-image: url("https://storage.googleapis.com/glasp.co/src/img/loading_200.gif");background-repeat: no-repeat;background-position: center;background-size: 40px;'),m.tooltip_iframe.style.display="none",_()&&chrome.runtime.sendMessage({action:"sidebar_status_change",data:[!1,m.sidebarWidth]}),document.getElementsByClassName("glasp-ui-wrapper")){let e=document.getElementsByClassName("glasp-ui-wrapper");for(;e[0];)e[0].remove()}m.visibilityChanged=!0}else{if(null!==m.uid&&void 0!==m.uid||_()&&chrome.runtime.sendMessage({action:"run_initApp"}),qe(),x(m.photoURL,m.displayName,m.username),m.sidebar_iframe.style.display="block",m.sidebarIsOpen&&(m.sidebar_iframe.style.width=m.sidebarWidth,m.sidebar_iframe.style.boxShadow="rgba(200, 200, 200, 0.5) 0px 0px 7px 2px"),"off"===m.highlighterMode)return void(document.getElementById("glasp-sidebar-iframe")&&(m.sidebar_iframe=document.getElementById("glasp-sidebar-iframe"),w(m.sidebar_iframe)&&m.sidebar_iframe.contentWindow.document.getElementById("myonoffswitch")&&(m.sidebarHighlighterToggleEl=$(m.sidebar_iframe.contentWindow.document.getElementById("myonoffswitch")),m.sidebarHighlighterToggleEl.prop("checked",!1),g(),_()&&chrome.runtime.sendMessage({action:"browser_icon_change",data:m.highlighterMode}))));void 0!==m.selectedUsersUID&&m.selectedUsersUID!==m.uid||(_()&&chrome.runtime.sendMessage({action:"viewing_others_highlights",data:!1}),m.highlighterMode="on",m.sidebarHighlighterToggleEl=$(m.sidebar_iframe_doc.getElementById("myonoffswitch")),m.sidebarHighlighterToggleEl.prop("checked",!0),_()&&chrome.runtime.sendMessage({action:"browser_icon_change",data:m.highlighterMode}))}})),window.addEventListener("mousedown",(function(e){const t=window.getSelection().toString();m.prevSelectedText=t,e.target.classList.contains("highlighter--highlighted")||(t.length>0&&(m.textSelected=!0),g())})),window.addEventListener("click",(function(e){3===e.detail&&(m.tripleClicked=!0)})),window.addEventListener("mouseup",(function(e){if(/medium.com\/p\//g.test(window.location.href))return void g();if(m.highlightClicked)return L(e.target),void(void 0!==chrome.app.isInstalled&&chrome.runtime.sendMessage({action:"amplitude_log",evtName:"tooltip_popup"}));const t=window.getSelection(),i=t.toString(),n=m.prevSelectedText===t.toString();if(m.textSelected&&n)return g(),void(m.textSelected=!1);i.length<2||function(e){if(/medium.com\/p\//g.test(window.location.href))return!0;if(/typeshare.co\/editor\//g.test(window.location.href))return!0;let t=0,i=!1;for(;e.parentElement;){if("BODY"===e.parentElement.tagName)return;if(e.parentElement.getAttribute("contenteditable")&&(i=!0),i||10===t)break;t++,e=e.parentElement}return i}(e.target)||(m.prevSelectedText=i,L(t.getRangeAt(0),e.clientX),_()&&chrome.runtime.sendMessage({action:"amplitude_log",evtName:"tooltip_popup"}))})),window.addEventListener("scroll",(function(e){if(!document.getElementById("glasp-tooltip-iframe")||"none"!==document.getElementById("glasp-tooltip-iframe").style.display)if(/medium.com\/p\//g.test(window.location.href))g();else if(m.highlightClicked)L(m.currentHighlightEl,e.clientX,m.currentHighlightColor);else if(m.textSelected){const e=window.getSelection();e.toString().length>0&&L(e.getRangeAt(0))}else if(""!==window.getSelection().toString().replace(/\s+/g,"")){const e=window.getSelection();e.toString().length>0&&L(e.getRangeAt(0))}}))),chrome.runtime.onMessage.addListener((function(e,t,i){e.action&&"highlight_from_context"===e.action&&window.getSelection().toString().length>1&&we(window.getSelection(),"#FFB6C6",!1)}))})();