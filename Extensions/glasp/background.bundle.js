(()=>{"use strict";firebase.initializeApp({apiKey:"AIzaSyCAdXVRjHTtC1MqWEioaH8nZ9t-e6EMM5A",authDomain:"driven-current-285910.firebaseapp.com",databaseURL:"https://driven-current-285910.firebaseio.com",projectId:"driven-current-285910",storageBucket:"driven-current-285910.appspot.com",messagingSenderId:"843827296791",appId:"1:843827296791:web:6bc729caeb6e531701fa52",measurementId:"G-Z2FG8Y72WK"});const e=firebase.firestore();let t,o=new class{displayName;email;photoURL;emailVerified;uid;providerData;docRef;url;fullUrl;sidebarOpen;newHLsDataForSort;highlightRefForSort;username;highlighterMode="on";sidebarWidth="300px";visibilityStatus="Public";userAccountCreated=!1;viewingOthersHLs=!1;excludedDomain=!1;userExcludedDomain=!1;currURL="";errorReporter;domainExcludeList=[];userSignedIn=!1;urlCollection=e.collection("urls");constructor(){t=this}getInstance(){return this}};class n{config_template={reporter:console};config;reporter;constructor(e){this.config={...this.config_template,...e},this.reporter=this.config.reporter}async report(e){return console.log("report"),e instanceof i?this.reporter.log(e.getMessage()):this.reporter.log(e)}}class i{error_message;message_template={log_level:"info",datetime:(new Date).toISOString(),uid:"",browser:"",message:"Error",error:void 0};constructor(e){e instanceof Error&&(this.error_message={...this.message_template,error:e}),this.error_message="string"==typeof e?{...this.message_template,message:e}:{...this.message_template,...e}}getMessage(){return this.error_message}setLogLevel(e){return this.error_message.log_level=e,this}}class s{user_agent;uid;docRef;constructor(e,t,o){this.user_agent=o,this.uid=t,this.docRef=e}async log(e){let t={};return"string"==typeof e?(t.message=e,t.uid=this.uid,t.user_agent=this.user_agent):(e.user_agent=this.user_agent,e.uid=this.uid),console.log("log:",t),this.docRef.add(t)}}function c(e,t,o,n,i,s){let c=[],a=[],r="",l=0;t.collection("users").doc(o).collection("highlights").where("url","==",e).get().then((function(e){e.forEach((function(e){const t=e.data();l+=1;for(let o=0;o<t.highlights.length;o++){let n=t.highlights[o];n.docId=e.id,c.push(n)}"tag"in t&&(a=t.tag),"pagenote"in t&&""!==t.pagenote&&(r=t.pagenote)})),chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(e){console.log("loadAll ran ====="),l>=1&&chrome.tabs.sendMessage(e[0].id,{action:"highlight_load",data:c}),chrome.tabs.sendMessage(e[0].id,{action:"ready_to_scan_highlights",data:c}),chrome.tabs.sendMessage(e[0].id,{action:"tag_data_on_load",data:a}),chrome.tabs.sendMessage(e[0].id,{action:"pagenote_on_load",data:r}),chrome.tabs.sendMessage(e[0].id,{action:"user_data",data:[n,i,o,s]})}))})).catch((function(e){console.log("Error getting documents: ",e)}))}async function a(e,t,o,n,i,s,c,a,r,l,d){return a.where("url","==",e).get().then((async function(u){let h=!1;for(const t of u.docs){if(1==h)continue;h=!0;let u=t.data();const g=a.doc(t.id),f=t.id;let m=u.userList,p=Object.keys(m).length,_=!1;for(let e=0;e<p;e++)if(m[e].uid==r){m[e].timestamp=o,m[e].photoURL=d,s&&(m[e].pagenote=s),_=!0;break}if(!_){const e=s?{uid:r,displayName:l,photoURL:d,timestamp:o,pagenote:s}:{uid:r,displayName:l,photoURL:d,timestamp:o};m.push(e)}u.userList=m,u.lastUpdated=o,u.title=n,u.thumbnail=i,await g.set(u).then((async function(){console.log("User info stored in the url data!"),1==p&&_||m[0].uid!=r&&"www.glasp.co/welcome"!=e&&await c.collection("users").doc(r).collection("following").get().then((e=>{let t;return null==e||0==e.docs.length?t=null:e.forEach((function(e){t=e.data().followingList})),t})).then((async e=>{const t=[];for(let o=0;o<p&&m[o].uid!=r;o++)for(let n=0;n<e.length;n++)if(m[o].uid==e[n].uid){const e=m[o].uid,n=c.collection("users").doc(e).collection("notification").where("urlId","==",f).get().then((async function(t){let o=!1;const n=Date.now(),i={uid:r,timestamp:n};for(let s in t.docs){o=!0;const a=t.docs[s],l=a.data(),d=c.doc(`users/${e}/notification/${a.id}`),u=l.followersList;if("follow"==l.notificationType)return;for(let e=0;e<u.length;e++)if(u[e].uid==r)return;u.push(i);const h=Object.assign([],u),g={alreadyRead:!1,timestamp:n,urlId:f,followersList:h,notificationType:"pileon"};await d.set(g).then((function(){amplitude.getInstance().logEvent("notification_created",{type:"pileon"})})).catch((function(e){console.log("Error setting new documents: ",e)}))}if(!o){const t=[];t.push(i);const o=Object.assign([],t),s={alreadyRead:!1,timestamp:n,urlId:f,followersList:o,notificationType:"pileon"};c.collection("users").doc(e).collection("notification").add(s).then((function(){amplitude.getInstance().logEvent("notification_created",{type:"pileon"})})).catch((function(e){console.log("Error setting new documents: ",e)}))}})).catch((function(e){console.log("Error getting documents: ",e)}));t.push(n)}await Promise.all(t).then((()=>{console.log("all the notification docs updated/created")})).catch((function(e){console.log("Error getting documents: ",e)}))})).catch((function(e){console.log("Got an error: ",e)}))})).catch((function(e){console.log("Got an error: ",e)}))}if(0==h){const c=s?{uid:r,displayName:l,photoURL:d,timestamp:o,pagenote:s}:{uid:r,displayName:l,photoURL:d,timestamp:o},u=[];u.push(c);const h={url:e,fullUrl:t,title:n,thumbnail:i,lastUpdated:o,userList:u};await a.add(h).then((function(){console.log("new doc created & user info stored in it!")})).catch((function(e){console.error("Error adding document: ",e)}))}})).catch((function(e){console.log("Error getting documents: ",e)}))}const r=["chrome://extensions/","chrome://newtab/","*://driven-current-285910.firebaseapp.com/*","http://localhost:4000/home","http://localhost:4000/#/*","*://review.firstround.com/*","*://*.google.com/*","*://*.google.co.jp/*","*://*.typeform.com/*","*://feedly.com/*","*://getpocket.com/*","*://*.whatsapp.com/*","*://*.notion.so/*","*://*.slack.com/*","*://*.office.com/*","*://*.live.com/*","*://*.yahoo.com/*","*://*.firebase.google.com/*","*://glasp.co/#/*","*://glasp.co/home","*://www.glasp.co/home","*://www.facebook.com/*","*://www.instagram.com/*","*://twitter.com/home","*://twitter.com/intent/*","*://twitter.com/messages/*","*://twitter.com/settings","*://*.linkedin.com/feed/","*://*.linkedin.com/mynetwork/","*://*.linkedin.com/jobs/","*://*.linkedin.com/notifications/","*://*.linkedin.com/messaging/*","*://*.linkedin.com/in/*","*://analytics.amplitude.com/*","*://*.atlassian.*/*","*://online.citi.com/*","*://www.chase.com/*","*://www.bankofamerica.com/*","*://*.paypal.com/*","*://*.intuit.com/*","*://*.docusign.com/*","*://connect.secure.wellsfargo.com/*","*://www.pornhub.com/*","*://xhamster.com/*","*://www.redtube.com/*","*://www.youporn.com/*","*://beeg.com/*","*://smutr.com/*","*://pornone.com/*","*://www.tube8.com/*","*://www.xvideos.com/*","*://www.xnxx.com/*","*://www.creditkarma.com/*","*://sso2.opower.com/*"];function l(){return-1!==navigator.userAgent.indexOf("Safari")&&-1===navigator.userAgent.indexOf("Chrome")&&-1===navigator.userAgent.indexOf("Chromium")}function d(){const e=l()?"safari":"chrome";new amplitude.Identify;let t=(new amplitude.Identify).set(`${e}Extension`,"installed");amplitude.getInstance().identify(t)}function u(e,t){"on"==e?(chrome.browserAction.setIcon({path:"images/48.png",tabId:t}),chrome.browserAction.setBadgeText({text:"",tabId:t})):("off"==e||"prohibited"==e)&&(chrome.browserAction.setIcon({path:"images/48_gray.png",tabId:t}),chrome.browserAction.setBadgeBackgroundColor({color:"#777777",tabId:t}),chrome.browserAction.setBadgeText({text:"Off",tabId:t}))}function h(e,t){e?alert("Due to technical reasons, you cannot highlight on this website.\n\nPlease go to other websites to start highlighting :)"):(amplitude.getInstance().logEvent("sidebar_toggle",{type:"clicked_btn"}),chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(e){if(!e||!e[0]||"file:"!=new URL(e[0].url).protocol)return null===o.uid||void 0===o.uid||""===o.uid?(console.log("browserAction - case (1): uid null"),chrome.tabs.sendMessage(e[0].id,{action:"sidebar_toggle"}),void d()):(o.uid&&""!==o.uid&&(amplitude.getInstance().setUserId(o.uid),o.displayName&&""!==o.displayName&&d()),o.userAccountCreated?(console.log("browserAction - case (2): user account created"),chrome.tabs.sendMessage(e[0].id,{action:"load_again"}),o.userAccountCreated=!1,o.highlighterMode="on",u(o.highlighterMode,t),void chrome.tabs.sendMessage(e[0].id,{action:"sidebar_toggle"})):o.viewingOthersHLs?(console.log("browserAction - case (3): viewing other's HLs"),chrome.tabs.sendMessage(e[0].id,{action:"sidebar_toggle"}),"on"===o.highlighterMode&&(o.highlighterMode="off",u(o.highlighterMode,t)),void chrome.tabs.sendMessage(e[0].id,{action:`highlighter_${o.highlighterMode}`})):void("on"===o.highlighterMode?(console.log("browserAction - case (4): highlighter ON"),u(o.highlighterMode,t),chrome.tabs.sendMessage(e[0].id,{action:"sidebar_toggle"}),chrome.tabs.sendMessage(e[0].id,{action:`highlighter_${o.highlighterMode}`})):(console.log("browserAction - case (5): highlighter OFF"),u(o.highlighterMode,t),chrome.tabs.sendMessage(e[0].id,{action:"sidebar_toggle"}),chrome.tabs.sendMessage(e[0].id,{action:`highlighter_${o.highlighterMode}`}))));alert("You cannot highlight on local files. Please go to other websites to start highlighting :)")})))}function g(e){chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{action:"exclude_domain",data:e})}))}function f(e,t){if(!e)return!1;const o=new URL(e).host;return Array.from(t).some(((e,t,n)=>{if(e[1].domain==o&&e[1].exclude)return!0}))}function m(e,t){const n=/((?:http|https|ftp|ftps|chrome|\*)?):\/\/([^\/]+)(\/.*)?/;for(let o=0;o<r.length;o++){let i,s="";if(null!==(i=r[o].match(n))&&(s=i[1].replace(/\*$/,"[^/]*")+"://"+i[2].replace(/[?()[\]\\.+^$|]/g,"\\$&").replace(/\*\\./g,"(?:[^/]*\\.)*").replace(/\*$/,"[^/]*"),i[3]&&(s+=i[3].replace(/[?()[\]\\.+^$|]/g,"\\$&").replace(/\/\*(?=$|\/)/g,"(?:/[^]*)?"))),s){let o=RegExp("^"+s+"$","i");if(e.match(o))return t&&u("prohibited",t),!0}}return t&&u(o.highlighterMode,t),!1}function p(e,t,n){if(o.excludedDomain=m(e,t?.id),o.userExcludedDomain=f(e,o.domainExcludeList),o.highlighterMode=o.excludedDomain||o.userExcludedDomain?"off":"on",o.excludedDomain)return u(o.highlighterMode,t.id),void chrome.tabs.sendMessage(t.id,{action:"highlighter_off"});o.userExcludedDomain&&(u(o.highlighterMode,t.id),chrome.tabs.sendMessage(t.id,{action:"highlighter_off"})),void 0!==t&&""!==e&&(console.log(`you are here (${n}): `+e),u(o.highlighterMode,t.id),chrome.tabs.sendMessage(t.id,{action:"run_initialLoad"}),chrome.tabs.sendMessage(t.id,{action:"sidebar_width",data:o.sidebarWidth}),chrome.tabs.sendMessage(t.id,{action:"visibility_status",data:o.visibilityStatus}),d())}function _(e,t,o,n){let i=[],s=[],c="",a=!1;const r=o.uid;e.collection("users").doc(r).collection("highlights").where("url","==",t).get().then((function(e){e.forEach((function(e){const t=e.data();a=!0;for(let e=0;e<t.highlights.length;e++)i.push(t.highlights[e]);"tag"in t&&(s=t.tag),"pagenote"in t&&""!==t.pagenote&&(c=t.pagenote)})),chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(e){a&&chrome.tabs.sendMessage(e[0].id,{action:"highlight_load",data:i}),chrome.tabs.sendMessage(e[0].id,{action:"ready_to_scan_highlights",data:i}),chrome.tabs.sendMessage(e[0].id,{action:"tag_data_on_load_others",data:s}),chrome.tabs.sendMessage(e[0].id,{action:"pagenote_on_load_others",data:c}),chrome.tabs.sendMessage(e[0].id,{action:"other_user_data",data:[o,n]})}))})).catch((function(e){console.log("Error getting documents: ",e)}))}function b(){o.uid||firebase.auth().onAuthStateChanged((async function(t){t&&(o.uid=t.uid,o.docRef=e.collection("users").doc(o.uid),o.docRef.get().then((function(e){const t=e.data();o.displayName=t.displayName?t.displayName:"",o.username=t.username?t.username:"",o.photoURL=t.photoURL?t.photoURL:chrome.runtime.getURL("/images/userphoto.png")})).catch((function(e){console.log("Error getting documents: ",e)})),o.domainExcludeList=await function(e,t){return e.collection("users").doc(t).collection("excludedDomainList").orderBy("lastUpdated","asc").get().then((e=>{const t=[];return e.forEach((function(e){e.exists&&t.push([e.id,e.data()])})),t})).catch((function(e){console.log("Error getting documents: ",e)}))}(e,o.uid),function(t){const i=e.collection("extension_errors"),c=new s(i,t.uid,navigator.userAgent);o.errorReporter=new n({reporter:c})}(t))}))}function w(e,t,n){if(void 0!==o.newHLsDataForSort){let i=o.newHLsDataForSort,s=[];i.highlights&&(s=i.highlights);for(let t=0;t<e.length;t+=2)for(let o=0;o<s.length;o++)if(e[t]===s[o].highlightid){let e=t/2;s[o].orderId=e}chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(e){chrome.tabs.sendMessage(e[0].id,{action:"sorted_highlights_list",data:[s,t,n]})})),o.highlightRefForSort.update(i).then((function(){console.log("HLs Order Updated!"),o.newHLsDataForSort="",o.highlightRefForSort=""})).catch((function(e){console.log("Got an error: ",e)}))}}!function(e,t){var o=e.amplitude||{_q:[],_iq:{}},n=t.createElement("script");n.type="text/javascript",n.integrity="sha384-girahbTbYZ9tT03PWWj0mEVgyxtZoyDF9KVZdL+R53PP5wCY0PiVUKq0jeRlMx9M",n.crossOrigin="anonymous",n.async=!0,n.src="https://cdn.amplitude.com/libs/amplitude-7.2.1-min.gz.js",n.onload=function(){e.amplitude.runQueuedFunctions||console.log("[Amplitude] Error: could not load SDK")};var i=t.getElementsByTagName("script")[0];function s(e,t){e.prototype[t]=function(){return this._q.push([t].concat(Array.prototype.slice.call(arguments,0))),this}}i.parentNode.insertBefore(n,i);for(var c=function(){return this._q=[],this},a=["add","append","clearAll","prepend","set","setOnce","unset"],r=0;r<a.length;r++)s(c,a[r]);o.Identify=c;for(var l=function(){return this._q=[],this},d=["setProductId","setQuantity","setPrice","setRevenueType","setEventProperties"],u=0;u<d.length;u++)s(l,d[u]);o.Revenue=l;var h=["init","logEvent","logRevenue","setUserId","setUserProperties","setOptOut","setVersionName","setDomain","setDeviceId","enableTracking","setGlobalUserProperties","identify","clearUserProperties","setGroup","logRevenueV2","regenerateDeviceId","groupIdentify","onInit","logEventWithTimestamp","logEventWithGroups","setSessionId","resetSessionId"];function g(e){function t(t){e[t]=function(){e._q.push([t].concat(Array.prototype.slice.call(arguments,0)))}}for(var o=0;o<h.length;o++)t(h[o])}g(o),o.getInstance=function(e){return e=(e&&0!==e.length?e:"$default_instance").toLowerCase(),o._iq.hasOwnProperty(e)||(o._iq[e]={_q:[]},g(o._iq[e])),o._iq[e]},e.amplitude=o}(window,document),window.amplitude.getInstance().init("3dbc00534530196e77736311cda9138e"),window.onload=function(){b()},window.onerror=(e,t,n,s,c)=>{const a=new i({message:e,source:t,lineno:n,colno:s,error:c});if(!o.errorReporter)throw c;o.errorReporter.report(a).then((function(){throw c}))},chrome.runtime.onInstalled.addListener((function(e){if("install"===e.reason){chrome.tabs.create({url:"https://glasp.co/welcome"});const e=l()?"safari":"chrome";amplitude.getInstance().logEvent(`${e}_extension_install`),new amplitude.Identify;const t=(new amplitude.Identify).set(`${e}Extension`,"installed");amplitude.getInstance().identify(t)}})),chrome.runtime.setUninstallURL("https://glasp.co/uninstall"),chrome.tabs.onActivated.addListener((function(e){chrome.tabs.get(e.tabId,(function(e){o.highlighterMode="on",o.viewingOthersHLs=!1,o.currURL=e.url,p(e.url,e,"activated")}))})),chrome.tabs.onCreated.addListener((function(e){o.currURL=e.url,p(e.url,e,"created")})),chrome.tabs.onUpdated.addListener(((e,t,n)=>{if(n.active&&n.url){o.highlighterMode="on",o.viewingOthersHLs=!1;const e=new URL(n.url),t=function(e){const t=e&&""!==e?e:window.location.search;if(!/\?([a-zA-Z0-9_]+)/i.exec(t))return{};let o,n=/\+/g,i=/([^?&=]+)=?([^&]*)/g,s=function(e){return decodeURIComponent(e.replace(n," "))},c=/\?([a-zA-Z0-9_]+)/i.exec(t).index+1,a=t.substring(c),r={};for(;o=i.exec(a);)r[s(o[1])]=s(o[2]);return r}(e.href);if("www.youtube.com"===e.hostname&&t.v)if(console.log("YouTube Video (update tab)"),o.userSignedIn){if(o.currURL===n.url)return;chrome.tabs.sendMessage(n.id,{action:"yt_transcript_btn_create"})}else o.currURL!==n.url&&chrome.tabs.sendMessage(n.id,{action:"yt_transcript_btn_create"}),o.currURL=n.url,p(n.url,n,"updated");if(o.currURL===n.url&&o.sidebarOpen&&o.userSignedIn)return void console.log("+++++ (currURL == tab.url) +++++");o.currURL=n.url,p(n.url,n,"updated")}})),chrome.tabs.onRemoved.addListener(((e,t)=>{chrome.tabs.query({active:!0,lastFocusedWindow:!0},(e=>{0!==e.length&&(o.currURL=e[0].url,p(e[0].url,e[0],"removed"))}))})),chrome.tabs.query({active:!0,lastFocusedWindow:!0},(e=>{void 0!==e[0]&&(o.currURL=e[0].url,p(e[0].url,e[0],"tab query"))})),chrome.contextMenus.removeAll((function(){chrome.contextMenus.create({id:"highlight",title:"Highlight Text",contexts:["selection"]})})),chrome.contextMenus.onClicked.addListener((function(e,t){if("highlight"===e.menuItemId){if(o.excludedDomain)return void alert("Due to technical reasons, you cannot highlight on this website.\n\nPlease go to other websites to start highlighting :)");if(e.pageUrl){const t=new URL(e.pageUrl);if("file:"==t.protocol||"localhost"==t.hostname)return;if("/pdf/web/viewer.html"==t.pathname&&t.search&&t.search.includes("?file=")){const e=new URL(t.search.replace("?file=",""));if("file:"==e.protocol||"localhost"==e.hostname)return}}o.uid?o.viewingOthersHLs||o.excludedDomain||o.userExcludedDomain||chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(e){chrome.tabs.sendMessage(e[0].id,{action:"highlight_from_context"}),amplitude.getInstance().logEvent("highlight_via_right_click",{type:"after_sign_in"})})):(h(o.excludedDomain),amplitude.getInstance().logEvent("highlight_via_right_click",{type:"before_sign_in"}))}else if("highlight_image"===e.menuItemId){if(console.log("info: ",e),o.excludedDomain)return void alert("Due to technical reasons, you cannot highlight on this website.\n\nPlease go to other websites to start highlighting :)");if(o.uid&&!o.viewingOthersHLs&&!o.excludedDomain&&!o.userExcludedDomain&&e.srcUrl){const t=e.srcUrl;console.log("imgURL: ",t)}}})),chrome.runtime.onMessage.addListener((function(t,n,i){if(t.action&&"initial_load"===t.action)o.url=t.data[0],o.fullUrl=t.data[1],o.highlighterMode=t.data[2],u(o.highlighterMode),console.log("url in initial_load: ",o.url),o.uid&&c(o.url,e,o.uid,o.displayName,o.photoURL,o.username);else if(t.action&&"load_shared_user"===t.action){const i=t.data[0];o.highlighterMode=t.data[1],u(o.highlighterMode),o.viewingOthersHLs=!0,o.uid&&chrome.tabs.sendMessage(n.tab.id,{action:"receive_uid",data:[o.displayName,o.photoURL,o.uid]});let s={uid:o.uid,displayName:o.displayName,photoURL:o.photoURL,username:o.username};!function(e,t,o,n){e.collection("users").doc(t).get().then((function(t){if(t.exists){const n={uid:t.data().uid,username:t.data().username,displayName:t.data().displayName,photoURL:t.data().photoURL};_(e,o,n,!0)}else{const{uid:t,displayName:i,photoURL:s,username:a}=n;t&&c(o,e,t,i,s,a)}})).catch((function(e){console.log("Error getting documents: ",e)}))}(e,i,o.url,s),amplitude.getInstance().logEvent("open_shared_link",{type:"load_link"})}else if(t.action&&"run_initApp"===t.action)b();else if(t.action&&"browser_icon_change"===t.action)o.highlighterMode=t.data,chrome.tabs.query({active:!0,lastFocusedWindow:!0},(e=>{0!==e.length&&u(o.highlighterMode,e[0].id)}));else if(t.action&&"viewing_others_highlights"===t.action)o.viewingOthersHLs=t.data;else if(t.action&&"sidebar_status_change"===t.action)o.sidebarOpen=t.data[0],o.sidebarWidth=t.data[1];else if(t.action&&"google_signin"===t.action)!function(){const t=firebase.auth().currentUser;if(t)o.uid=t.uid,o.docRef=e.collection("users").doc(o.uid),chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(e){chrome.tabs.sendMessage(e[0].id,{action:"user_data",data:[o.displayName,o.photoURL,o.uid,o.username]}),chrome.tabs.sendMessage(e[0].id,{action:"sidebar_toggle"})})),amplitude.getInstance().logEvent("login",{type:"google",action:"completed",place:"chrome_extension"});else{if(l())return void(window.parent.location="https://glasp.co/login");let t=new firebase.auth.GoogleAuthProvider;firebase.auth().signInWithPopup(t).then((function(t){const n=t.user;o.displayName=n.displayName,o.email=n.email,o.photoURL=n.photoURL,o.emailVerified=n.emailVerified,console.log("googlePoupuSignIn2 uid: ",o.uid),o.uid=n.uid,o.providerData=n.providerData,o.docRef=e.collection("users").doc(o.uid),o.docRef.get().then((function(t){if(t.exists)chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(e){chrome.tabs.sendMessage(e[0].id,{action:"load_again"}),o.userAccountCreated=!1,o.highlighterMode="on",u(o.highlighterMode),chrome.tabs.sendMessage(e[0].id,{action:"sidebar_toggle"})})),amplitude.getInstance().logEvent("login",{type:"google",action:"completed",place:"chrome_extension"});else{const t=Date.now(),n=Math.random().toString(36).substring(2,10)+Math.random().toString(36).substring(2,10);o.username=n;const i={uid:o.uid,username:n,displayName:o.displayName,bio:"",photoURL:o.photoURL,createdOn:t},s={uid:o.uid,username:n,displayName:o.displayName,email:o.email,photoURL:o.photoURL,emailVerified:o.emailVerified,providerData:Object.assign({},o.providerData[0]),createdOn:t},c={uid:o.uid,username:n},a=o.docRef.set(i).then((()=>{})),r=o.docRef.collection("user_private_info").doc(o.uid).set(s).then((()=>{})),l=e.collection("username").doc("QEKjAHWpKUmW0ha4tdlb").update({usernameList:firebase.firestore.FieldValue.arrayUnion(c)}).then((()=>{}));Promise.all([a,r,l]).then((()=>{chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(e){chrome.tabs.sendMessage(e[0].id,{action:"load_again"}),o.userAccountCreated=!0,o.highlighterMode="on",u(o.highlighterMode),chrome.tabs.sendMessage(e[0].id,{action:"sidebar_toggle"})})),amplitude.getInstance().logEvent("signup",{type:"google",action:"completed",place:"chrome_extension"})})).catch((function(e){console.log(e)}))}})).catch((function(e){console.log(e)}))})).catch((function(e){console.log(e)}))}}();else if(t.action&&"user_list_load"===t.action){const o=t.data;!function(e,t){let o,n=[];e.collection("urls").where("url","==",t).get().then((function(e){console.log("url in loadUserListData:",t);for(let i in e.docs){const s=e.docs[i];if(s.data().url==t){o=s.data(),n=o.userList;break}}})).catch((function(e){console.log("Error getting documents: ",e)})).then((()=>{chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(e){const t=e[0];chrome.tabs.sendMessage(t.id,{action:"user_list_data",data:n})}))})).catch((function(e){console.log("Error getting documents: ",e)}))}(e,o),amplitude.getInstance().logEvent("sidebar_user_list",{type:"pulldown_click"})}else if(t.action&&"load_others_highlight"===t.action){const n=t.data[0],i=t.data[1];n.uid!==o.uid&&amplitude.getInstance().logEvent("sidebar_user_list",{type:"select_another_user"}),_(e,i,n)}else if(t.action&&"user_signout"===t.action)o.displayName="",o.username="",o.photoURL="",o.uid="",o.docRef="",firebase.auth().signOut().then((()=>{"https://glasp.co/welcome"===o.currURL&&chrome.tabs.sendMessage(n.tab.id,{action:"esacape_welcome_page"})})),amplitude.getInstance().logEvent("sign_out",{type:"btn_click"});else if(t.action&&"highlight_store"===t.action){const n=t.data[0],i=t.data[1],s=n.colorId;amplitude.getInstance().logEvent("highlight_store",{type:"btn_click",color:s}),function(t,n){null!==o.uid&&void 0!==o.uid||b();const i=Date.now(),s=/>textNode:nth-of-type\(([0-9]+)\)$/i,c=t.selectionString,r=t.url,l=t.anchorOffset,d=t.focusOffset,u=t.containerQuery,h=t.anchorNodeQuery,g=t.focusNodeQuery,f=t.colorId,m=t.pageTitle,p=t.pageThumbnailPhoto,_=t.fullUrl,w=t.highlightid,y=t.yt_transcript_start??0,L=t.yt_transcript_lang??"";let v,E,U,x,I,R,O,M;h.length===g.length?h===g?l<d?(v=h,E=g,U=l,x=d):(v=g,E=h,U=d,x=l):h<g?(v=h,E=g,U=l,x=d):(v=g,E=h,U=d,x=l):h.length<g.length?(v=h,E=g,U=l,x=d):(v=g,E=h,U=d,x=l),I=E.replace(s,""),R=parseInt(s.exec(E)[1]);let N=[],k=[];function D(t,n){const s=n[0];e.collection("users").doc(o.uid).collection("highlights").doc(s).get().then((c=>{const l=c.data();l.highlights=Object.assign([],t),e.collection("users").doc(o.uid).collection("highlights").doc(s).update(l).then((()=>{const t=[];for(let i=1;i<n.length;i++){const s=e.collection("users").doc(o.uid).collection("highlights").doc(n[i]).delete().then((()=>{})).catch((function(e){console.log("Error getting documents: ",e)}));t.push(s)}Promise.all(t).then((()=>{a(r,_,i,m,p,null,e,o.urlCollection,o.uid,o.displayName,o.photoURL),console.log("aggreated all the documents & deleted extras")})).catch((function(e){console.log("Error deleting documents: ",e)}))})).catch((function(e){console.log("Error getting documents: ",e)}))})).catch((function(e){console.log("Error getting documents: ",e)}))}e.collection("users").doc(o.uid).collection("highlights").where("url","==",r).get().then((function(t){const a=t.docs.length;if(t.forEach((function(t){if(k.push(t.id),O=t.data(),M=e.collection("users").doc(o.uid).collection("highlights").doc(t.id),O.title=m,O.thumbnail=p,O.url=r,O.fullUrl=_,O.lastUpdated=i,"highlights"in O)for(let e=0;e<O.highlights.length;e++)N.push(O.highlights[e])})),N.length>0)for(let e=0;e<N.length;e++){let t,o,n,i,c,a,r=N[e].anchorNode,l=N[e].focusNode,d=(N[e].anchorOffset,N[e].focusOffset,r.replace(s,"")),u=l.replace(s,"");if(d.length===I.length){if(d<I)continue;if(d>I)continue}else if(d.length<I.length)continue;if(d===I&&u===I){if(t=parseInt(s.exec(r)[1]),o=parseInt(s.exec(l)[1]),t<R)continue;U>0?(t-R==0&&(N[e].anchorOffset=N[e].anchorOffset-x,o-R==0&&(N[e].focusOffset=N[e].focusOffset-x)),n=t+2,i=o+2,c=">textNode:nth-of-type("+n+")",a=">textNode:nth-of-type("+i+")"):0===U&&(t-R==0&&(N[e].anchorOffset=N[e].anchorOffset-x,o-R==0&&(N[e].focusOffset=N[e].focusOffset-x)),n=t+1,i=o+1,c=">textNode:nth-of-type("+n+")",a=">textNode:nth-of-type("+i+")"),N[e].anchorNode=N[e].anchorNode.replace(s,c),N[e].focusNode=N[e].focusNode.replace(s,a)}else if(d===I){if(t=parseInt(s.exec(r)[1]),t<R)continue;U>0?(t-R==0&&(N[e].anchorOffset=N[e].anchorOffset-x),n=t+2,c=">textNode:nth-of-type("+n+")"):0===U&&(t-R==0&&(N[e].anchorOffset=N[e].anchorOffset-x),n=t+1,c=">textNode:nth-of-type("+n+")"),N[e].anchorNode=N[e].anchorNode.replace(s,c)}}const l={version:chrome.runtime.getManifest().version,string:c,container:u,anchorNode:v,anchorOffset:U,focusNode:E,focusOffset:x,colorId:f,highlightid:w,timestamp:i,yt_transcript_start:y,yt_transcript_lang:L};N.push(l),N=Object.assign([],N);for(let e=0;e<n.length;e+=2)for(let t=0;t<N.length;t++)if(n[e]===N[t].highlightid){const o=e/2;N[t].orderId=o;break}return 0===a?O={url:r,fullUrl:_,title:m,thumbnail:p,lastUpdated:i,highlights:N}:a>=1&&(O.highlights=N),chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(e){chrome.tabs.sendMessage(e[0].id,{action:"sorted_highlights_list",data:[O.highlights,w,"store"]})})),a})).then((t=>{0===t?e.collection("users").doc(o.uid).collection("highlights").add(O).then((function(){amplitude.getInstance().logEvent("highlight_store_in_server"),function(){let t=[],n=[];null!==o.uid&&void 0!==o.uid||b(),e.collection("users").doc(o.uid).collection("highlights").where("url","==",r).get().then((function(s){const c=s.docs.length;s.forEach((function(e){const o=e.data();n.push(e.id);for(let e=0;e<o.highlights.length;e++){let n=!1;for(let i=0;i<t.length;i++)if(t[i].string===o.highlights[e].string){n=!0;break}n||t.push(o.highlights[e])}})),c>1?(D(t,n),amplitude.getInstance().logEvent("extension_aggregate_hl_docs")):a(r,_,i,m,p,null,e,o.urlCollection,o.uid,o.displayName,o.photoURL)})).catch((function(e){console.log("Error getting documents: ",e)}))}()})).catch((function(e){console.log("Got an error: ",e)})):1===t?M.update(O).then((function(){console.log("Highlights Stored!"),amplitude.getInstance().logEvent("highlight_store_in_server"),a(r,_,i,m,p,null,e,o.urlCollection,o.uid,o.displayName,o.photoURL)})).catch((function(e){console.log("Got an error: ",e)})):t>1&&(D(N,k),amplitude.getInstance().logEvent("extension_aggregate_hl_docs"))})).catch((function(e){console.log("Got an error: ",e)}))}(n,i)}else if(t.action&&"highlight_delete"===t.action){const n=t.data[0],i=t.data[1],s=(t.data[2],t.data[3]);amplitude.getInstance().logEvent("highlight_delete",{type:"btn_click"}),function(t,n,i,s){const c=/>textNode:nth-of-type\(([0-9]+)\)$/i;let a,r,l;e.collection("users").doc(o.uid).collection("highlights").where("url","==",t).get().then((function(t){t.forEach((function(t){a=t.data(),r=e.collection("users").doc(o.uid).collection("highlights").doc(t.id),l=a.highlights}))})).then((function(){let e,i,d,u,h,g,f;if(void 0!==l&&l.length>0)if(1===l.length)l.splice(0,1),r.update(a).then((function(){!function(e,t,o){t.where("url","==",e).get().then((async function(e){for(let n in e.docs){const i=e.docs[n],s=i.data().userList;if(1==s.length)return await t.doc(i.id).update({lastUpdated:0,userList:[]}).then((function(){})).catch((function(e){console.log("Error updating documents: ",e)}));{let e=0;Array.from(s).forEach(((t,n,i)=>{t.uid!=o?t.timestamp>e&&(e=t.timestamp):s.splice(n,1)}));const n=Object.assign([],s);return await t.doc(i.id).update({lastUpdated:e,userList:n}).then((function(){})).catch((function(e){console.log("Error updating documents: ",e)}))}}})).catch((function(e){console.log("Error updating documents: ",e)}))}(t,o.urlCollection,o.uid)})).then((function(){chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(e){chrome.tabs.sendMessage(e[0].id,{action:"sorted_highlights_list",data:[l,n,"delete"]})}))})).catch((function(e){console.log("Got an error: ",e)}));else{for(let t=0;t<l.length;t++)if(l[t].highlightid===n){e=l[t].anchorNode,i=l[t].focusNode,d=l[t].anchorOffset,u=l[t].focusOffset,h=i.replace(c,""),g=parseInt(c.exec(i)[1]),l.splice(t,1),f=t;break}for(let e=f;e<l.length;e++){let t,o,n,i,s,a,r,f,m,p,_,b;if(t=l[e].anchorNode,o=l[e].focusNode,n=l[e].anchorOffset,i=l[e].focusOffset,s=t.replace(c,""),a=o.replace(c,""),s.length===h.length){if(s<h)continue;if(s>h)continue}else if(s.length<h.length)continue;if(s===h&&a===h){if(r=parseInt(c.exec(t)[1]),f=parseInt(c.exec(o)[1]),r<g)continue;d>0?(r-g==2&&(l[e].anchorOffset=l[e].anchorOffset+u,f-g==2&&(l[e].focusOffset=l[e].focusOffset+u)),m=r-2,p=f-2,_=">textNode:nth-of-type("+m+")",b=">textNode:nth-of-type("+p+")"):0===d&&(r-g==1&&(l[e].anchorOffset=l[e].anchorOffset+u,f-g==1&&(l[e].focusOffset=l[e].focusOffset+u)),m=r-1,p=f-1,_=">textNode:nth-of-type("+m+")",b=">textNode:nth-of-type("+p+")"),l[e].anchorNode=l[e].anchorNode.replace(c,_),l[e].focusNode=l[e].focusNode.replace(c,b)}else if(s===h){if(r=parseInt(c.exec(t)[1]),f=parseInt(c.exec(o)[1]),r<g)continue;d>0?(r-g==2&&(l[e].anchorOffset=l[e].anchorOffset+u),m=r-2,_=">textNode:nth-of-type("+m+")"):0===d&&(r-g==1&&(l[e].anchorOffset=l[e].anchorOffset+u),m=r-1,_=">textNode:nth-of-type("+m+")"),l[e].anchorNode=l[e].anchorNode.replace(c,_)}}l=Object.assign([],l),o.newHLsDataForSort=a,o.highlightRefForSort=r,w(s,n,"delete")}})).catch((function(e){console.log("Error deleting documents: ",e)}))}(n,i,0,s)}else if(t.action&&"highlight_change_color"===t.action){const n=t.data[0],i=t.data[1],s=t.data[2];t.data[3],function(e,t,o,n,i,s){e.collection("users").doc(t).collection("highlights").where("url","==",o).get().then((function(o){o.forEach((function(o){let s=o.data();const c=e.collection("users").doc(t).collection("highlights").doc(o.id);let a=s.highlights;const r=Date.now();if(a){const e=a.findIndex((e=>e.highlightid==n)),t=a[e].colorId;a[e].colorId=i,a[e].timestamp=r,c.update(s).then((function(){console.log("Highlight color changed!"),chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(e){chrome.tabs.sendMessage(e[0].id,{action:"sorted_highlights_list",data:[a,n,"color_change"]})})),amplitude.getInstance().logEvent("highlight_color_change",{type:"btn_click",originalColor:t,newColor:i})})).catch((function(e){console.log("Got an error: ",e)}))}}))})).catch((function(e){console.log("Error getting documents: ",e)}))}(e,o.uid,n,i,s)}else if(t.action&&"highlight_note_added"===t.action){console.log("highlight_note_added run");const n=t.data[0],s=t.data[1],c=t.data[2],r=t.data[3];console.log("highlight note: ",t.data),async function(e,t,o,n,i,s,c,r,l){return await i.collection("users").doc(c).collection("highlights").where("url","==",o).get().then((async function(d){console.log("storeNote run");for(let u in d.docs){const h=d.docs[u];let g=h.data();const f=Date.now(),m=g.title,p=g.thumbnail;let _=g.highlights;const b=_.findIndex((t=>t.highlightid==e));_[b].note=t,_[b].timestamp=f,g.lastUpdated=f,await i.collection("users").doc(c).collection("highlights").doc(h.id).update(g).then((async function(){console.log("storeNote done"),amplitude.getInstance().logEvent("highlight_note"),await a(o,n,f,m,p,null,i,s,c,r,l)}))}}))}(n,s,c,r,e,o.urlCollection,o.uid,o.displayName,o.photoURL).then((()=>{console.log("stored highlight note"),amplitude.getInstance().logEvent("stored_highlight_note"),i({result:"success"})})).catch((function(e){console.error("Error getting documents: ",e)}))}else if(t.action&&"highlight_order_sort"===t.action)w(t.data[0],t.data[1],"store");else if(t.action&&"tag_add"===t.action){const n=t.data,i=n.url,s=n.fullUrl,c=n.userTagList,a=n.newTagInput,r=n.title,l=n.thumbnail;amplitude.getInstance().logEvent("tag_store"),function(e,t,o,n,i,s,c,a,r,l,d){let u;const h=()=>r.where("url","==",e).get().then((function(n){let c=!1;for(let e in n.docs){c=!0;const t=n.docs[e];let i=t.data();u=t.id;const s=r.doc(t.id);for(let e=0;e<i.userList.length;e++)if(i.userList[e].uid==a){i.userList[e].tag=o;break}return s.set(i).then((()=>t.id)).catch((function(e){console.log("Error getting documents: ",e)}))}if(!c){const n=0,c=Object.assign({},{uid:a,displayName:d,photoURL:l,timestamp:n,tag:o}),h=[];h.push(c);const g=Object.assign([],h),f=Object.assign({},{url:e,fullUrl:t,title:i,thumbnail:s,lastUpdated:n,userList:g});return r.add(f).then((e=>(u=e.id,u))).catch((function(e){console.error("Error adding document: ",e)}))}})).catch((function(e){console.log("Error getting documents: ",e)}));!async function(){c.collection("users").doc(a).collection("highlights").where("url","==",e).get().then((function(n){let r=!1;const l=Date.now();for(let e in n.docs){r=!0;const t=n.docs[e];let i=t.data();const s=c.doc(`users/${a}/highlights/${t.id}`);return i.tag=o,s.update(i).then((()=>{})).catch((function(e){console.log("Error setting doc: ",e)}))}if(!r){const n=[],r=Object.assign([],n),d=Object.assign([],o),u=Object.assign({},{url:e,fullUrl:t,title:i,thumbnail:s,lastUpdated:l,highlights:r,tag:d});return c.collection("users").doc(a).collection("highlights").add(Object.assign({},u)).then((()=>{})).catch((function(e){console.log("Error setting doc: ",e)}))}})).catch((function(e){console.log("Error getting documents: ",e)}));const r=await h();await(o=>c.collection("tags").where("tag","==",n).get().then((function(r){let u=!1;for(let n in r.docs){const h=r.docs[n];u=!0;let g=h.data();const f=c.collection("tags").doc(h.id);let m=!1,p=!1;for(let t=0;t<g.urlList.length;t++)if(g.urlList[t].url==e){g.urlList[t].numOfUser+=1,m=!0;break}if(!m){const n={url:e,fullUrl:t,thumbnail:s,title:i,urlDocId:o,numOfUser:1};g.urlList.push(n)}for(let e=0;e<g.userList.length;e++)if(g.userList[e].uid==a){g.userList[e].tagCount+=1,p=!0;break}if(!p){const e={uid:a,displayName:d,photoURL:l,tagCount:1};g.userList.push(e)}const _=Object.assign({},g);return f.set(_).then((()=>{})).catch((function(e){console.log("Error getting documents: ",e)}))}if(!u){const r=parseInt(1),u=parseInt(1),h=Object.assign({},{url:e,fullUrl:t,thumbnail:s,title:i,urlDocId:o,numOfUser:r}),g=[];g.push(h);const f=Object.assign([],g),m=Object.assign({},{uid:a,displayName:d,photoURL:l,tagCount:u}),p=[];p.push(m);const _=Object.assign([],p),b=Object.assign({},{tag:n,urlList:f,userList:_});return c.collection("tags").add(b).then((()=>{})).catch((function(e){console.log("Error getting documents: ",e)}))}})).catch((function(e){console.log("Error getting documents: ",e)})))(r)}()}(i,s,c,a,r,l,e,o.uid,o.urlCollection,o.photoURL,o.displayName)}else if(t.action&&"tag_delete"===t.action){const n=t.data,i=n.url,s=(n.fullUrl,n.userTagList),c=n.tagString;n.title,n.thumbnail,amplitude.getInstance().logEvent("tag_delete"),function(e,t,o,n,i,s,c,a,r){let l;const d=c.collection("users").doc(r).collection("highlights").where("url","==",e).get().then((function(e){for(let t in e.docs){const n=e.docs[t];let i=n.data();const s=c.doc(`users/${r}/highlights/${n.id}`);i.tag=o,s.update(i).then((()=>{})).catch((function(e){console.log("Error setting doc: ",e)}));break}})).catch((function(e){console.log("Error getting documents: ",e)})),u=a.where("url","==",e).get().then((function(e){for(let t in e.docs){const n=e.docs[t];let i=n.data();l=n.id;const s=a.doc(n.id);for(let e=0;e<i.userList.length;e++)if(i.userList[e].uid==r){i.userList[e].tag=o;break}s.set(i).then((()=>{})).catch((function(e){console.log("Error getting documents: ",e)}));break}})).catch((function(e){console.log("Error getting documents: ",e)})),h=c.collection("tags").where("tag","==",n).get().then((async function(t){for(let o in t.docs){const n=t.docs[o],i=n.data(),s=c.collection("tags").doc(n.id);for(let t=0;t<i.urlList.length;t++)if(i.urlList[t].url==e){i.urlList[t].numOfUser-=1,0==i.urlList[t].numOfUser&&i.urlList.splice(t,1);break}for(let e=0;e<i.userList.length;e++)if(i.userList[e].uid==r){i.userList[e].tagCount-=1,0==i.userList[e].tagCount&&i.userList.splice(e,1);break}0==i.urlList.length&&0==i.userList.length&&(i.userList=[],i.urlList=[]),await s.set(i).then((function(){})).catch((e=>{console.log("Error deleting document: ",e)}));break}})).catch((function(e){console.log("Error getting documents: ",e)}));Promise.all([d,u,h]).then((function(){console.log("Tag updated in whole collections!")})).catch((function(e){console.log("Error updating tag information: ",e)}))}(i,0,s,c,0,0,e,o.urlCollection,o.uid)}else if(t.action&&"pagenote_store"===t.action){console.log("pagenote_store");const n=t.data;(async function(e,t,o,n,i,s,c,r,l,d){return s.collection("users").doc(r).collection("highlights").where("url","==",e).get().then((function(u){let h=!1;const g=Date.now(),f=[];if(0==u.docs.length){const c=Object.assign([],[]),a={url:e,fullUrl:t,title:n,thumbnail:i,lastUpdated:g,highlights:c,pagenote:o},l=s.collection("users").doc(r).collection("highlights").add(a).then((()=>{})).catch((function(e){console.log("Error setting doc: ",e)}));f.push(l)}else for(let e in u.docs){h=!0;const t=u.docs[e];let n=t.data();const i=s.doc(`users/${r}/highlights/${t.id}`);n.pagenote=o;const c=i.update(n).then((()=>{})).catch((function(e){console.log("Error setting doc: ",e)}));f.push(c);break}Promise.all(f).then((()=>{a(e,t,g,n,i,o,s,c,r,l,d)})).catch((function(e){console.log("Error setting doc: ",e)}))})).catch((function(e){console.log("Got an error: ",e)}))})(n.url,n.fullUrl,n.pagenote,n.title,n.thumbnail,e,o.urlCollection,o.uid,o.displayName,o.photoURL).then((()=>{amplitude.getInstance().logEvent("stored page note"),i({result:"success"})}))}else if(t.action&&"get_user_tags"===t.action)!function(e,t){e.collection("users").doc(t).collection("highlights").get().then((function(e){const t=[];for(let o in e.docs){const n=e.docs[o].data();n.tag&&n.tag.length>0&&Array.from(n.tag).forEach((e=>{t.push(e)}))}return t})).then((e=>{chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(t){chrome.tabs.sendMessage(t[0].id,{action:"receive_user_tags",data:e})}))})).catch((function(e){console.log("Error getting documents: ",e)}))}(e,o.uid);else if(t.action&&"visibility_status"===t.action)o.visibilityStatus=t.data;else if(t.action&&"update_exclude_domain"===t.action)(async function(t,n){const i=Date.now();if("add"===t){let t,s=!1;if(Array.from(o.domainExcludeList).forEach(((e,o,c)=>{e[1].domain===n&&(s=!0,t=e[0],e[1].exclude=!0,e[1].lastUpdated=i)})),s)await e.collection("users").doc(o.uid).collection("excludedDomainList").doc(t).update({exclude:!0,lastUpdated:i}).then((()=>{o.domainExcludeList.sort(((e,t)=>e[1].lastUpdated<t[1].lastUpdated?-1:1)),g(o.domainExcludeList)})).catch((function(e){console.log("Error updating documents: ",e)}));else{const t={domain:n,exclude:!0,lastUpdated:i};await e.collection("users").doc(o.uid).collection("excludedDomainList").add(t).then((e=>{o.domainExcludeList.push([e.id,t]),o.domainExcludeList.sort(((e,t)=>e[1].lastUpdated<t[1].lastUpdated?-1:1)),g(o.domainExcludeList)})).catch((function(e){console.log("Error updating documents: ",e)}))}}else if("remove"===t){let t;Array.from(o.domainExcludeList).forEach(((e,o,i)=>{e[1].domain===n&&(t=e[0],e[1].exclude=!1)})),await e.collection("users").doc(o.uid).collection("excludedDomainList").doc(t).update({exclude:!1,lastUpdated:i}).then((()=>{o.domainExcludeList.sort(((e,t)=>e[1].lastUpdated<t[1].lastUpdated?-1:1)),g(o.domainExcludeList)})).catch((function(e){console.log("Error updating documents: ",e)}))}})(t.data.action,t.data.domain).then((()=>{console.log("updated exclude domain")}));else if(t.action&&"get_exclude_domain"===t.action)g(o.domainExcludeList);else if(t.action&&"chrome_ext_signin_token"===t.action){const n=t.data;firebase.auth().signInWithCustomToken(n).then((t=>{o.uid=t.user.uid,o.docRef=e.collection("users").doc(o.uid),e.collection("users").doc(o.uid).get().then((function(e){const t=e.data();o.displayName=t.displayName?t.displayName:"",o.username=t.username?t.username:"",o.photoURL=t.photoURL?t.photoURL:chrome.runtime.getURL("/images/userphoto.png"),chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(e){chrome.tabs.sendMessage(e[0].id,{action:"user_data",data:[o.displayName,o.photoURL,o.uid,o.username]}),chrome.tabs.sendMessage(e[0].id,{action:"sidebar_toggle"})})),amplitude.getInstance().logEvent("login",{type:"google",action:"custom_token",place:"chrome_extension"})})).catch((function(e){console.log("Error getting documents: ",e)}))})).catch((e=>{console.log("error in signInWithCustomToken: ",e)}))}else if(t.action&&"amplitude_log"===t.action){const e=t.evtName;amplitude.getInstance().logEvent(e)}else if(t.action&&"console_log"===t.action)console.log(t.message);else if(t.action&&"sidebar_toggle_from_pdf"===t.action)chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(e){e&&e[0]&&"file:"==new URL(e[0].url).protocol?alert("You cannot highlight on local files. Please go to other websites to start highlighting :)"):chrome.tabs.sendMessage(e[0].id,{action:"sidebar_toggle"})}));else if(t.action&&"get_highlight_doc_id"===t.action){amplitude.getInstance().logEvent("get_highlight_doc_id");const n=t.data.fullURL;(async function(e,t,o){return await t.collection("users").doc(e).collection("highlights").where("fullUrl","==",o).get().then((async function(e){if(e.empty)return"";for(let t in e.docs)return e.docs[t].id}))})(o.uid,e,n).then((e=>i({result:e})))}else if(t.action&&"get_readwise_api_key"===t.action)amplitude.getInstance().logEvent("sidebar_export_readwise_click"),async function(e,t){return await t.doc(`users/${e}/accessTokens/readwise`).get().then((async e=>e.exists?e.data().accessToken:null))}(o.uid,e).then((e=>i({result:e})));else if(t.action&&"save_kindle_highlights"===t.action){const n=t.data;(async function(e,t,o){const n=[];return e&&""!=e?(Array.from(o).forEach((o=>{const i=o.id,s=o.data;n.push(async function(e,t,o,n){if(e&&""!=e)return await t.doc(`users/${e}/kindleHighlights/${o}`).get().then((async i=>{if(i.exists){const s=i.data(),c=s.highlights,a=s.highlights;return Array.from(n.highlights).forEach((e=>{Array.from(c).some((t=>t.string==e.string))||a.push(e)})),a.sort(((e,t)=>e.location<t.location?-1:1)),await t.doc(`users/${e}/kindleHighlights/${o}`).update({lastUpdatedDate:n.lastUpdatedDate,lastUpdated:n.lastUpdated,highlights:a}).then((()=>{})).catch((function(e){console.log("Error updating documents: ",e)}))}return await t.doc(`users/${e}/kindleHighlights/${o}`).set(n).then((()=>{})).catch((function(e){console.log("Error updating documents: ",e)}))})).then((async()=>await async function(e,t,o,n){return await t.doc(`kindleBooks/${o}`).get().then((async i=>{const s={id:n.id,fullUrl:n.fullUrl,url:n.url,title:n.title,thumbnail:n.thumbnail,thumbnailSmall:n.thumbnailSmall,lastUpdated:Date.now(),userList:[e]};if(i.exists){const t=i.data(),o=t.userList;t.url.includes("amazon.com")&&(s.url=t.url,s.fullUrl=t.fullUrl,s.title=t.title,s.thumbnail=t.thumbnail,s.thumbnailSmall=t.thumbnailSmall),o.includes(e)||o.push(e),s.userList=o}return await t.doc(`kindleBooks/${o}`).set(s).then((()=>{})).catch((function(e){console.log("Error updating documents: ",e)}))})).catch((function(e){console.log("Error updating documents: ",e)}))}(e,t,o,n))).catch((function(e){console.log("Error updating documents: ",e)}))}(e,t,i,s))})),await Promise.all(n),"Imported!"):"Error: please sign in to Glasp"})(o.uid,e,n).then((e=>i({result:e})))}else if(t.action&&"user_signed_in"===t.action)o.userSignedIn=!0;else if(t.action&&"user_not_signed_in"===t.action)o.userSignedIn=!1;else if(t.action&&"twitter_profile_exist"===t.action){const o=t.data;(async function(e,t){return await e.collection("users").where("socialLinks.twitterLink","==",t).get().then((async function(e){const t=[],o=[],n=[];for(let i in e.docs){const s=e.docs[i],c=s.data(),a=c?.bio??"",r=c?.topics??[],l=c?.socialLinks??"",d=c?.verification??"",u={userId:s.id,userDisplayName:c.displayName,userUsername:c.username,userPhotoURL:c.photoURL,userBio:a,userTopics:r,userSocialLinks:l,userCreatedOn:c.createdOn,userVerification:d};"verified"==d?t.push(u):"reserved"==d?o.push(u):n.push(u)}return t.length>0?t[0]:o.length>0?o[0]:n.length>0?n[0]:void 0}))})(e,o).then((e=>{e&&(amplitude.getInstance().logEvent("glasp_profile_on_twitter_get_data"),e&&i({result:"account_found",data:e}))})).catch((e=>{console.log("Error getting docs: ",e)}))}else t.action&&"yt_transcript_store"===t.action&&function(t){if(!o.uid||""==o.uid)return;const n=t.video_id,i={language:t.language,raw_transcript:t.raw_transcript};0!=t.raw_transcript.length&&e.doc(`yt_transcripts/${n}`).get().then((async t=>{if(t.exists){const o=t.data().transcripts;return Array.from(o).forEach(((e,t,n)=>{e.langugae==i.language&&(o[t]=i)})),Array.from(o).some((e=>e.language==i.language))||o.push(i),await e.doc(`yt_transcripts/${n}`).update({transcripts:o}).then((()=>{})).catch((function(e){console.log("Error updating documents: ",e)}))}{const t=Object.assign([],[]);return t.push(i),await e.doc(`yt_transcripts/${n}`).set({video_id:n,transcripts:t}).then((()=>{})).catch((function(e){console.log("Error updating documents: ",e)}))}})).catch((function(e){console.log("Error getting documents: ",e)}))}(t.data);return!0})),chrome.browserAction.onClicked.addListener((function(e){if(o.currURL=e.url,o.excludedDomain=m(o.currURL,e.id),o.userExcludedDomain=f(o.currURL,o.domainExcludeList),o.highlighterMode=o.excludedDomain||o.userExcludedDomain?"off":"on",o.excludedDomain)return void alert("Due to technical reasons, you cannot highlight on this website.\n\nPlease go to other websites to start highlighting :)");chrome.tabs.sendMessage(e.id,{action:"browser_icon_clicked"},(t=>{if(!t&&!l())return console.log("browserAction no response"),void chrome.tabs.reload(e.id)}));const t=new URL(e.url);if("file:"!=t.protocol&&"localhost"!=t.hostname){if("/pdf/web/viewer.html"==t.pathname&&t.search&&t.search.includes("?file=")){const e=new URL(t.search.replace("?file=",""));if("file:"==e.protocol||"localhost"==e.hostname)return void alert("Due to technical reasons, you cannot highlight on your local files.\n\nPlease go to other websites to start highlighting :)")}h(o.excludedDomain,e?.id)}else alert("Due to technical reasons, you cannot highlight on your local files.\n\nPlease go to other websites to start highlighting :)")}))})();