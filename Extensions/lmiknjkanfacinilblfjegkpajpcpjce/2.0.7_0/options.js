"use strict";function wrapper(a,...b){return function(...c){let d,e=Object.assign(Object.create(null),a);if(0<c.length){let a=c[c.length-1];"function"==typeof a&&(d=a);for(let a=0;a<c.length-(d?1:0);a++)e[b[a]]=c[a]}ext.backgroundPage.sendMessage(e,d)}}const getDocLink=wrapper({type:"app.get",what:"doclink"},"link"),getInfo=wrapper({type:"app.get"},"what"),getPref=wrapper({type:"prefs.get"},"key"),togglePref=wrapper({type:"prefs.toggle"},"key"),getSubscriptions=wrapper({type:"subscriptions.get"},"downloadable","special"),removeSubscription=wrapper({type:"subscriptions.remove"},"url"),addSubscription=wrapper({type:"subscriptions.add"},"url","title","homepage"),toggleSubscription=wrapper({type:"subscriptions.toggle"},"url","keepInstalled"),updateSubscription=wrapper({type:"subscriptions.update"},"url"),importRawFilters=wrapper({type:"filters.importRaw"},"text","removeExisting"),addFilter=wrapper({type:"filters.add"},"text"),removeFilter=wrapper({type:"filters.remove"},"text"),quoteCSS=wrapper({type:"composer.quoteCSS"},"CSS"),whitelistedDomainRegexp=/^@@\|\|([^/:]+)\^\$document$/,statusMessages=new Map([["synchronize_invalid_url","filters_subscription_lastDownload_invalidURL"],["synchronize_connection_error","filters_subscription_lastDownload_connectionError"],["synchronize_invalid_data","filters_subscription_lastDownload_invalidData"],["synchronize_checksum_mismatch","filters_subscription_lastDownload_checksumMismatch"]]);let acceptableAdsUrl,delayedSubscriptionSelection=null;function loadOptions(){document.title=i18n.getMessage("options"),getPref("subscriptions_exceptionsurl",a=>{acceptableAdsUrl=a,$("#acceptableAdsLink").attr("href",acceptableAdsUrl)}),getDocLink("acceptable_ads",a=>{$("#acceptableAdsDocs").attr("href",a)}),getDocLink("filterdoc",a=>{setLinks("filter-must-follow-syntax",a)}),getInfo("application",a=>{getInfo("platform",b=>{"chromium"==b&&"opera"!=a&&(a="chrome"),getDocLink(a+"_support",a=>{setLinks("found-a-bug",a)}),"gecko"==b&&$("#firefox-warning").removeAttr("hidden")})}),$("#updateFilterLists").click(updateFilterLists),$("#startSubscriptionSelection").click(startSubscriptionSelection),$("#subscriptionSelector").change(updateSubscriptionSelection),$("#addSubscription").click(addSubscriptionClicked),$("#acceptableAds").click(toggleAcceptableAds),$("#whitelistForm").submit(addWhitelistDomain),$("#removeWhitelist").click(removeSelectedExcludedDomain),$("#customFilterForm").submit(addTypedFilter),$("#removeCustomFilter").click(removeSelectedFilters),$("#rawFiltersButton").click(toggleFiltersInRawFormat),$("#importRawFilters").click(importRawFiltersText),$("#tabs").tabs(),$("button").button(),$(".refreshButton").button("option","icons",{primary:"ui-icon-refresh"}),$(".addButton").button("option","icons",{primary:"ui-icon-plus"}),$(".removeButton").button("option","icons",{primary:"ui-icon-minus"}),initCheckbox("shouldShowBlockElementMenu"),initCheckbox("show_devtools_panel"),initCheckbox("shouldShowNotifications","notifications_ignoredcategories"),getInfo("features",a=>{a.devToolsPanel||(document.getElementById("showDevtoolsPanelContainer").hidden=!0)}),getPref("notifications_showui",a=>{a||(document.getElementById("shouldShowNotificationsContainer").hidden=!0)}),ext.backgroundPage.sendMessage({type:"app.listen",filter:["addSubscription","focusSection"]}),ext.backgroundPage.sendMessage({type:"filters.listen",filter:["added","loaded","removed"]}),ext.backgroundPage.sendMessage({type:"prefs.listen",filter:["notifications_ignoredcategories","notifications_showui","show_devtools_panel","shouldShowBlockElementMenu"]}),ext.backgroundPage.sendMessage({type:"subscriptions.listen",filter:["added","disabled","homepage","lastDownload","removed","title","downloadStatus","downloading"]}),loadRecommendations(),reloadFilters()}$(loadOptions);function convertSpecialSubscription(a){for(let b of a.filters)whitelistedDomainRegexp.test(b.text)?appendToListBox("excludedDomainsBox",RegExp.$1):appendToListBox("userFiltersBox",b.text)}function reloadFilters(){for(let a=document.getElementById("filterLists");a.lastChild;)a.removeChild(a.lastChild);getSubscriptions(!0,!1,a=>{for(let b of a)b.url==acceptableAdsUrl?$("#acceptableAds").prop("checked",!b.disabled):addSubscriptionEntry(b)}),getSubscriptions(!1,!0,a=>{document.getElementById("userFiltersBox").innerHTML="",document.getElementById("excludedDomainsBox").innerHTML="";for(let b of a)convertSpecialSubscription(b)})}function initCheckbox(a,b){b=b||a;let c=document.getElementById(a);getPref(b,a=>{onPrefMessage(b,a)}),c.addEventListener("click",()=>{togglePref(b)},!1)}function loadRecommendations(){fetch("subscriptions.xml").then(a=>a.text()).then(a=>{let b=0,c=null,d=0,e=document.getElementById("subscriptionSelector"),f=new DOMParser().parseFromString(a,"application/xml"),g=f.documentElement.getElementsByTagName("subscription");for(let f=0;f<g.length;f++){let a=g[f],h=new Option;h.text=a.getAttribute("title")+" ("+a.getAttribute("specialization")+")",h._data={title:a.getAttribute("title"),url:a.getAttribute("url"),homepage:a.getAttribute("homepage")};let i=a.getAttribute("prefixes");i&&(i=i.replace(/\W/g,"_"),h.style.fontWeight="bold",h.style.backgroundColor="#E0FFE0",h.style.color="#000000",!c||c.length<i.length?(b=f,c=i,d=1):c&&c.length==i.length&&(d++,1>Math.random()*d&&(b=f,c=i))),e.appendChild(h)}let h=new Option,i=i18n.getMessage("filters_addSubscriptionOther_label");h.text=i+"\u2026",h._data=null,e.appendChild(h),e.selectedIndex=b,delayedSubscriptionSelection&&startSubscriptionSelection(...delayedSubscriptionSelection)})}function startSubscriptionSelection(a,b){let c=document.getElementById("subscriptionSelector");return 0==c.length?void(delayedSubscriptionSelection=[a,b]):void($("#tabs").tabs("select",0),$("#addSubscriptionContainer").show(),$("#addSubscriptionButton").hide(),$("#subscriptionSelector").focus(),"undefined"!=typeof b&&(c.selectedIndex=c.length-1,document.getElementById("customSubscriptionTitle").value=a,document.getElementById("customSubscriptionLocation").value=b),updateSubscriptionSelection(),document.getElementById("addSubscriptionContainer").scrollIntoView(!0))}function updateSubscriptionSelection(){let a=document.getElementById("subscriptionSelector"),b=a.options[a.selectedIndex]._data;b?$("#customSubscriptionContainer").hide():($("#customSubscriptionContainer").show(),$("#customSubscriptionTitle").focus())}function addSubscriptionClicked(){let a=document.getElementById("subscriptionSelector"),b=a.options[a.selectedIndex]._data;if(b)addSubscription(b.url,b.title,b.homepage);else{let a=document.getElementById("customSubscriptionLocation").value.trim();if(!/^https?:/i.test(a))return alert(i18n.getMessage("global_subscription_invalid_location")),void $("#customSubscriptionLocation").focus();let b=document.getElementById("customSubscriptionTitle").value.trim();b||(b=a),addSubscription(a,b,null)}$("#addSubscriptionContainer").hide(),$("#customSubscriptionContainer").hide(),$("#addSubscriptionButton").show()}function toggleAcceptableAds(){toggleSubscription(acceptableAdsUrl,!0)}function findSubscriptionElement(a){for(let b of document.getElementById("filterLists").childNodes)if(b._subscription.url==a.url)return b;return null}function updateSubscriptionInfo(a,b){b?a._subscription=b:b=a._subscription;let c=a.getElementsByClassName("subscriptionTitle")[0];c.textContent=b.title,c.setAttribute("title",b.url),c.href=b.homepage?b.homepage:b.url;let d=a.getElementsByClassName("subscriptionEnabled")[0];d.checked=!b.disabled;let e=a.getElementsByClassName("subscriptionUpdate")[0];e.classList.remove("error");let{downloadStatus:f}=b;if(b.isDownloading)e.textContent=i18n.getMessage("filters_subscription_lastDownload_inProgress");else if(f&&"synchronize_ok"!=f)e.textContent=statusMessages.has(f)?i18n.getMessage(statusMessages.get(f)):f,e.classList.add("error");else if(0<b.lastDownload){let a=i18nTimeDateStrings(1e3*b.lastDownload),c=a[1]?"last_updated_at":"last_updated_at_today";e.textContent=i18n.getMessage(c,a)}}function onSubscriptionMessage(a,b){let c=findSubscriptionElement(b);"disabled"===a||"downloading"===a||"downloadStatus"===a||"homepage"===a||"lastDownload"===a||"title"===a?c&&updateSubscriptionInfo(c,b):"added"===a?0==b.url.indexOf("~user")?convertSpecialSubscription(b):b.url==acceptableAdsUrl?$("#acceptableAds").prop("checked",!0):!c&&addSubscriptionEntry(b):"removed"===a?b.url==acceptableAdsUrl?$("#acceptableAds").prop("checked",!1):c&&c.parentNode.removeChild(c):void 0}function onPrefMessage(a,b){switch(a){case"notifications_showui":return void(document.getElementById("shouldShowNotificationsContainer").hidden=!b);case"notifications_ignoredcategories":a="shouldShowNotifications",b=-1==b.indexOf("*");}let c=document.getElementById(a);c&&(c.checked=b)}function onFilterMessage(a,b){"loaded"===a?reloadFilters():"added"===a?whitelistedDomainRegexp.test(b.text)?appendToListBox("excludedDomainsBox",RegExp.$1):appendToListBox("userFiltersBox",b.text):"removed"===a?whitelistedDomainRegexp.test(b.text)?removeFromListBox("excludedDomainsBox",RegExp.$1):removeFromListBox("userFiltersBox",b.text):void 0}function appendToListBox(a,b){let c=new Option;c.text=b,c.value=b,document.getElementById(a).appendChild(c)}function removeFromListBox(a,b){let c=document.getElementById(a);quoteCSS(b,a=>{for(let b of c.querySelectorAll("option[value="+a+"]"))c.removeChild(b)})}function addWhitelistDomain(a){a.preventDefault();let b=document.getElementById("newWhitelistDomain").value.replace(/\s/g,"");if(document.getElementById("newWhitelistDomain").value="",!!b){addFilter("@@||"+b+"^$document")}}function addTypedFilter(a){a.preventDefault();let b=document.getElementById("newFilter");addFilter(b.value,a=>{0<a.length?alert(a.join("\n")):b.value=""})}function removeSelectedExcludedDomain(a){a.preventDefault();let b=[];for(let c of document.getElementById("excludedDomainsBox").options)c.selected&&b.push(c.value);if(b.length)for(let a of b)removeFilter("@@||"+a+"^$document")}function removeSelectedFilters(a){a.preventDefault();let b=document.querySelectorAll("#userFiltersBox > option:checked");for(let c of b)removeFilter(c.value)}function toggleFiltersInRawFormat(a){a.preventDefault();let b=document.getElementById("rawFilters"),c=[];if("table-row"!=b.style.display){b.style.display="table-row";for(let a of document.getElementById("userFiltersBox").options)c.push(a.value)}else b.style.display="none";document.getElementById("rawFiltersText").value=c.join("\n")}function importRawFiltersText(){let a=document.getElementById("rawFiltersText").value;importRawFilters(a,!0,a=>{0<a.length?alert(a.join("\n")):$("#rawFilters").hide()})}function updateFilterLists(){updateSubscription()}function addSubscriptionEntry(a){let b=document.getElementById("subscriptionTemplate"),c=b.cloneNode(!0);c.removeAttribute("id"),c._subscription=a;let d=c.getElementsByClassName("subscriptionRemoveButton")[0];d.setAttribute("title",d.textContent),d.textContent="\xD7",d.addEventListener("click",()=>{confirm(i18n.getMessage("global_remove_subscription_warning"))&&removeSubscription(a.url)},!1),getPref("additional_subscriptions",b=>{b.includes(a.url)&&(d.style.visibility="hidden")});let e=c.getElementsByClassName("subscriptionEnabled")[0];e.addEventListener("click",()=>{a.disabled=!a.disabled,toggleSubscription(a.url,!0)},!1),updateSubscriptionInfo(c),document.getElementById("filterLists").appendChild(c)}function setLinks(a,...b){let c=document.getElementById(a);if(c){let a=c.getElementsByTagName("a");for(let c=0;c<a.length;c++)"string"==typeof b[c]?(a[c].href=b[c],a[c].setAttribute("target","_blank")):"function"==typeof b[c]&&(a[c].href="javascript:void(0);",a[c].addEventListener("click",b[c],!1))}}ext.onMessage.addListener(a=>{switch(a.type){case"app.respond":switch(a.action){case"addSubscription":let b=a.args[0];startSubscriptionSelection(b.title,b.url);break;case"focusSection":for(let b of document.getElementsByClassName("ui-tabs-panel")){let c=b.querySelector("[data-section='"+a.args[0]+"']");if(!c)continue;let d=document.getElementsByClassName("focused");0<d.length&&d[0].classList.remove("focused");let e=$("[href='#"+b.id+"']").parent().index();$("#tabs").tabs("select",e),c.classList.add("focused")}}break;case"filters.respond":onFilterMessage(a.action,a.args[0]);break;case"prefs.respond":onPrefMessage(a.action,a.args[0]);break;case"subscriptions.respond":onSubscriptionMessage(a.action,a.args[0]);}});