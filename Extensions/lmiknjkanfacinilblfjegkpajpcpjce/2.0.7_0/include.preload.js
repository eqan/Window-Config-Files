"use strict";let elemhide,{splitSelector}=require("common"),{ElemHideEmulation}=require("content_elemHideEmulation");const typeMap=new Map([["img","IMAGE"],["input","IMAGE"],["picture","IMAGE"],["audio","MEDIA"],["video","MEDIA"],["frame","SUBDOCUMENT"],["iframe","SUBDOCUMENT"],["object","OBJECT"],["embed","OBJECT"]]);function getURLsFromObjectElement(a){let b=a.getAttribute("data");if(b)return[b];for(let b of a.children){if("param"!=b.localName)continue;let a=b.getAttribute("name");if("movie"!=a&&"source"!=a&&"src"!=a&&"FileName"!=a)continue;let c=b.getAttribute("value");if(c)return[c]}return[]}function getURLsFromAttributes(a){let b=[];if(a.src&&b.push(a.src),a.srcset)for(let c of a.srcset.split(",")){let a=c.trim().replace(/\s+\S+$/,"");a&&b.push(a)}return b}function getURLsFromMediaElement(a){let b=getURLsFromAttributes(a);for(let c of a.children)("source"==c.localName||"track"==c.localName)&&b.push(...getURLsFromAttributes(c));return a.poster&&b.push(a.poster),b}function getURLsFromElement(a){let b;switch(a.localName){case"object":b=getURLsFromObjectElement(a);break;case"video":case"audio":case"picture":b=getURLsFromMediaElement(a);break;default:b=getURLsFromAttributes(a);}for(let c=0;c<b.length;c++)/^(?!https?:)[\w-]+:/i.test(b[c])&&b.splice(c--,1);return b}function hideElement(a){function b(){let b="display",c="none";"frame"==a.localName&&(b="visibility",c="hidden"),(a.style.getPropertyValue(b)!=c||"important"!=a.style.getPropertyPriority(b))&&a.style.setProperty(b,c,"important")}b(),new MutationObserver(b).observe(a,{attributes:!0,attributeFilter:["style"]})}function checkCollapse(a){let b=typeMap.get(a.localName);if(b){let c=getURLsFromElement(a);0==c.length||ext.backgroundPage.sendMessage({type:"filters.collapse",urls:c,mediatype:b,baseURL:document.location.href},b=>{b&&hideElement(a)})}}function checkSitekey(){let a=document.documentElement.getAttribute("data-adblockkey");a&&ext.backgroundPage.sendMessage({type:"filters.addKey",token:a})}function ElementHidingTracer(){this.selectors=[],this.changedNodes=[],this.timeout=null,this.observer=new MutationObserver(this.observe.bind(this)),this.trace=this.trace.bind(this),"loading"==document.readyState?document.addEventListener("DOMContentLoaded",this.trace):this.trace()}ElementHidingTracer.prototype={addSelectors(a,b){let c=a.map((a,c)=>[a,b&&b[c]]);"loading"!=document.readyState&&this.checkNodes([document],c),this.selectors.push(...c)},checkNodes(a,b){let c=[],d=[];for(let[e,f]of b)nodes:for(let b of a)for(let a of b.querySelectorAll(e))if("none"==getComputedStyle(a).display){f?d.push(f):c.push(e);break nodes}(0<c.length||0<d.length)&&ext.backgroundPage.sendMessage({type:"devtools.traceElemHide",selectors:c,filters:d})},onTimeout(){this.checkNodes(this.changedNodes,this.selectors),this.changedNodes=[],this.timeout=null},observe(a){for(let b=0;b<this.changedNodes.length;b++)document.contains(this.changedNodes[b])||this.changedNodes.splice(b--,1);for(let b of a){let a=b.target;if(!document.contains(a))continue;"attributes"==b.type&&(a=a.parentNode);let c=!0;for(let b,d=0;d<this.changedNodes.length;d++){if(b=this.changedNodes[d],b.contains(a)){c=!1;break}a.contains(b)&&this.changedNodes.splice(d--,1)}c&&this.changedNodes.push(a)}null==this.timeout&&(this.timeout=setTimeout(this.onTimeout.bind(this),1e3))},trace(){this.checkNodes([document],this.selectors),this.observer.observe(document,{childList:!0,attributes:!0,subtree:!0})},disconnect(){document.removeEventListener("DOMContentLoaded",this.trace),this.observer.disconnect(),clearTimeout(this.timeout)}};function ElemHide(){this.shadow=this.createShadowTree(),this.style=null,this.tracer=null,this.inject=!0,this.elemHideEmulation=new ElemHideEmulation(window,a=>{ext.backgroundPage.sendMessage({type:"filters.get",what:"elemhideemulation"},a)},this.addSelectors.bind(this),this.hideElements.bind(this))}ElemHide.prototype={selectorGroupSize:200,createShadowTree(){try{if(!("createShadowRoot"in document.documentElement))return null;if(/\.(?:google|blogger)\.com$/.test(document.domain))return null;let a=document.documentElement.shadowRoot||document.documentElement.createShadowRoot();return a.appendChild(document.createElement("shadow")),a}catch(a){return null}},injectSelectors(a,b){if(!this.style&&(this.style=document.createElement("style"),(this.shadow||document.head||document.documentElement).appendChild(this.style),!this.style.sheet))return;let c=[];if(this.shadow)for(let b of a){let a=splitSelector(b);for(let b of a)c.push("::content "+b)}else c=a;for(let d,e=0;e<c.length;e+=this.selectorGroupSize)d=c.slice(e,e+this.selectorGroupSize).join(", "),this.style.sheet.insertRule(d+"{display: none !important;}",this.style.sheet.cssRules.length)},addSelectors(a,b){0==a.length||(this.inject?this.injectSelectors(a,b):ext.backgroundPage.sendMessage({type:"elemhide.injectSelectors",selectors:a}),this.tracer&&this.tracer.addSelectors(a,b))},hideElements(a,b){for(let c of a)hideElement(c);this.tracer&&ext.backgroundPage.sendMessage({type:"devtools.traceElemHide",selectors:[],filters:b})},apply(){ext.backgroundPage.sendMessage({type:"elemhide.getSelectors"},a=>{this.tracer&&this.tracer.disconnect(),this.tracer=null,this.style&&this.style.parentElement&&this.style.parentElement.removeChild(this.style),this.style=null,a.trace&&(this.tracer=new ElementHidingTracer),this.inject=a.inject,this.inject?this.addSelectors(a.selectors):this.tracer&&this.tracer.addSelectors(a.selectors),this.elemHideEmulation.apply()})}},document instanceof HTMLDocument&&(checkSitekey(),elemhide=new ElemHide,elemhide.apply(),document.addEventListener("error",a=>{checkCollapse(a.target)},!0),document.addEventListener("load",a=>{let b=a.target;/^i?frame$/.test(b.localName)&&checkCollapse(b)},!0)),"use strict";let randomEventName="abp-request-"+Math.random().toString(36).substr(2);document.addEventListener(randomEventName,a=>{let{url:b,requestType:c}=a.detail;ext.backgroundPage.sendMessage({type:"request.blockedByWrapper",requestType:c,url:b},a=>{document.dispatchEvent(new CustomEvent(randomEventName+"-"+c+"-"+b,{detail:a}))})});function injected(a,b){function c(b){if(b&&!r(b)){q(b);try{b[a]=n,b.eval("("+o()+")('"+a+"', true);"),delete b[a]}catch(a){}}}function d(a,b,c){for(let d of c)a.hasOwnProperty(d)&&Object.defineProperty(b,d,Object.getOwnPropertyDescriptor(a,d))}function e(a,...b){if(!(this instanceof e))return t();if(1>arguments.length)return new t;let c=new t(a,...b);return n("websocket",c.url,a=>{a&&u(c)}),c}function f(a){if("undefined"!=typeof a)return y(a)}function g(a,b){if(null==a||"object"!=typeof a)return a;let c=x(a.length);for(let d=0;d<c.length;d++)A(c,d,{configurable:!1,enumerable:!1,writable:!1,value:b(a[d])});return A(c,"length",{configurable:!1,enumerable:!1,writable:!1,value:c.length}),c}function h(a){if(null==a||"object"!=typeof a)return a;let b=g(a.iceServers,a=>{let{url:b,urls:c}=a;return"undefined"==typeof c||c instanceof x||(c=[c]),z(a,{url:{configurable:!1,enumerable:!1,writable:!1,value:f(b)},urls:{configurable:!1,enumerable:!1,writable:!1,value:g(c,f)}})});return z(a,{iceServers:{configurable:!1,enumerable:!1,writable:!1,value:b}})}function k(a,b){n("webrtc",b,b=>{if(b)try{w(a)}catch(a){}})}function l(a,b){if(b&&b.iceServers)for(let c,d=0;d<b.iceServers.length;d++)if(c=b.iceServers[d],c&&(c.url&&k(a,c.url),c.urls))for(let b=0;b<c.urls.length;b++)k(a,c.urls[b])}function m(...a){if(!(this instanceof m))return v();let b,c=h(a[0]);1<a.length&&(b=a[1]);let d=new v(c,b);return l(d,c),d}let n,o=Function.prototype.toString.bind(injected),p=new WeakSet,q=WeakSet.prototype.add.bind(p),r=WeakSet.prototype.has.bind(p);for(let d of[HTMLFrameElement,HTMLIFrameElement,HTMLObjectElement]){let a=Object.getOwnPropertyDescriptor(d.prototype,"contentDocument"),b=Object.getOwnPropertyDescriptor(d.prototype,"contentWindow");if(!b)continue;let e=Function.prototype.call.bind(a.get),f=Function.prototype.call.bind(b.get);b.get=function(){let a=f(this);return c(a),a},a.get=function(){return c(f(this)),e(this)},Object.defineProperty(d.prototype,"contentWindow",b),Object.defineProperty(d.prototype,"contentDocument",a)}if("shadowRoot"in Element.prototype){let a=document.documentElement.shadowRoot;if(a){let b=Object.getOwnPropertyDescriptor(Element.prototype,"shadowRoot"),c=Function.prototype.call.bind(b.get);Object.defineProperty(Element.prototype,"shadowRoot",{configurable:!0,enumerable:!0,get(){let b=c(this);return b==a?null:b}})}}let s=window.CustomEvent;if(b)n=window[a];else{let b=document.addEventListener.bind(document),c=document.dispatchEvent.bind(document),d=document.removeEventListener.bind(document);n=(e,f,g)=>{function h(a){g(a.detail),d(i,h)}let i=a+"-"+e+"-"+f;b(i,h),c(new s(a,{detail:{url:f,requestType:e}}))}}let t=WebSocket,u=Function.prototype.call.bind(t.prototype.close);e.prototype=t.prototype,window.WebSocket=e.bind(),d(t,WebSocket,["CONNECTING","OPEN","CLOSING","CLOSED","prototype"]),t.prototype.constructor=WebSocket;let v=window.RTCPeerConnection||window.webkitRTCPeerConnection,w=Function.prototype.call.bind(v.prototype.close),x=Array,y=String,{create:z,defineProperty:A}=Object;if(v.prototype.setConfiguration){let a=Function.prototype.call.bind(v.prototype.setConfiguration);v.prototype.setConfiguration=function(b){b=h(b),a(this,b),l(this,b)}}m.prototype=v.prototype;let B=m.bind();d(v,B,["generateCertificate","name","prototype"]),v.prototype.constructor=B,"RTCPeerConnection"in window&&(window.RTCPeerConnection=B),"webkitRTCPeerConnection"in window&&(window.webkitRTCPeerConnection=B)}if(document instanceof HTMLDocument){let a=window.frameElement&&window.frameElement.getAttribute("sandbox");if("string"!=typeof a||/(^|\s)allow-scripts(\s|$)/i.test(a)){let a=document.createElement("script");a.type="application/javascript",a.async=!1,a.textContent="("+injected+")('"+randomEventName+"');",document.documentElement.appendChild(a),document.documentElement.removeChild(a)}}