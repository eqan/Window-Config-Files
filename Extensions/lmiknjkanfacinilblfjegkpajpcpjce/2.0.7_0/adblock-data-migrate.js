MigrateLegacyData=function(){function a(){var a=n("blockage_stats");a?((a.start===void 0||"number"!=typeof a.start)&&(a.start=Date.now()),(a.version===void 0||"number"!=typeof a.version)&&(a.version=1),(a.total===void 0||"number"!=typeof a.total)&&(a.total=0),j.blocked_total=a.total,delete a.total,ext.storage.set("blockage_stats",a),o("blockage_stats",void 0),l("migrated Legacy Blockage Stats")):ext.storage.get("blockage_stats",function(b){var c=b.blockage_stats;c||(a={},a.start=Date.now(),a.version=1,ext.storage.set("blockage_stats",a))})}function b(){for(var a=1,b=[STATS.userIDStorageKey,STATS.totalPingStorageKey,STATS.nextPingTimeStorageKey],c=["string","number","number"],d=0;d<b.length;d++){var e=b[d],f=n(e);f&&(typeof f===c[d]&&(ext.storage.set(e,f),l("migrated Legacy data, key: "+e+", value: "+f),a=2e3),o(e,void 0))}window.setTimeout(function(){STATS.startPinging(),uninstallInit()},a)}function c(){function a(){var a=n("settings");a?(this._data=$.extend({debug_logging:!1,youtube_channel_whitelist:!1,show_context_menu_items:!0,show_advanced_options:!1,display_stats:!0,display_menu_stats:!0,show_block_counts_help_link:!0,dropbox_sync:!1,show_survey:!0},a),this.needsMigration=!0):this.needsMigration=!1}a.prototype={set:function(a,b){this._data[a]=b;var c=n("settings")||{};c[a]=b,o("settings",c)},get_all:function(){return this._data}};var b=new a;if(j.hidePlaceholders=!0,b&&b.needsMigration){var c=b.get_all();j.shouldShowBlockElementMenu=m(c.show_context_menu_items,!0),j.show_statsinicon=m(c.display_stats,!0),j.show_statsinpopup=m(c.display_menu_stats,!0),_settings.onload().then(function(){setSetting("debug_logging",m(c.debug_logging,!1),function(){setSetting("youtube_channel_whitelist",m(c.youtube_channel_whitelist,!1),function(){setSetting("show_advanced_options",m(c.show_advanced_options,!1),function(){setSetting("show_advanced_options",m(c.show_advanced_options,!1),function(){setSetting("show_block_counts_help_link",m(c.show_block_counts_help_link,!0),function(){setSetting("show_survey",m(c.show_survey,!0),function(){setSetting("data_collection",m(c.data_collection,!1),function(){o("settings",void 0),l("migrated Legacy Settings")})})})})})})})})}}function d(a){var b=n("filter_lists");return!b||1>b.length?(SubscriptionInit.init(),void(a&&a())):void require("subscriptionInit").setSubscriptionsCallback(function(c){j.suppress_first_run_page=!0;var c=[];for(var d in b){var e=b[d];e.subscribed&&e.url&&c.push(Subscription.fromURL(e.url))}return o("filter_lists",void 0),o("last_subscriptions_check",void 0),l("Done migrating subscriptions.  Migrated count: ",c.length),SubscriptionInit.init(),a&&a(),c})}function e(){var a=n("custom_filters");if(a){var b=a.split("\n");b=b.filter(function(a){return""!==a}),a=b.join("\n");var c=parseFilters(a);if(c&&c.filters){for(var d,e=0;e<c.filters.length;e++)d=c.filters[e],d&&FilterStorage.addFilter(d);l("Migrated custom filters, count: ",c.filters.length),o("custom_filters",void 0)}if(c&&c.errors&&0<c.errors.length){for(var f,g=[translate("custom_filters_migration_error_message_part1")+c.errors.length," ",translate("custom_filters_migration_error_message_part2")," "],e=0;e<c.errors.length;e++)f=c.errors[e],f.lineno&&g.push(translate("custom_filters_migration_error_message_part3")+b[f.lineno-1]),g.push(f.toString()),g.push(" ");var h=g.join("\n");l(h),ext.storage.set("custom_filters_errors",h)}}}function f(){var a=n("exclude_filters")||"";a&&(ext.storage.set("exclude_filters",a),o("exclude_filters",void 0),l("Done migrating exclude / disable filters."))}function g(){var a=n("custom_filter_count")||"";a&&(ext.storage.set("custom_filter_count",a),l("Done migrating custom filters count cache."),o("custom_filter_count",void 0))}function h(){ext.storage.get("malware_list",function(a){a&&a.malware_list&&(ext.storage.remove("malware_list"),!0===a.malware_list.subscribed&&(FilterStorage.addSubscription(malwareSub),malwareSub instanceof DownloadableSubscription&&Synchronizer.execute(malwareSub)))})}var i=require("filterNotifier").FilterNotifier,j=require("prefs").Prefs,k="Date migrated: "+new Date+" \n",l=function(){var a=Array.prototype.slice.call(arguments);k=k+a.join(" ")+"\n",ext.storage.set("migrateLogMessageKey",k)},m=function(a){return"boolean"==typeof a?a:void 0},n=function(a){var b=window.SAFARI?safari.extension.settings:localStorage;if(void 0!==b){var c=b.getItem(a);if(null!=c)try{return JSON.parse(c)}catch(c){return l("Deleting item, couldn't parse json for "+a),void b.removeItem(a)}}},o=function(a,b){var c=window.SAFARI?safari.extension.settings:localStorage;if(void 0===b)return void c.removeItem(a);try{c.setItem(a,JSON.stringify(b))}catch(a){l(a)}};(function(){d(function(){e(),g(),f(),h()}),j.untilLoaded.then(function(){a(),c()}),b()})()}();