"use strict";(function(a){function b(a){try{return require(a)}catch(a){return null}}function c(a,b){let c={};for(let d of a)d in b&&(c[d]=b[d]);return c}function d(a){let b=c(["disabled","downloadStatus","homepage","lastDownload","title","url"],a);return a instanceof x&&(b.filters=a.filters.map(y)),b.isDownloading=t.isExecuting(a.url),b}function e(a,b,...c){let e=z.keys();if(0!=e.length){let f=[];for(let a of c)a instanceof v?f.push(d(a)):a instanceof q?f.push(y(a)):f.push(a);for(let c of e){let d=z.get(c),e=d[a];e&&-1!=e.indexOf(b)&&c.sendMessage({type:C.get(a),action:b,args:f})}}}function f(a,b){for(let c of b){let b;b="filter"==a&&"loaded"==c?"load":a+"."+c,b in B||(B[b]=null,m.on(b,(...b)=>{e(a,c,...b)}))}}function g(a){let b=z.get(a);return b||(b=Object.create(null),z.set(a,b)),b}let h=a.ext||require("ext_background");const{port:i}=require("messaging"),{Prefs:j}=require("prefs"),{Utils:k}=require("utils"),{FilterStorage:l}=require("filterStorage"),{FilterNotifier:m}=require("filterNotifier"),{defaultMatcher:n}=require("matcher"),{ElemHideEmulation:o}=require("elemHideEmulation"),{Notification:p}=require("notification"),{Filter:q,BlockingFilter:r,RegExpFilter:s}=require("filterClasses"),{Synchronizer:t}=require("synchronizer"),u=require("info"),{Subscription:v,DownloadableSubscription:w,SpecialSubscription:x}=require("subscriptionClasses");let y=c.bind(null,["text"]),z=new h.PageMap,A=Object.create(null),B=Object.create(null),C=new Map([["app","app.respond"],["filter","filters.respond"],["pref","prefs.respond"],["subscription","subscriptions.respond"]]);i.on("app.get",a=>{if("issues"==a.what){let a=b("subscriptionInit"),c=!!a&&a.reinitialized;return{filterlistsReinitialized:c}}if("doclink"==a.what)return k.getDocLink(a.link);if("localeInfo"==a.what){let a;if("chromeRegistry"in k){let b=k.chromeRegistry.isLocaleRTL("adblockplus");a=b?"rtl":"ltr"}else a=k.readingDirection;return{locale:k.appLocale,bidiDir:a}}return"features"==a.what?{devToolsPanel:"chromium"==u.platform}:u[a.what]}),i.on("app.listen",(a,b)=>{g(b.page).app=a.filter}),i.on("app.open",a=>{"options"==a.what&&h.showOptions(()=>{a.action&&e("app",a.action,...a.args)})}),i.on("filters.add",a=>{let b=require("filterValidation").parseFilter(a.text),c=[];return b.error?c.push(b.error.toString()):b.filter&&l.addFilter(b.filter),c}),i.on("filters.blocked",a=>{let b=n.matchesAny(a.url,s.typeMap[a.requestType],a.docDomain,a.thirdParty);return b instanceof r}),i.on("filters.get",(a,b)=>{if("elemhideemulation"==a.what){let a=[];const{checkWhitelisted:c}=require("whitelisting");let d=c(b.page,b.frame,s.typeMap.DOCUMENT|s.typeMap.ELEMHIDE);if(j.enabled&&!d){let{hostname:c}=b.frame.url;a=o.getRulesForDomain(c),a=a.map(a=>({selector:a.selector,text:a.text}))}return a}let c=v.fromURL(a.subscriptionUrl);return c?c.filters.map(y):[]}),i.on("filters.importRaw",a=>{let b=require("filterValidation").parseFilters(a.text),c=[];for(let d of b.errors)"unexpected-filter-list-header"!=d.type&&c.push(d.toString());if(0<c.length)return c;let d=Object.create(null);for(let c of b.filters)l.addFilter(c),d[c.text]=null;if(!a.removeExisting)return c;for(let b of l.subscriptions)if(b instanceof x)for(let a,c=b.filters.length-1;0<=c;c--)a=b.filters[c],/^@@\|\|([^/:]+)\^\$document$/.test(a.text)||a.text in d||l.removeFilter(a);return c}),i.on("filters.listen",(a,b)=>{g(b.page).filter=a.filter,f("filter",a.filter)}),i.on("filters.remove",a=>{let b=q.fromText(a.text),c=null;a.subscriptionUrl&&(c=v.fromURL(a.subscriptionUrl)),c?l.removeFilter(b,c,a.index):l.removeFilter(b)}),i.on("prefs.get",a=>j[a.key]),i.on("prefs.listen",(a,b)=>{g(b.page).pref=a.filter;for(let c of a.filter)c in A||(A[c]=null,j.on(c,()=>{e("pref",c,j[c])}))}),i.on("prefs.toggle",a=>{"notifications_ignoredcategories"==a.key?p.toggleIgnoreCategory("*"):j[a.key]=!j[a.key]}),i.on("subscriptions.add",a=>{let b=v.fromURL(a.url);"title"in a&&(b.title=a.title),"homepage"in a&&(b.homepage=a.homepage),a.confirm?h.showOptions(()=>{e("app","addSubscription",b)}):(b.disabled=!1,l.addSubscription(b),b instanceof w&&!b.lastDownload&&t.execute(b))}),i.on("subscriptions.get",a=>{let b=l.subscriptions.filter(b=>!(a.ignoreDisabled&&b.disabled)&&(!!(b instanceof w&&a.downloadable)||!!(b instanceof x&&a.special)));return b.map(d)}),i.on("subscriptions.listen",(a,b)=>{g(b.page).subscription=a.filter,f("subscription",a.filter)}),i.on("subscriptions.remove",a=>{let b=v.fromURL(a.url);b.url in l.knownSubscriptions&&l.removeSubscription(b)}),i.on("subscriptions.toggle",a=>{let b=v.fromURL(a.url);b.url in l.knownSubscriptions?b.disabled||a.keepInstalled?b.disabled=!b.disabled:l.removeSubscription(b):(b.disabled=!1,b.title=a.title,b.homepage=a.homepage,l.addSubscription(b),!b.lastDownload&&t.execute(b))}),i.on("subscriptions.update",a=>{let{subscriptions:b}=l;a.url&&(b=[v.fromURL(a.url)]);for(let c of b)c instanceof w&&t.execute(c,!0)})})(this);