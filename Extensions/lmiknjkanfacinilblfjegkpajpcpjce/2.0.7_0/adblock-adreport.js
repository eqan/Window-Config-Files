var backgroundPage=ext.backgroundPage.getWindow(),require=backgroundPage.require,Prefs=require("prefs").Prefs,subscriptionClasses=require("subscriptionClasses"),Subscription=subscriptionClasses.Subscription,FilterStorage=require("filterStorage").FilterStorage,FilterNotifier=require("filterNotifier").FilterNotifier,options=parseUri.parseSearch(document.location.search),tabId=options.tabId.replace(/[^0-9]/g,""),extensionsDisabled=[],subscriptionsNodes=[],unsubscribedDefaultFilters=[],contact="",updateFiltersClicked=!1,recordMessage=function(a){a&&backgroundPage.recordAdreportMessage(a)};$(function(){localizePage(),recordMessage("open"),$(window).unload(function(){updateFiltersClicked||recordMessage("update_filters_not_clicked")});var a=backgroundPage.getAllSubscriptionsMinusText();for(var b in a)a[b].subscribed||a[b].user_submitted||(unsubscribedDefaultFilters[b]=a[b]);var c=function(a){backgroundPage.fetch(a).then(function(a){return a.text()}).then(function(a){for(var b,c=new DOMParser().parseFromString(a,"application/xml"),d=c.getElementsByTagName("subscription"),e=0;e<d.length;e++)b=d[e],b&&subscriptionsNodes.push(b)})};c("subscriptions.xml"),c("adblock-subscriptions.xml");var d=function(a){if(0===subscriptionsNodes.length)return"";for(var b,c=0;c<subscriptionsNodes.length;c++)if(b=subscriptionsNodes[c],b){var d=b.getAttribute("prefixes"),e=b.getAttribute("homepage");if(null!==d&&null!==e){var f=d.split(",");if(0<=f.indexOf(a))return e}}};SAFARI?$(".chrome_only").hide():($(".safari_only").hide(),$("li[i18n='disableforchromestepone']").find("a").click(function(){OPERA?chrome.tabs.create({url:"opera://extensions/"}):chrome.tabs.create({url:"chrome://extensions/"})}));var e=$("#step_language_lang option");e.sort(function(c,a){return c.text?a.text?c.value?a.value?"lang_english"==c.getAttribute("i18n")?-1:"lang_english"==a.getAttribute("i18n")?1:c.text>a.text?1:-1:-1:1:1:-1}),$("#step_language_lang").empty().append(e),e[0].selected=!0,$("#step_update_filters_DIV").show(),$("#UpdateFilters").click(function(){$(this).prop("disabled",!0),recordMessage("update_filters_click"),updateFiltersClicked=!0,backgroundPage.updateFilterLists(),$(".afterFilterUpdate input").prop("disabled",!1),$(".afterFilterUpdate").removeClass("afterFilterUpdate")}),$("#step_update_filters_no").click(function(){recordMessage("update_filters_no"),$("#step_update_filters").html("<span class='answer' chosen='no'>"+translate("no")+"</span>"),$("#checkupdate").text(translate("adalreadyblocked"))}),$("#step_update_filters_yes").click(function(){recordMessage("update_filters_yes"),$("#step_update_filters").html("<span class='answer' chosen='yes'>"+translate("yes")+"</span>");var a=backgroundPage.getAllSubscriptionsMinusText();a&&a.acceptable_ads&&a.acceptable_ads.subscribed?($("#step_update_aa_DIV").show(),$(".odd").css("background-color","#f8f8f8")):($("#step_disable_extensions_DIV").fadeIn().css("display","block"),$(".even").css("background-color","#f8f8f8"))}),$("#DisableAA").click(function(){$(this).prop("disabled",!0),recordMessage("disable_aa_click"),setTimeout(function(){var a=Subscription.fromURL(Prefs.subscriptions_exceptionsurl);FilterStorage.removeSubscription(a),$(".afterDisableAA input").prop("disabled",!1),$(".afterDisableAA").removeClass("afterDisableAA")},1)}),$("#step_update_aa_no").click(function(){recordMessage("disable_aa_no"),$("#step_update_aa").html("<span class='answer' chosen='no'>"+translate("no")+"</span>"),$("#checkupdate").text(translate("aamessageadreport")),$("#checkupdatelink").text(translate("aalinkadreport")),$("#checkupdatelink_DIV").fadeIn().css("display","block")}),$("#step_update_aa_yes").click(function(){recordMessage("disable_aa_yes"),$("#step_update_aa").html("<span class='answer' chosen='yes'>"+translate("yes")+"</span>"),$("#step_disable_extensions_DIV").fadeIn().css("display","block")}),$("#step_disable_extensions_no").click(function(){recordMessage("disable_extensions"),$("#step_disable_extensions").html("<span class='answer' chosen='no'>"+translate("no")+"</span>"),$("#checkupdate").text(translate("reenableadsonebyone"))}),$("#step_disable_extensions_yes").click(function(){$("#step_disable_extensions").html("<span class='answer' chosen='yes'>"+translate("yes")+"</span>"),$("#step_language_DIV").fadeIn().css("display","block"),0<extensionsDisabled.length&&chrome.permissions.request({permissions:["management"]},function(a){if(a){for(var b=0;b<extensionsDisabled.length;b++)chrome.management.setEnabled(extensionsDisabled[b],!0);alert(translate("enableotherextensionscomplete"))}else alert(translate("manuallyenableotherextensions"))})}),$("#OtherExtensions").click(function(){$("#OtherExtensions").prop("disabled",!0),SAFARI||chrome.permissions.request({permissions:["management"]},function(a){a?($("#step_disable_extensions").fadeOut().css("display","none"),chrome.management.getAll(function(a){for(var b=0;b<a.length;b++)if(a[b].enabled&&a[b].mayDisable&&"gighmmpiobklfepjocnamgkkbiglidom"!==a[b].id&&"aobdicepooefnbaeokijohmhjlleamfj"!==a[b].id&&"pljaalgmajnlogcgiohkhdmgpomjcihk"!==a[b].id){if("development"===a[b].installType&&"extension"===a[b].type&&"AdBlock"===a[b].name)continue;chrome.management.setEnabled(a[b].id,!1),extensionsDisabled.push(a[b].id)}chrome.permissions.remove({permissions:["management"]},function(){});var c=!1;alert(translate("disableotherextensionscomplete")),backgroundPage.reloadTab(parseInt(tabId),function(){c=!0,alert(translate("tabreloadcomplete")),$("#step_disable_extensions").fadeIn().css("display","block")})})):$("#OtherExtensions").prop("disabled",!1)})}),$("#step_language_lang").change(function(){var a=$("#step_language_lang option:selected");if($("#step_language").html("<span class='answer'>"+a.text()+"</span>"),$("#step_language span").attr("chosen",a.attr("i18n")),a.text()==translate("other")){if(!$("#checkupdate").get(0).firstChild)return void log("returning, no first child found",$(this).attr("i18n"));if(!$("#checkupdate").get(0).lastChild)return void log("returning, no last child found",$(this).attr("i18n"));var b=translate("nodefaultfilter1"),c=splitMessageWithReplacementText(b);return $("#checkupdate").get(0).firstChild.nodeValue=c.anchorPrefixText,void($("#checkupdate").get(0).lastChild.nodeValue=c.anchorPostfixText)}for(var e=a.attr("value").split(";"),f=0;f<e.length-1;f++)if(unsubscribedDefaultFilters[e[f]])return void $("#checkupdate").text(translate("retryaftersubscribe",[translate("filter"+e[f])]));var g=e[e.length-1];contact=d(g),$("#step_firefox_DIV").fadeIn().css("display","block"),$("#checkinfirefox1").html(translate("checkinfirefox_1")),$("#checkinfirefox2").html(translate("checkinfirefox_2")),$("#checkinfirefox").html(translate("checkinfirefoxtitle"))}),$("#step_firefox_yes").click(function(){if(recordMessage("filterlistproblem"),$("#step_firefox").html("<span class='answer' chosen='yes'>"+translate("yes")+"</span>"),/^mailto\:/.test(contact)&&(contact=contact.replace(" at ","@")),!$("#checkupdate").get(0).firstChild)return void log("returning, no first child found",$(this).attr("i18n"));if(!$("#checkupdate").get(0).lastChild)return void log("returning, no last child found",$(this).attr("i18n"));var a=translate("reportfilterlistproblem"),b=splitMessageWithReplacementText(a);$("#checkupdate").get(0).firstChild.nodeValue=b.anchorPrefixText,$("#checkupdate").get(0).lastChild.nodeValue=b.anchorPostfixText,$("#checkupdatelink").prop("href",contact),$("#checkupdatelink").text(contact.replace(/^mailto\:/,"")),$("#privacy").show()}),$("#step_firefox_no").click(function(){$("#step_firefox").html("<span class='answer' chosen='no'>"+translate("no")+"</span>"),SAFARI?$("#step_flash_DIV").fadeIn().css("display","block"):(recordMessage("adblockissue"),$("#step_report_DIV").fadeIn().css("display","block"),debugInfo&&$("#debug-info").val(createReadableReport({debug:debugInfo})))}),$("#step_firefox_wontcheck").click(function(){recordMessage("firefox_wontcheck"),SAFARI?$("#checkupdate").text(translate("fixityourself")):$("#step_firefox_yes").click(),$("#step_firefox").html("<span class='answer' chosen='wont_check'>"+translate("refusetocheck")+"</span>")}),$("#step_flash_yes").click(function(){recordMessage("flash_yes"),$("#step_flash").html("<span class='answer' chosen='yes'>"+translate("yes")+"</span>"),$("#checkupdate").text(translate("cantblockflash"))}),$("#step_flash_no").click(function(){recordMessage("flash_no"),$("#step_flash").html("<span class='answer' chosen='no'>"+translate("no")+"</span>"),$("#step_report_DIV").fadeIn().css("display","block"),debugInfo&&$("#debug-info").val(createReadableReport({debug:debugInfo}))}),$("#step_report_submit").click(function(){recordMessage("sendReport"),sendReport()})}),backgroundPage.getDebugInfo(function(a){debugInfo={},debugInfo.filter_lists=JSON.stringify(a.subscriptions,null,"\t"),debugInfo.other_info=JSON.stringify(a.other_info,null,"\t"),debugInfo.custom_filters=a.custom_filters,debugInfo.settings=JSON.stringify(a.settings,null,"\t"),debugInfo.language=determineUserLanguage()});function sendReport(){var a=Math.min,b=$("#step_report_name"),c=$("#step_report_email"),d=$("#step_report_location"),e=$("#step_report_filter"),f=0;if($("#screen_capture_file_label").css("color","black"),c.removeClass("inputError"),b.removeClass("inputError"),$("#step_response_error").parent().fadeOut(),$("#step_response_success").parent().fadeOut(),$("#adreport_missing_info").hide(),$("#adreport_missing_screenshot").hide(),""===b.val()&&(f++,b.addClass("inputError"),$("#adreport_missing_info").show()),(""===c.val()||-1===c.val().search(/^.+@.+\..+$/))&&(f++,c.addClass("inputError"),$("#adreport_missing_info").show()),0===$("#screen_capture_file")[0].files.length&&($("#adreport_missing_screenshot").show(),f++,$("#screen_capture_file_label").css("color","#f00")),f)return void $("html, body").animate({scrollTop:$("#adreport_missing_info").offset().top},2e3);var g={title:"Ad Report",name:b.val(),email:c.val(),location:d.val(),filter:e.val(),debug:debugInfo,url:""},h="";options.url&&(h=parseUri(options.url).hostname,g.title=g.title+": "+h,g.url=options.url);for(var j=[],k=$("span[class=\"answer\"]"),l=$("div[class=\"section\"]:visible"),m=a(k.length,l.length),n=0;n<m;n++)j.push(n+1+"."+l[n].id+": "+k[n].getAttribute("chosen"));g.answers=j.join("\n");var o=function(){chrome&&chrome.permissions&&chrome.permissions.request?chrome.permissions.request({permissions:["management"]},function(a){return a?void chrome.management.getAll(function(a){for(var b=[],c=0;c<a.length;c++)b.push("Number "+(c+1)),b.push("  name: "+a[c].name),b.push("  id: "+a[c].id),b.push("  version: "+a[c].version),b.push("  enabled: "+a[c].enabled),b.push("  type: "+a[c].type),b.push("");return g.extensions=b.join("\n"),chrome.permissions.remove({permissions:["management"]},function(){}),void p()}):(g.extensions="Permission not granted",void p())}):(g.extensions="Extension information not avaiable",p())},p=function(){var a=new FormData;a.append("ad_report",JSON.stringify(g)),0<$("#screen_capture_file")[0].files.length&&a.append("screencapturefile",$("#screen_capture_file")[0].files[0]),$("#debug-info").val(createReadableReport(g))};if(chrome&&chrome.tabs&&chrome.tabs.detectLanguage){var q=-1;try{q=parseInt(tabId)}catch(a){return g.language="unknown",void o()}chrome.tabs.detectLanguage(q,function(a){a&&(g.language=a),o()})}else g.language="unknown",o()}var createReadableReport=function(a){var b=[];return a.location&&(b.push("* Location of ad *"),b.push(a.location)),a.expect&&(b.push(""),b.push("* Working Filter? *"),b.push(a.expect)),b.push(""),content=[],content.push("* Debug Info *"),content.push(""),a.debug&&a.debug.filter_lists&&(content.push("=== Filter Lists ==="),content.push(a.debug.filter_lists)),content.push(""),a.custom_filters&&(content.push("=== Custom Filters ==="),content.push(a.debug.custom_filters),content.push("")),a.exclude_filters&&(content.push("=== Exclude Filters ==="),content.push(a.debug.exclude_filters),content.push("")),a.debug&&a.debug.settings&&(content.push("=== Settings ==="),content.push(a.debug.settings)),content.push(""),a.debug&&a.debug.other_info&&(content.push("=== Other Info ==="),content.push(a.debug.other_info)),b.push(content.join("\n")),b.push(""),b.join("\n")},prepareManualReport=function(a,b,c,d){var e=[];e.push(createReadableReport(a)),b&&e.push("Status: "+b),c&&e.push("HTTP error code: "+c),d&&e.push("Server error information: "+JSON.stringify(d)),$("#manual_submission").val(e.join("\n"))};$("input, select").change(function(a){a.preventDefault(),$("html, body").animate({scrollTop:15e3},50)});