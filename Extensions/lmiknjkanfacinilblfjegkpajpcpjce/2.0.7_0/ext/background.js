"use strict";(function(){function a(a){return b=>{let c=(d,e)=>{d==b.id&&"complete"==e.status&&(chrome.tabs.onUpdated.removeListener(c),a(new h(b)))};chrome.tabs.onUpdated.addListener(c)}}function b(a,b){let c=n.get(a);c||(c=new Map,n.set(a,c));let d=c.get(b);return d||(d={},c.set(b,d)),d}function c(a,c,d,e){if(0==a){let a=new h({id:c,url:d});ext._removeFromAllPageMaps(c),chrome.tabs.get(c,()=>{chrome.runtime.lastError&&ext.pages.onLoading._dispatch(a)})}let f=b(c,a);f.url=new URL(d);let g=n.get(c).get(e);g&&(f.parent=g)}function d(a){ext.pages.onRemoved._dispatch(a),ext._removeFromAllPageMaps(a),n.delete(a)}function e(){0<o&&(chrome.webNavigation.onBeforeNavigate.removeListener(e),chrome.webRequest.handlerBehaviorChanged(),o--,setTimeout(()=>{o++},6e5))}let f=new Set,g=ext.PageMap=function(){this._map=new Map};g.prototype={_delete(a){this._map.delete(a),0==this._map.size&&f.delete(this)},keys(){return Array.from(this._map.keys()).map(ext.getPage)},get(a){return this._map.get(a.id)},set(a,b){this._map.set(a.id,b),f.add(this)},has(a){return this._map.has(a.id)},clear(){this._map.clear(),f.delete(this)},delete(a){this._delete(a.id)}},ext._removeFromAllPageMaps=a=>{for(let b of f)b._delete(a)};let h=ext.Page=function(a){this.id=a.id,this._url=a.url&&new URL(a.url),this.browserAction=new i(a.id),this.contextMenus=new m(this)};h.prototype={get url(){if(this._url)return this._url;let a=n.get(this.id);if(a){let b=a.get(0);if(b)return b.url}},sendMessage(a,b){chrome.tabs.sendMessage(this.id,a,b)}},ext.getPage=a=>new h({id:parseInt(a,10)}),ext.pages={open(b,c){chrome.tabs.create({url:b},c&&a(c))},query(a,b){let c={};for(let d in a)"active"==d||"lastFocusedWindow"===d?c[d]=a[d]:void 0;chrome.tabs.query(c,a=>{b(a.map(a=>new h(a)))})},onLoading:new ext._EventTarget,onActivated:new ext._EventTarget,onRemoved:new ext._EventTarget},chrome.tabs.onUpdated.addListener((a,b,c)=>{"loading"==b.status&&ext.pages.onLoading._dispatch(new h(c))}),chrome.webRequest.onHeadersReceived.addListener(a=>{if(204!=a.statusCode&&205!=a.statusCode){for(let b of a.responseHeaders){let c=b.name.toLowerCase();if("location"==c&&b.value&&(301==a.statusCode||302==a.statusCode||303==a.statusCode||307==a.statusCode||308==a.statusCode))return;if("content-disposition"==c){let a=b.value.split(";")[0].replace(/[ \t]+$/,"");if("inline"!=a.toLowerCase()&&/^[\x21-\x7E]+$/.test(a)&&!/[()<>@,;:\\"/[\]?={}]/.test(a))return}if("content-type"==c){let a=b.value.split(/[ \t;(]/)[0].toLowerCase();if(a.includes("/")&&"*/*"!=a&&"application/unknown"!=a&&"unknown/unknown"!=a&&"text/html"!=a&&"text/xml"!=a&&"application/xml"!=a&&"application/xhtml+xml"!=a&&"image/svg+xml"!=a)return}}c(a.frameId,a.tabId,a.url,a.parentFrameId)}},{types:["main_frame","sub_frame"],urls:["http://*/*","https://*/*"]},["responseHeaders"]),chrome.webNavigation.onBeforeNavigate.addListener(a=>{let b=new URL(a.url);"http:"!=b.protocol&&"https:"!=b.protocol&&c(a.frameId,a.tabId,a.url,a.parentFrameId)}),chrome.tabs.onReplaced.addListener((a,b)=>{d(b)}),chrome.tabs.onRemoved.addListener(d),chrome.tabs.onActivated.addListener(a=>{ext.pages.onActivated._dispatch(new h({id:a.tabId}))}),"getPopup"in chrome.browserAction||chrome.browserAction.onClicked.addListener(()=>{ext.showOptions()});let i=function(a){this._tabId=a,this._changes=null};i.prototype={_applyChanges(){"iconPath"in this._changes&&"setIcon"in chrome.browserAction&&chrome.browserAction.setIcon({tabId:this._tabId,path:{16:this._changes.iconPath.replace("$size","16"),19:this._changes.iconPath.replace("$size","19"),20:this._changes.iconPath.replace("$size","20"),32:this._changes.iconPath.replace("$size","32"),38:this._changes.iconPath.replace("$size","38"),40:this._changes.iconPath.replace("$size","40")}}),"badgeText"in this._changes&&"setBadgeText"in chrome.browserAction&&chrome.browserAction.setBadgeText({tabId:this._tabId,text:this._changes.badgeText}),"badgeColor"in this._changes&&"setBadgeBackgroundColor"in chrome.browserAction&&chrome.browserAction.setBadgeBackgroundColor({tabId:this._tabId,color:this._changes.badgeColor}),this._changes=null},_queueChanges(){chrome.tabs.get(this._tabId,()=>{if(chrome.runtime.lastError){let a=b=>{b==this._tabId&&(chrome.tabs.onReplaced.removeListener(a),this._applyChanges())};chrome.tabs.onReplaced.addListener(a)}else this._applyChanges()})},_addChange(a,b){this._changes||(this._changes={},this._queueChanges()),this._changes[a]=b},setIcon(a){this._addChange("iconPath",a)},setBadge(a){a?("number"in a&&this._addChange("badgeText",a.number.toString()),"color"in a&&this._addChange("badgeColor",a.color)):this._addChange("badgeText","")}};let j=new ext.PageMap,k=!1,l=()=>{!("contextMenus"in chrome)||k||(k=!0,chrome.tabs.query({active:!0,lastFocusedWindow:!0},a=>{chrome.contextMenus.removeAll(()=>{if(k=!1,0!=a.length){let b=j.get({id:a[0].id});b&&b.forEach(a=>{chrome.contextMenus.create({title:a.title,contexts:a.contexts,onclick(b,c){a.onclick(new h(c))}})})}})}))},m=function(a){this._page=a};m.prototype={create(a){let b=j.get(this._page);b||j.set(this._page,b=[]),b.push(a),l()},remove(a){let b=j.get(this._page);if(b){let c=b.indexOf(a);-1!=c&&(b.splice(c,1),l())}}},chrome.tabs.onActivated.addListener(l),"windows"in chrome&&chrome.windows.onFocusChanged.addListener(a=>{a!=chrome.windows.WINDOW_ID_NONE&&l()});let n=new Map;ext.getFrame=(a,b)=>{let c=n.get(a);return c&&c.get(b)};let o=chrome.webRequest.MAX_HANDLER_BEHAVIOR_CHANGED_CALLS_PER_10_MINUTES;ext.webRequest={onBeforeRequest:new ext._EventTarget,handlerBehaviorChanged(){let{onBeforeNavigate:a}=chrome.webNavigation;a.hasListener(e)||a.addListener(e)}},chrome.tabs.query({},a=>{a.forEach(a=>{chrome.webNavigation.getAllFrames({tabId:a.id},b=>{if(b&&0<b.length){let c=new Map;n.set(a.id,c);for(let a of b){let b={url:new URL(a.url)};c.set(a.frameId,b),-1!=a.parentFrameId&&(b.parent=c.get(a.parentFrameId))}}})})}),chrome.webRequest.onBeforeRequest.addListener(a=>{if("main_frame"==a.type)return;let b=new URL(a.url);if("http:"!=b.protocol&&"https:"!=b.protocol&&"ws:"!=b.protocol&&"wss:"!=b.protocol)return;let{frameId:c,type:d}=a;"sub_frame"==d&&(c=a.parentFrameId);let e=null,f=null;if(-1!=a.tabId&&(e=ext.getFrame(a.tabId,c),f=new h({id:a.tabId})),ext.webRequest.onBeforeRequest._dispatch(b,d,f,e).includes(!1))return{cancel:!0}},{urls:["<all_urls>"]},["blocking"]),chrome.runtime.onMessage.addListener((a,b,c)=>{let d={};return"tab"in b&&(d.page=new h(b.tab),d.frame={id:b.frameId,url:b.url?new URL(b.url):null,get parent(){let a=n.get(b.tab.id);if(!a)return null;let c=a.get(b.frameId);return c?c.parent||null:a.get(0)||null}}),ext.onMessage._dispatch(a,d,c).includes(!0)}),ext.storage={get(a,b){chrome.storage.local.get(a,b)},set(a,b,c){let d={};d[a]=b,chrome.storage.local.set(d,c)},remove(a,b){chrome.storage.local.remove(a,b)},onChanged:chrome.storage.onChanged},ext.showOptions=b=>{let c=require("info");if("openOptionsPage"in chrome.runtime&&("fennec"!=c.application||57<=parseInt(c.applicationVersion,10)))b?chrome.runtime.openOptionsPage(()=>{chrome.runtime.lastError||chrome.tabs.query({active:!0,lastFocusedWindow:!0},c=>{0<c.length&&("complete"==c[0].status?b(new h(c[0])):a(b)(c[0]))})}):chrome.runtime.openOptionsPage();else if("windows"in chrome){let a=ext.getURL("options.html");chrome.tabs.query({},c=>{let d=c.find(b=>b.url==a);d?(chrome.windows.update(d.windowId,{focused:!0}),chrome.tabs.update(d.id,{active:!0}),b&&b(new h(d))):ext.pages.open("options.html",b)})}else ext.pages.open("options.html",b)},ext.windows={create(b,c){chrome.windows.create(b,b=>{a(c)(b.tabs[0])})}}})();